---
title: "Quarterly Acquisitions Report"
author: "Noe Navarro"
date: "July 25, 2018"
output: html_document
---

```{r Library}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)

library(plyr)
library(dplyr)
library(dbplyr)

library(R2HTML)
library(CenterIS)

library(supclust)

library(jsonlite)
library(RCurl)

library(tidyr)
library(data.table)

library(rlist)

library(testthat)
library(xlsx)

library(rbenchmark)

```


##**Inputs**

```{r Entity List}

# Import Excel File ----
acq_list_final <- readxl::read_excel("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\Acq List\\Master_Acquisitions_List.xlsx", sheet = 'Master_List')
        
# Filter for Included properties (excludes remotes/abuttings) ----
acq_list_final <- 
  acq_list_final %>%
  filter(`Include?` == 'Yes')


# Extraction of profit center numbers ----      ## IMPORTED FROM ENTITY LIST RMD!!!! ##
  acq_pc <-
    acq_list_final %>% 
    select(Profit_Center)

  # Removal of NA values ----
    acq_pc <-  
      acq_pc[!is.na(acq_pc), ] 
   
    # Check for duplicate profit centers within completed acquisitions data frame ----
      acq_pc_check <- 
        acq_pc %>%
          group_by(Profit_Center) %>%
          mutate(Count = 1) %>%
          summarise(Total = sum(Count)) %>%
          filter(Total > 1)
      
      # Kill switch if duplicate profit centers are detected; Check 1 ----
        if(length(acq_pc_check$Profit_Center) != 0) {
          print("Duplicate Profit Centers Detected! Process will now stop")
          stop()
        }        
  
```

```{r Function Updates}

max_is_month
current_month
occ_compilation # Update "Date" for Unit Mix Filter 

```

```{r Quarterly Group Updates}

# The following variables will need to be updated every quarter ----
Grp_Num <- c(1:16)
Group <- c("FY15 Q4", 
              "FY16 Q1", 
              "FY16 Q2",
              "FY16 Q3",
              "FY16 Q4",
              "FY17 Q1",
              "FY17 Q2",
              "FY17 Q3",
              "FY17 Q4",
              "FY18 Q1",
              "FY18 Q2", 
              "FY18 Q3", 
              "FY18 Q4",
              "FY19 Q1",
              "FY19 Q2",
              "FY19 Q3")

```


## **SQL Connections**
---

```{r SQL Connections}

# Finaccounting connection ----
con.FinAccounting = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FinAccounting",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Finanalysis connection ----
con.FinAnalysis = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FINANALYSIS",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Storage connection ----
  con.Storage = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "Storage",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# MEntity connection ----      
  con.mentity = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "MEntity",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Graph MEntity and SAP number combination
  Graph.Entity.Info.Sql <- dplyr::tbl(con.FinAnalysis, "GRAPH_ENTITY_INFO")
    Graph.Entity.Info.Local <- collect(Graph.Entity.Info.Sql)
      colnames(Graph.Entity.Info.Local)[21] <- 'Profit_Center'
        
```

```{r SQL Table Imports}

# Finaccounting Tables ----
  IS.Trend.Cash = dplyr::tbl(con.FinAccounting, "IS_TREND_CASH")
  SAP.Hierarchy = dplyr::tbl(con.FinAccounting, "SAP_Cost_Center_Hierarchy") 
  sap_uhi_group <- dplyr::tbl(con.FinAccounting, "SAP_IS_UHAL_GROUP")

# MEntity Tables ----
  SAP_Info = dplyr::tbl(con.mentity, "MENTITY_SAP")
    SAP.DB = collect(SAP_Info)
      SAP.DB %>% summarise(n_distinct(MEntity))

# Occupancy Table ----  
  wss_data <- dplyr::tbl(con.Storage, "WSS_UnitMixUHI_Monthly_Archive")  
  
      
    
# Collect SAP Hierarchy ----
  SAP.Hierarchy <- collect(SAP.Hierarchy)
  colnames(SAP.Hierarchy)[12] <- "Profit_Center"
  
```

```{r Chart of Accounts Import}

# SAP Accounts ----
accounts <-
  read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\income_statement_accounts.csv")


colnames(accounts)[1] <- "SAP_number"


```


## **Functions**
---

```{r Date Difference}

monnb <- function(d) { lt <- as.POSIXlt(as.Date(d, origin = "1900-01-01")); lt$year*12 + lt$mon } 
mondf <- function(d1, d2) { monnb(d2) - monnb(d1) }

```

```{r Line Item Function}

# Step by Step TEst of Line Item Function ----
line_item_function <- function(x, df){
     
    # x = list of line items 
    # current_month = Max IS Month in full date format 
  
     require(dplyr)
     require(purrr)
     
     # Date Range for missing line items ----
     min_is_month <- min(df$MONTH)
     max_is_month <- as.Date('2018-12-01')
     
     # Line Item IS compilation ----
     line_item_is <- 
       df %>%
       filter(`Line Item` == x[1]) %>%
       group_by(MONTH, `Line Item`) %>%
       summarize(Amount = sum(Amount))
     
     # Calculate date difference ----
     date_diff <- 
       mondf(min_is_month, min(line_item_is$MONTH))
     
     
    # Check for date_diff NA ----
    if(is.na(date_diff) == TRUE){  
     
    full_date <- 
       seq.Date(from = min_is_month, to = max_is_month, by = "month")
     
     full_fill <- 
       as.data.frame(full_date)
     
     # Rename to Month ----
     colnames(full_fill) <- "MONTH"
     
     full_fill$`Line Item` <- as.character(paste(x[1]))
     full_fill$Amount = 0
     
     line_item_is <- as.tbl(full_fill)
     
     # Filter for max date
     line_item_is <-
        line_item_is %>%
        filter(MONTH <= '2018-12-01')
     
     
    } else if(date_diff > 0){
     
     
  # Date Difference Logical Flow. 
  # if Date > 0; min Month is lower than Line Item Minimum. We will need to fill in the remaining dates ---- 

     date_seq <-
     seq.Date(from = min_is_month, to = min(line_item_is$MONTH) - 1, by = "month")
   
     fill_df <-
     as.data.frame(date_seq)
   
    # Rename column ----
     colnames(fill_df) <- "MONTH"
     
     fill_df$`Line Item` <- paste(x[1])
     fill_df$Amount = 0
   
    # Bind Dataframes ----
     line_item_is <-
       bind_rows(fill_df, line_item_is)
     
     # tbl conversion ----
     line_item_is <- as.tbl(line_item_is)
     
      # Filter for max date ----
      line_item_is <-
        line_item_is %>%
        filter(MONTH <= '2018-12-01')
     
    } else if(date_diff == 0){
    
      line_item_is <- as.tbl(line_item_is)
      
      # Filter for max date ----
      line_item_is <-
        line_item_is %>%
        filter(MONTH <= '2018-12-01')
      
    }
  
     return(line_item_is)
     
}


```

```{r Aggregate Income Statement}

income_statment_compilation <- function(x, accounts){
  
  # x = list of profit centers 
  # accounts = sap accounts to be used 
  
  require(dplyr)
  require(lazyeval)
  require(purrr)
  require(reshape2)
  
  # ------------------------------------------------
  # Step 1: Filter for Profit Center & Account List 
  # ------------------------------------------------
  
  # Filter SQL Database  & Collect ----
  db <-
  sap_uhi_group %>% 
    filter(`PROFIT CENTER` %in% x & 
             ACCOUNT %in% accounts &
             `Fiscal Year` >= 2015)
  
    db <- collect(db)
    
    db$`PROFIT CENTER` <- as.character(db$`PROFIT CENTER`)
    db$ACCOUNT <- as.character(db$ACCOUNT)
  
# Reformat database ----
colnames(db)[11] <- 4
colnames(db)[12] <- 5
colnames(db)[13] <- 6
colnames(db)[14] <- 7
colnames(db)[15] <- 8
colnames(db)[16] <- 9
colnames(db)[17] <- 10
colnames(db)[18] <- 11
colnames(db)[19] <- 12
colnames(db)[20] <- 1
colnames(db)[21] <- 2
colnames(db)[22] <- 3
  

  # Eliminate Unecessary columns ----
  db <-
    db[ , -c(1,3,4,5,9,10,23,24,26,27)]

    db <- 
      melt(db, id = c('PROFIT CENTER', "MEntity", "ACCOUNT", "DESCRIPTION", "Fiscal Year"))
    
# Rename columns ----
colnames(db)[3] <-  "SAP_number"   
colnames(db)[7] <- "Amount"
colnames(db)[6] <- "Cal_Month"

  db$Cal_Month <- as.character(db$Cal_Month)
  db$Cal_Month <- as.numeric(db$Cal_Month)
  db$SAP_number <- as.character(db$SAP_number)

# Creation of Calendar "MONTH" column ----
db$Cal_Year = " "

for (i in 1:length(db$`PROFIT CENTER`)){
  
  if(db$Cal_Month[i] >= 4 & db$Cal_Month[i] <= 12){
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] - 1
    
  } else {
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] 
    
  }
  
}

 # MONTH column update ----  
 db$MONTH <- 
   paste(db$Cal_Year, db$Cal_Month, 1, sep = "-")
  
   db$MONTH <- as.Date(db$MONTH, format = "%Y-%m-%d") 
   
   
   # Convert Chart of Accounts "SAP_Number" into character ----
   chart_of_accounts$SAP_number <- as.character(chart_of_accounts$SAP_number)
   
    
  # Compilation of income statement ----
  db <-
    left_join(db, chart_of_accounts[ ,c(1,4)], by = "SAP_number")
   
    colnames(db)[10] <- "Line Item"
    
    

#------------------------------------------
# Step 2: Individual Line Item Compilation
# -----------------------------------------
  
  # This step will ensure all Line Items and Months are represented within the income statement for NOI calculation. If they are not, dedault value = 0
  line_item <- 
    lapply(line_item_list, line_item_function, df = db)

  # Collapse List of Data Frames into 1 ----
  aggregate_df <-
    ldply(line_item, as.data.frame)
    
    
  # Reversal of Line Item Signs ----
    for(i in 1:length(aggregate_df$`Line Item`)){
    
    if(aggregate_df$`Line Item`[i] == 'STORAGE INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'SALES'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'MISCELLANEOUS INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'U-BOX'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
    
      
    } else if(aggregate_df$`Line Item`[i] == 'U-MOVE NET COMMISSION'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'INTERCOMPANY LEASE'){  
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1 
      
    } else if(aggregate_df$`Line Item`[i] == 'THIRD PARTY LEASE '){  
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1 
    
    }
      
    }
    

# -------------------------
# Step 3: Horizontal Format
# -------------------------
    
 # Convert to horizontal format ----
 aggregate_df <- 
     tidyr::spread(aggregate_df, `Line Item`, Amount)
 
   # Replace NA with 0 ----
   aggregate_df[is.na(aggregate_df)] <- 0          
  
    # Calculate NOI ----
  aggregate_df <-  
   aggregate_df %>%
      mutate(
        NET_SALES = `SALES` - `COST OF SALES`,
        
        REVENUE = 
               `STORAGE INCOME` +
                NET_SALES +   
                `MISCELLANEOUS INCOME` +   
                `U-BOX` +
                `U-MOVE NET COMMISSION` +
                `THIRD PARTY LEASE `, 
             
             TOTAL_OP_EXPENSE = 
               `PERSONNEL` +
               `REPAIRS AND MAINTENANCE/GENERAL` +
               `UTILITIES` +
               `TELEPHONE` +
               `ADVERTISING` +
               `SUPPLIES` +
               `RENT-EQUIPMENT/LAND AND BLDGS` +
               `LIABILITY INSURANCE` + 
               `PROPERTY TAX` +
               `BAD DEBT EXPENSE` +
               `OTHER OPERATING EXPENSE`,
               
        NOI =
               `STORAGE INCOME` +
               `SALES` -
               `COST OF SALES` +
               `MISCELLANEOUS INCOME` +
               `U-BOX` +
               `U-MOVE NET COMMISSION` +
               `THIRD PARTY LEASE ` -
               `PERSONNEL` -
               `REPAIRS AND MAINTENANCE/GENERAL` -
               `UTILITIES` -
               `TELEPHONE` -
               `ADVERTISING` -
               `SUPPLIES` -
               `RENT-EQUIPMENT/LAND AND BLDGS` -
               `LIABILITY INSURANCE` - 
               `PROPERTY TAX` -
               `BAD DEBT EXPENSE` -
               `OTHER OPERATING EXPENSE`
               )
    
  # Rename for ease of function ----
  db <- aggregate_df  
    
    # Trim for NOI != 0 (eliminate blank rows from income statement) ----
    db <-
      db %>% 
      filter(NOI != 0)
    
  # Melt back to vertical format ----
 db <-
   melt(db, id = c("MONTH"))
    
    
# Import Fiscal Year Columns ----
  db$FY = " "
  db$FM = " "
  db$Quarter = " "
   
  
  for (i in 1:length(db$FY)){

    if(db$MONTH[i] >= '2015/1/1' & db$MONTH[i] <= '2015/3/1'){

      db$FY[i] = 2015
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2015/4/1' & db$MONTH[i] <= '2015/6/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2015/7/1' & db$MONTH[i] <= '2015/9/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2015/10/1' & db$MONTH[i] <= '2015/12/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2016/1/1' & db$MONTH[i] <= '2016/3/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2016/4/1' & db$MONTH[i] <= '2016/6/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2016/7/1' & db$MONTH[i] <= '2016/9/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2016/10/1' & db$MONTH[i] <= '2016/12/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2017/1/1' & db$MONTH[i] <= '2017/3/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2017/4/1' & db$MONTH[i] <= '2017/6/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2017/7/1' & db$MONTH[i] <= '2017/9/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2017/10/1' & db$MONTH[i] <= '2017/12/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2018/1/1' & db$MONTH[i] <= '2018/3/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2018/4/1' & db$MONTH[i] <= '2018/6/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2018/7/1' & db$MONTH[i] <= '2018/9/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2018/10/1' & db$MONTH[i] <= '2018/12/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 3
    
    } else if (db$MONTH[i] >= '2019/1/1' & db$MONTH[i] <= '2019/3/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 4
    }
  } 
  
  
   # Addition of Month Column ----
   db$Month = " "

  for (i in 1:length(db$Month)){
    db$Month[i] = format(db$MONTH[i], "%b")
  }
  for (i in 1:length(db$FM)){
    if(month(db$MONTH[i]) >= 4 & month(db$MONTH[i]) <= 12){
      db$FM[i] = month(db$MONTH[i]) - 3
    } else if (month(db$MONTH[i]) == 1) {
      db$FM[i] = 10
    } else if (month(db$MONTH[i]) == 2) {
      db$FM[i] = 11
    } else if (month(db$MONTH[i]) == 3){
      db$FM[i] = 12
    }
  }
  
  # Rename Columns ----
  colnames(db) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month") 
    
  return(db)

}


```


```{r Individual Income Statement}

income_statment_compilation_append <- function(x, accounts){
  
  # x = list of profit centers 
  # accounts = sap accounts to be used 
  
  require(dplyr)
  require(lazyeval)
  require(purrr)
  require(reshape2)
  
  # ------------------------------------------------
  # Step 1: Filter for Profit Center & Account List 
  # ------------------------------------------------
  
  # Filter SQL Database  & Collect ----
  db <-
  sap_uhi_group %>% 
    filter(`PROFIT CENTER` %in% x[["Profit_Center"]] & 
             ACCOUNT %in% accounts &
             `Fiscal Year` >= 2015)
  
    db <- collect(db)
    
    db$`PROFIT CENTER` <- as.character(db$`PROFIT CENTER`)
    db$ACCOUNT <- as.character(db$ACCOUNT)
  
    
# Reformat database ----
colnames(db)[11] <- 4
colnames(db)[12] <- 5
colnames(db)[13] <- 6
colnames(db)[14] <- 7
colnames(db)[15] <- 8
colnames(db)[16] <- 9
colnames(db)[17] <- 10
colnames(db)[18] <- 11
colnames(db)[19] <- 12
colnames(db)[20] <- 1
colnames(db)[21] <- 2
colnames(db)[22] <- 3
  

  # Eliminate Unecessary columns ----
  db <-
    db[ , -c(1,3,4,5,9,10,23,24,26,27)]

    db <- 
      melt(db, id = c('PROFIT CENTER', "MEntity", "ACCOUNT", "DESCRIPTION", "Fiscal Year"))
    
# Rename columns ----
colnames(db)[3] <-  "SAP_number"   
colnames(db)[7] <- "Amount"
colnames(db)[6] <- "Cal_Month"

  db$Cal_Month <- as.character(db$Cal_Month)
  db$Cal_Month <- as.numeric(db$Cal_Month)
  db$SAP_number <- as.character(db$SAP_number)

# Creation of Calendar "MONTH" column ----
db$Cal_Year = " "

for (i in 1:length(db$`PROFIT CENTER`)){
  
  if(db$Cal_Month[i] >= 4 & db$Cal_Month[i] <= 12){
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] - 1
    
  } else {
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] 
    
  }
  
}

 # MONTH column update ----  
 db$MONTH <- 
   paste(db$Cal_Year, db$Cal_Month, 1, sep = "-")
  
   db$MONTH <- as.Date(db$MONTH, format = "%Y-%m-%d") 
   
   
   # Convert Chart of Accounts "SAP_Number" into character ----
   chart_of_accounts$SAP_number <- as.character(chart_of_accounts$SAP_number)
   
    
  # Compilation of income statement ----
  db <-
    left_join(db, chart_of_accounts[ ,c(1,4)], by = "SAP_number")
   
    colnames(db)[10] <- "Line Item"
    
    

#------------------------------------------
# Step 2: Individual Line Item Compilation
# -----------------------------------------
  
  # This step will ensure all Line Items and Months are represented within the income statement for NOI calculation. If they are not, dedault value = 0
  line_item <- 
    lapply(line_item_list, line_item_function, df = db)

  # Collapse List of Data Frames into 1 ----
  aggregate_df <-
    ldply(line_item, as.data.frame)
    
    
  # Reversal of Line Item Signs ----
    for(i in 1:length(aggregate_df$`Line Item`)){
    
    if(aggregate_df$`Line Item`[i] == 'STORAGE INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'SALES'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'MISCELLANEOUS INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'U-BOX'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
    
      
    } else if(aggregate_df$`Line Item`[i] == 'U-MOVE NET COMMISSION'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'INTERCOMPANY LEASE'){  
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1 
      
    } else if(aggregate_df$`Line Item`[i] == 'THIRD PARTY LEASE '){  
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1 
    
  }
    } 

# -------------------------
# Step 3: Horizontal Format
# -------------------------
    
 # Convert to horizontal format ----
 aggregate_df <- 
     tidyr::spread(aggregate_df, `Line Item`, Amount)
 
   # Replace NA with 0 ----
   aggregate_df[is.na(aggregate_df)] <- 0          
  
   # Calculate NOI ----
  aggregate_df <-  
   aggregate_df %>%
      mutate(
        
        NET_SALES = `SALES` - `COST OF SALES`,
        
        REVENUE = 
               `STORAGE INCOME` +
                NET_SALES +   
                `MISCELLANEOUS INCOME` +   
                `U-BOX` +
                `U-MOVE NET COMMISSION` +
                `THIRD PARTY LEASE `, 
             
             TOTAL_OP_EXPENSE = 
               `PERSONNEL` +
               `REPAIRS AND MAINTENANCE/GENERAL` +
               `UTILITIES` +
               `TELEPHONE` +
               `ADVERTISING` +
               `SUPPLIES` +
               `RENT-EQUIPMENT/LAND AND BLDGS` +
               `LIABILITY INSURANCE` + 
               `PROPERTY TAX` +
               `BAD DEBT EXPENSE` +
               `OTHER OPERATING EXPENSE`,
               
        NOI =
               `STORAGE INCOME` +
               `SALES` -
               `COST OF SALES` +
               `MISCELLANEOUS INCOME` +
               `U-BOX` +
               `U-MOVE NET COMMISSION` +
               `THIRD PARTY LEASE ` -
               `PERSONNEL` -
               `REPAIRS AND MAINTENANCE/GENERAL` -
               `UTILITIES` -
               `TELEPHONE` -
               `ADVERTISING` -
               `SUPPLIES` -
               `RENT-EQUIPMENT/LAND AND BLDGS` -
               `LIABILITY INSURANCE` - 
               `PROPERTY TAX` -
               `BAD DEBT EXPENSE` -
               `OTHER OPERATING EXPENSE`
               )
    
    
  # Rename for ease of function ----
  db <- aggregate_df  
    
    # Trim for NOI != 0 (eliminate blank rows from income statement) ----
    db <-
      db %>% 
      filter(NOI != 0)
    
  # Melt back to vertical format ----
 db <-
   melt(db, id = c("MONTH"))
    
    
# Import Fiscal Year Columns ----
  db$FY = " "
  db$FM = " "
  db$Quarter = " "
   
  
  for (i in 1:length(db$FY)){

    if(db$MONTH[i] >= '2014/4/1' & db$MONTH[i] <= '2014/6/1'){
      
      db$FY[i] = 2015
      db$Quarter[i] = 1

    } else if(db$MONTH[i] >= '2014/7/1' & db$MONTH[i] <= '2014/9/1'){
      
      db$FY[i] = 2015
      db$Quarter[i] = 2
      
    } else if (db$MONTH[i] >= '2014/10/1' & db$MONTH[i] <= '2014/12/1'){
      
      db$FY[i] = 2015
      db$Quarter[i] = 3
      
    } else if (db$MONTH[i] >= '2015/1/1' & db$MONTH[i] <= '2015/3/1'){

      db$FY[i] = 2015
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2015/4/1' & db$MONTH[i] <= '2015/6/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2015/7/1' & db$MONTH[i] <= '2015/9/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2015/10/1' & db$MONTH[i] <= '2015/12/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2016/1/1' & db$MONTH[i] <= '2016/3/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2016/4/1' & db$MONTH[i] <= '2016/6/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2016/7/1' & db$MONTH[i] <= '2016/9/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2016/10/1' & db$MONTH[i] <= '2016/12/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2017/1/1' & db$MONTH[i] <= '2017/3/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2017/4/1' & db$MONTH[i] <= '2017/6/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2017/7/1' & db$MONTH[i] <= '2017/9/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2017/10/1' & db$MONTH[i] <= '2017/12/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2018/1/1' & db$MONTH[i] <= '2018/3/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2018/4/1' & db$MONTH[i] <= '2018/6/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2018/7/1' & db$MONTH[i] <= '2018/9/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2018/10/1' & db$MONTH[i] <= '2018/12/1'){
      
      db$FY[i] = 2019
      db$Quarter[i] = 3
      
    }
  }
  
  
   # Addition of Month Column ----
   db$Month = " "

  for (i in 1:length(db$Month)){
    db$Month[i] = format(db$MONTH[i], "%b")
  }
  for (i in 1:length(db$FM)){
    if(month(db$MONTH[i]) >= 4 & month(db$MONTH[i]) <= 12){
      db$FM[i] = month(db$MONTH[i]) - 3
    } else if (month(db$MONTH[i]) == 1) {
      db$FM[i] = 10
    } else if (month(db$MONTH[i]) == 2) {
      db$FM[i] = 11
    } else if (month(db$MONTH[i]) == 3){
      db$FM[i] = 12
    }
  }
  
  # Rename Columns ----
  colnames(db) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month") 
  
  # Center Identifier (add MEntity) ----
  db$MEntity <- x[["MEntity"]]
  
  # Income Statement Data Check ----
  if (nrow(db) > 1){
    
    IS <- db
    
    
  } else {
    
    IS <- NA
    
  }
  
  
  # Append List ----
    y <-
      append(x, list(IS))
  
  names(y)[[4]] = "Income_Statement"
  
  return(y)

}

```

```{r Minimum IS Trend Data}

month_opertation_start <- function(x) {
  
  require(dplyr)
  require(lazyeval)
  require(purrr)
  
  IS_trend <- income_statment_compilation(x, accounts = sap_accounts$SAP_number)

  min_month <- 
    IS_trend %>%
    filter(`Line Item` == 'NOI' & Value != 0)
  
    min_month <- 
      min(min_month$Date)
  
      return(min_month)

}

```

```{r Income Statement Data Check}

data_check_na <-
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = NA
  }
  return(list.vector)
}



data_check_flag <- 
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = paste("Error:", paste(x), sep = " ")
  }
  return(list.vector)
}


data_check_center <-
  function(x){
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  #vector of list
  list.vector = list()
  list.complete = list()
  
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
    
  if(nrow(b) > 0){
    list.vector[[i]] = 1
  } else {
    list.complete[[i]] = x
  }
  return(list.complete)
}


```

```{r Nested List Creation}

# Nested list creation
  nested_list_creation <-
  function(x) {
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  list.vector = list()
    i <- 1
    list.vector[[i]] <- x
    
  # Rename List ----  
  x_append <- list.vector
  names(x_append)[[1]] <- "Profit_Center"
  
  # Filter MEntity Number from Acquisitions List ----
  mentity <- 
    acq_list_final %>% 
      filter(Profit_Center %in% x_append[["Profit_Center"]]) %>%
      select(MEntity)
  
    mentity <- as.character(mentity$MEntity)
    x_append <- append(x_append, list(mentity))
    
  # Acquisition Type ----
  acq_type <-
      acq_list_final %>%
      filter(Profit_Center %in% x_append[["Profit_Center"]]) %>%
      select(`Type`)
    
    acq_type <- as.character(acq_type$`Type`)
    x_append <- append(x_append, list(acq_type))
  
  # Rename List Observations ----
  names(x_append)[[2]] <- "MEntity"
  names(x_append)[[3]] <- "Type"
  
  return(x_append)
  
}

```

```{r FY n FM Column Creation}

# This function is used to add FY/FM identifiers to the occupancy data ----
  fiscal_year_columns <- function(x){
      
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
      x$FY = " "
      x$FM = " "
      x$Quarter = " "
      
        # Fiscal Year Loop # 
            for (i in 1:length(x$FY)){
          
              if(x$MONTH[i] >= '2014/4/1' & x$MONTH[i] <= '2014/6/1'){
      
                x$FY[i] = 2015
                x$Quarter[i] = 1

              } else if(x$MONTH[i] >= '2014/7/1' & x$MONTH[i] <= '2014/9/1'){
      
                x$FY[i] = 2015
                x$Quarter[i] = 2
      
              } else if (x$MONTH[i] >= '2014/10/1' & x$MONTH[i] <= '2014/12/1'){
      
                x$FY[i] = 2015
                x$Quarter[i] = 3
                
              } else if(x$MONTH[i] >= '2015/1/1' & x$MONTH[i] <= '2015/3/31'){
                
                x$FY[i] = 2015
                x$Quarter[i] = 4
                
              } else if (x$MONTH[i] >= '2015/4/1' & x$MONTH[i] <= '2015/6/30') { 
                
                x$FY[i] = 2016
                x$Quarter[i] = 1
                
              } else if (x$MONTH[i] >= '2015/7/1' & x$MONTH[i] <= '2015/9/30') {
                
                x$FY[i] = 2016
                x$Quarter[i] = 2
                
              } else if (x$MONTH[i] >= '2015/10/1' & x$MONTH[i] <= '2015/12/31'){
               
                x$FY[i] = 2016
                x$Quarter[i] = 3 
                
              } else if (x$MONTH[i] >= '2016/1/1' & x$MONTH[i] <= '2016/3/31'){
                
                x$FY[i] = 2016
                x$Quarter[i] = 4 
                  
              } else if (x$MONTH[i] >= '2016/4/1' & x$MONTH[i] <= '2016/6/30'){
                
                x$FY[i] = 2017
                x$Quarter[i] = 1                 
                
              } else if (x$MONTH[i] >= '2016/7/1' & x$MONTH[i] <= '2016/9/30'){

                x$FY[i] = 2017
                x$Quarter[i] = 2                                 
                
              } else if (x$MONTH[i] >= '2016/10/1' & x$MONTH[i] <= '2016/12/31'){ 
                  
                x$FY[i] = 2017
                x$Quarter[i] = 3                
                
                } else if (x$MONTH[i] >= '2017/1/1' & x$MONTH[i] <= '2017/3/31'){
                  
                x$FY[i] = 2017
                x$Quarter[i] = 4   
                
                } else if (x$MONTH[i] >= '2017/4/1' & x$MONTH[i] <= '2017/6/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 1                    
                  
                } else if (x$MONTH[i] >= '2017/7/1' & x$MONTH[i] <= '2017/9/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 2                  
                  
                } else if (x$MONTH[i] >= '2017/10/1' & x$MONTH[i] <= '2017/12/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 3   
                  
                } else if (x$MONTH[i] >= '2018/1/1' & x$MONTH[i] <= '2018/3/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 4  
                  
                } else if (x$MONTH[i] >= '2018/4/1' & x$MONTH[i] <= '2018/6/30'){     
                  
                x$FY[i] = 2019
                x$Quarter[i] = 1                     
                
                } else if (x$MONTH[i] >= '2018/7/1' & x$MONTH[i] <= '2018/9/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 2                  
          
                } else if (x$MONTH[i] >= '2018/10/1' & x$MONTH[i] <= '2018/12/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 3                  
          
                } else if (x$MONTH[i] >= '2019/1/1' & x$MONTH[i] <= '2019/3/31'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 4                
              
                } else if (x$MONTH[i] >= '2019/4/1' & x$MONTH[i] <= '2019/6/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 1                
              
                } else if (x$MONTH[i] >= '2019/7/1' & x$MONTH[i] <= '2019/9/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2019/10/1' & x$MONTH[i] <= '2019/12/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2020/1/1' & x$MONTH[i] <= '2020/3/31'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2020/4/1' & x$MONTH[i] <= '2020/6/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2020/7/1' & x$MONTH[i] <= '2020/9/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2020/10/1' & x$MONTH[i] <= '2020/12/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2021/1/1' & x$MONTH[i] <= '2021/3/31'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 4
              
                } else if (x$MONTH[i] >= '2021/4/1' & x$MONTH[i] <= '2021/6/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 1
              
                } else if (x$MONTH[i] >= '2021/7/1' & x$MONTH[i] <= '2021/9/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 2
              
              
                } else if (x$MONTH[i] >= '2021/10/1' & x$MONTH[i] <= '2021/12/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2022/1/1' & x$MONTH[i] <= '2022/3/31'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2022/4/1' & x$MONTH[i] <= '2022/6/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2022/7/1' & x$MONTH[i] <= '2022/9/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 2
                
                } else if (x$MONTH[i] >= '2022/10/1' & x$MONTH[i] <= '2022/12/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2023/1/1' & x$MONTH[i] <= '2023/3/31'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2023/4/1' & x$MONTH[i] <= '2023/6/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2023/7/1' & x$MONTH[i] <= '2023/9/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2023/10/1' & x$MONTH[i] <= '2023/12/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2024/1/1' & x$MONTH[i] <= '2024/3/31'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2024/4/1' & x$MONTH[i] <= '2024/6/30'){
                  
                x$FY[i] = 2025
                x$Quarter[i] = 1
              
                }
            }
          
          # Month Loop #
            
            # Month Column #    
            x$Month = " "
            
              for (i in 1:length(x$Month)){
                x$Month[i] = format(x$MONTH[i], "%b")
              }
            
              for (i in 1:length(x$FM)){
                if(month(x$MONTH[i]) >= 4 & month(x$MONTH[i]) <= 12){
                  x$FM[i] = month(x$MONTH[i]) - 3
                } else if (month(x$MONTH[i]) == 1) {
                  x$FM[i] = 10
                } else if (month(x$MONTH[i]) == 2) {
                  x$FM[i] = 11
                } else if (month(x$MONTH[i]) == 3){
                  x$FM[i] = 12
                }
              }
      
            
        return(x)    
    }

```

```{r Omit NA from Nested List}

na.omit.list <- function(y) {
  return(y[!sapply(y, function(x) all(is.na(x)))])
}

```

```{r Property Owner Function}

Property_Owner = function (x){

  #Filter Criteria
  d = SAP.Hierarchy %>% filter(`Cost Center` == x)

  #%Create a local copy of the data frame
  
  b = collect(d)
  c = b$`Hierarchy Area`
  return(c)

  # Rare situations to be aware of
  # In some instances, the Cost center used to filter will actually return two

}

```

```{r Vector Conversion Function}

vector.conv <- function(x){
  x = as.vector(x$Profit_Center)
  x = as.character(x)
}

```

```{r Nested List Function}

nested_list_filter <- function(x, z){

 # z = character string of object to be filtered  
  
 y = x[[z]]
 
 return(y)
 
}

```

```{r NA MEntity Filter}

  na_MEntity_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(MEntity))
    
  }

```

```{r Select Unique Profit Centers - IS}

  # Select Unique Profit Center Numbers ----
    profit_center_selection <- function(x){
      
    # Library
      require("dplyr")
      require("lazyeval")
      require("purrr")
        
        # Extract profit center ----
        grp_pc = x %>% 
                   select(Profit_Center)
        
        # Isolate Unique Profit Centers ----
        grp_pc_unique = unique(grp_pc$Profit_Center)
          grp_pc_unique = as.character(grp_pc_unique)
          
        return(grp_pc_unique)
            
      }

```

```{r Import MEntity Number - Occ}

  sap2mentity <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    mentity = 
      SAP.Hierarchy %>%
        filter(`Profit_Center` %in% x[[1]]) %>%
        select(MEntity)
    
    # Isolates only 1 instance of the MEntity
    mentity2 = mentity[[1]][[1]] 
    
    y =  
      append(x, mentity2)
    
    # Edit name of list elements 
    names(y) <- c("Profit_Center", "MEntity")
    
    return(y)
    
     browser()
    
  } 

```

```{r Occupancy Compilation - Occ}

occ_compilation <- function(x){
  
      require("dplyr")
      require("lazyeval")
      require("purrr")
  
# Occ Data 
  occ_df =
    wss_data %>%
      filter(`MEntity` %in% x[["MEntity"]] & unm_product != 'UBOX' & Date <= '2018-12-01') %>% 
      group_by(MEntity,
               Date, 
               unm_product) %>%
      summarize(Total_Rooms = sum(unm_numunits, na.rm = TRUE),
                Occupied_Rooms = sum(unm_occunits, na.rm = TRUE)) %>%
      arrange(Date)
  
  # Collect Data
  occ_df_local = 
    collect(occ_df)
  
    # Rename Data Column to "MONTH"
      colnames(occ_df_local)[2] <- "MONTH"
    
      # Convert Month Column to Date 
        occ_df_local$MONTH <- as.Date(occ_df_local$MONTH)
        
        # Create Fiscal Year Columns for Data 
        if(nrow(occ_df_local) > 0){
        
            occ_df_local <- 
              fiscal_year_columns(occ_df_local)
        
          # Append List 
          y = append(x, list(occ_df_local))
        
        } else {
          
          occ_df_local = NA
          y = append(x, list(occ_df_local))
          
        }
    
  
  names(y)[[5]] = "Unit_Mix"
  
  return(y)
  
  browser()
  
}

```

```{r NA Occupancy Filter - Occ}

  na_Occupancy_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(Unit_Mix))
    
  }

```

```{r Forecasted Occ Function - Forecast Occ}

forecasted_occ_function <- function(x){
  
  require("dplyr")
  require("lazyeval")
  require("purrr")


# Filter DB ----    
db <-
  forecasted_occ_db %>%
  filter(MEntity %in% x[["MEntity"]]) %>%
  group_by(MEntity,
           FC_Date) %>%
  arrange(FC_Date)
  
  
# Collect Local Version ----
db_local <-
  collect(db)

  # Rename Data Column to "MONTH"
      colnames(db_local)[5] <- "MONTH"
    
      # Convert Month Column to Date 
        db_local$MONTH <- as.Date(db_local$MONTH)
        
        # Create Fiscal Year Columns for Data 
          db_local <- 
            fiscal_year_columns(db_local)

# Append List 
    y =
      append(x, list(db_local))
  
  names(y)[[6]] = "Forecasted_Occupancy"
  
  return(y)
  
}

```

```{r NA Forecasted Occupancy Filter - Forecast Occ}

na_fc_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(Forecasted_Occupancy))
  }

```

```{r Not NA Occupancy Filter - Forecast Occ}

not_NA_occ <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(nrow(Occupancy) > 0 )
  }

```

```{r Line Item Compilation}

storage_income <- 
  accounts %>%
  filter(Line.Item == 'STORAGE INCOME')

  sales <-
    accounts %>%
    filter(Line.Item == 'SALES')

    cogs <- 
      accounts %>%
      filter(Line.Item == 'COST OF SALES')

      misc_income <- 
        accounts %>%
        filter(Line.Item == 'MISCELLANEOUS INCOME')

        ubox_income <- 
          accounts %>%
          filter(grepl("U-BOX", accounts$Line.Item))
        
          ubox_income$Line.Item = 'U-BOX'
          
          
          umove_net_commission <-
            accounts %>%
            filter(Line.Item == 'U-MOVE NET COMMISSION')
          
            third_party_lease <-
              accounts %>%
              filter(Line.Item == 'THIRD PARTY LEASE ')
            
              intercompany_lease <-
                accounts %>%
                filter(Line.Item == 'INTERCOMPANY LEASE')
            

            # Expenses ----
              personnel_exp <-
                accounts %>%
                filter(Line.Item == 'PERSONNEL')
              
                repairs_and_maintenance <- 
                  accounts %>%
                  filter(Line.Item == 'REPAIRS AND MAINTENANCE/GENERAL')
                
                  utility_exp <- 
                    accounts %>%
                    filter(Line.Item == 'UTILITIES')
                  
                    telephone_exp <- 
                      accounts %>% 
                      filter(Line.Item == 'TELEPHONE')
                    
                      advertising_exp <-
                        accounts %>%
                        filter(Line.Item == 'ADVERTISING')
                      
                        supplies <-
                          accounts %>%
                          filter(Line.Item == 'SUPPLIES')
                        
                        rent_eqp_land_bldg <- 
                          accounts %>%
                          filter(Line.Item == 'RENT-EQUIPMENT/LAND AND BLDGS')

                      liability_insurance <-
                        accounts %>%
                        filter(Line.Item == 'LIABILITY INSURANCE')
                      
                  property_tax_exp <-
                    accounts %>%
                    filter(Line.Item == 'PROPERTY TAX')
                  
              bad_debt_expense <- 
                accounts %>%
                filter(Line.Item == 'BAD DEBT EXPENSE')
              
          other_op_exp <- 
            accounts %>%
            filter(Line.Item == "OTHER OPERATING EXPENSE")
                        

# Accounts Data Frame ----
chart_of_accounts <-
  bind_rows(storage_income, 
            sales, 
            cogs,
            misc_income,
            ubox_income,
            umove_net_commission,
            third_party_lease,
            intercompany_lease,
            personnel_exp,
            repairs_and_maintenance, 
            utility_exp,
            telephone_exp,
            advertising_exp,
            supplies,
            rent_eqp_land_bldg,
            liability_insurance,
            property_tax_exp,
            bad_debt_expense,
            other_op_exp)
          
          
  # Character conversion ----
  chart_of_accounts$SAP_number <-
    as.character(chart_of_accounts$SAP_number)
          
  # Isolate SAP Account Numbers ----
  sap_accounts <-
    chart_of_accounts %>%
    select(SAP_number)
          
  
          
  # List of Line Item Descriptions ----
  line_items <-         
    chart_of_accounts %>%
      distinct(Line.Item)
          
    line_items <- line_items$Line.Item
    
    # List Creation ----      
    line_item_list <- lapply(line_items, as.list)


```


##**Quarterly Group Compilation**
---

Process

1. Import acquisitions list 
2. Isolate unique Profit centers within each quarterly acquisition group
3. Run aggregate Profit Center on aggregate vector set of Unique Profit Centers 

```{r Quarter Acquisition List Creation}

# Split Data Frame into Elements within a list ----
  q_list_container <- 
    split(acq_list_final, f = acq_list_final$Group)


# Quarter group profit centers by list ----
  quarter_list <- 
    map(q_list_container, profit_center_selection)


# Remove NA from quarter list ----
  quarter_list <- 
    lapply(quarter_list, function(x){x[!is.na(x)]})
  

# Nested profit center list ----
  q_acquisitions_list <- 
    lapply(quarter_list, as.list)

    q_acquisitions_list <-
      modify_depth(q_acquisitions_list, 2, nested_list_creation)
    
 
# Group name addition ----
grp_table <- 
  data.frame(Grp_Num, Group)
    
# Enter grp name identifier ----
for (i in seq_along(q_acquisitions_list)) { 
  names(q_acquisitions_list)[[i]] <- as.character(grp_table$Group[i])
}
    
```


---
##**Income Statement Compilation**
---

```{r Aggregate Income Statement Process Complete 1 4 2019}

# Income statement compilation ----
q_acquisitions_list <-
  modify_depth(q_acquisitions_list, 2, income_statment_compilation_append, accounts = sap_accounts$SAP_number) 



# Collapse Income Statement Process ----
income_statement_list <- modify_depth(q_acquisitions_list, 2, nested_list_filter, z = "Income_Statement")

  # Remove level of list hierarchy
  is_collapsed <- 
    unlist(income_statement_list, recursive = FALSE) # Remove level of list hierarchy
  
  # Collapse into a single data frame ----
  is_collapsed <- 
    ldply(is_collapsed, as.data.frame)
  
    # Format Data Frame for Dashboard Output ----
    is_collapsed <- is_collapsed[ ,c(9,2,3,4,5,6,7,8,1)]
      colnames(is_collapsed)[9] <- "Group"
      
      # Keep th first 7 characters in a string
      is_collapsed$Group <- substr(is_collapsed$Group, 0, 7)
  
        is_collapsed <- 
          left_join(is_collapsed, grp_table, by = "Group")  # Append Group Number to Collapsed Income Statement List ----
        
      # Data type adjustments for export ----
        is_collapsed$FY <- as.numeric(is_collapsed$FY)
        is_collapsed$FM <- as.numeric(is_collapsed$FM)
        is_collapsed$Quarter <- as.numeric(is_collapsed$Quarter)
        
      # Aggregate IS ----
        aggregate_IS_db <- 
          is_collapsed %>%
            group_by(`Date`, Group, `Line Item`, `FY`, `FM`, `Quarter`, `Month`, Grp_Num) %>%
            summarise(Value = sum(`Value`))
        
        # Re-arrange columns ----
        aggregate_IS_db <- aggregate_IS_db[, c(1,3,9, 4,5,6,7,2,8)]
            

```

---
##**Occupancy Metric Compilation**##
---

```{r Occupancy Data Process Process Complete 1 4 2019}

# Append Occ Data to list ----
  q_acquisitions_list <-
      modify_depth(q_acquisitions_list, 2, occ_compilation)


# Collapse Unit Mix Process ----
unit_mix_list <- modify_depth(q_acquisitions_list, 2, nested_list_filter, z = "Unit_Mix") 

  unit_mix_collapsed <- 
    unlist(unit_mix_list, recursive = FALSE)
  
  unit_mix_collapsed <- 
      ldply(unit_mix_collapsed, as.data.frame)
  
    unit_mix_collapsed <- unit_mix_collapsed[ , -11] 
      unit_mix_collapsed <- unit_mix_collapsed[ , c(2, 3, 4, 5, 6, 7, 8, 9, 10 , 1)]
        colnames(unit_mix_collapsed)[10] <- "Group"
          unit_mix_collapsed$Group <- substr(unit_mix_collapsed$Group, 0, 7)
            unit_mix_collapsed <- left_join(unit_mix_collapsed, grp_table, by = "Group")
            
        # Data type adjustments for export ----
        unit_mix_collapsed$FY <- as.numeric(unit_mix_collapsed$FY)
        unit_mix_collapsed$FM <- as.numeric(unit_mix_collapsed$FM)
        unit_mix_collapsed$Quarter <- as.numeric(unit_mix_collapsed$Quarter)    
        
        # Remove NA Occupancy Rows ----
        unit_mix_final <- unit_mix_collapsed[!is.na(unit_mix_collapsed$MEntity), ]
    
        # Aggregate Income Statement ----
        aggregate_occ <- 
          unit_mix_final %>%
            group_by(`MONTH`, Group, `FY`, `FM`, `Quarter`, `Month`, Grp_Num) %>%
            summarise(Total_Rooms = sum(`Total_Rooms`),
                      Occupied_Rooms = sum(`Occupied_Rooms`))
        

```


```{r NA Occupancy MEtrics - Infor on NA Occupancy MEntity, eval=FALSE, include=FALSE}

# Extract Observations with NA Occupancy Metrics ----
  na_occupancy_list <-
    modify_depth(q_acquisitions_list, 1, na_Occupancy_filter)

  # Filter MEntity Numbers for NA Occupancy metrics ----
    profit_centers_na_occ <-
      unlist(modify_depth(na_occupancy_list, 2, nested_list_filter, z = "Profit_Center"))
    
    # Print Vector of profit_centers with NA occupancy ----
      profit_centers_na_occ <-
        as.character(profit_centers_na_occ)

      # Retrieve information regarding profit centers with NA occupancy metrics ----
        na_occupancy_profit_center_info <- 
        SAP.Hierarchy %>%
          filter(Profit_Center %in% profit_centers_na_occ)

```


---
## ** Occupancy Predictions **
---

```{r Forecasted Occ DB connection}

# Forecasted tables use the Finanalysis Database ----
forecasted_occ_db <-dplyr::tbl(con.FinAnalysis, "Storage_Forecast")

```

## *Forecasted Occ Function*

```{r Forecasted Occupancy Metrics Process Complete 1 4 2019}

# Append Forecasted Occupancy to existing function ----
q_acquisitions_list <-
      modify_depth(q_acquisitions_list, 2, forecasted_occ_function)


# Collapse Forecasted Occupancy into single data frame -----
forecast_only_list <- 
  modify_depth(q_acquisitions_list, 2, nested_list_filter, z = "Forecasted_Occupancy") 

 forecast_collapsed <- 
    unlist(forecast_only_list, recursive = FALSE)
  
  forecast_collapsed <- 
      ldply(forecast_collapsed, as.data.frame)
  
    forecast_collapsed <- forecast_collapsed[ , -14] 
      forecast_collapsed <- forecast_collapsed[ , c(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 1)]
        colnames(forecast_collapsed)[13] <- "Group"
        forecast_collapsed$Group <- substr(forecast_collapsed$Group, 0, 7)
        
  # Remove NA MEntity Numbers ----
  forecast_occ_final <- forecast_collapsed[!is.na(forecast_collapsed$MEntity), ]

        
```


```{r NA Forecasted OCC centers}

# Extract Observations with NA Occupancy Metrics ----
  na_fc_occupancy_list <-
    modify_depth(q_acquisitions_list, 1, na_fc_filter)

  # Filter MEntity Numbers for NA Occupancy metrics ----
    profit_centers_na_fc_occ <-
      unlist(modify_depth(na_fc_occupancy_list, 2, nested_list_filter, z = "Profit_Center"))
    
    # Print Vector of profit_centers with NA occupancy ----
      profit_centers_na_fc_occ <-
        as.character(profit_centers_na_fc_occ)

      # Retrieve information regarding profit centers with NA occupancy metrics ----
        na_fc_occupancy_profit_center_info <- 
        SAP.Hierarchy %>%
          filter(Profit_Center %in% profit_centers_na_fc_occ)

```


---
#*Exports*
---

```{r Income Statement Export, include=FALSE}

write.csv(is_collapsed, "\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\Dashboard Connections\\Income_Statement.csv", 
          row.names = FALSE)


# Aggregate IS Export (For Traditional Income Statement / Waterfall view) ----
write.csv(aggregate_IS_db, "\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\Dashboard Connections\\Aggregate_Income_Statement.csv", 
          row.names = FALSE)

```

```{r Occupancy Metrics Export, include=FALSE}

xlsx::write.xlsx(unit_mix_final, 'Z:\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\Dashboard Connections\\UnitMix.xlsx', 
                  append = FALSE,
                  sheetName = "UnitMix",
                  col.names = TRUE,
                  row.names = FALSE
                  )


write.csv(aggregate_occ, "\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\Dashboard Connections\\Aggregate_Occupancy.csv", 
          row.names = FALSE)

```

```{r Forecasted Occupancy Inclusion Export, eval=FALSE, include=FALSE}

write.csv(in_fc_summary,"Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\forecasted_occ_inclusion.csv")

```

```{r Forecasted Occ Metrics Export, include=FALSE}

xlsx::write.xlsx(forecast_occ_final,
                           "Z:\\group\\MIA\\Noe\\Projects\\Post Acquisition\\Report\\Quarterly Acquisitions\\Dashboard Connections\\occ_rooms_forecast.xlsx",
  sheetName = 'Forecasted_Rooms', 
  col.names = TRUE, 
  row.names = FALSE)

```
  
```{r Explore Missing Forecasts Export, eval=FALSE, include=FALSE}

write.csv(profitcenter_missing_fc_info,"Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\Missing Forecasted Occ\\profitcenter_missing_forecast.csv")
      
write.csv(mentity_missing_fc_occ, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\Missing Forecasted Occ\\mentity_missing_forecast.csv")

write.csv(distinct.missingdata.f, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Missing_Forecast.csv")

```
  




