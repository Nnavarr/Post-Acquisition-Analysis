---
title: "Quarterly Acquisitions Report"
author: "Noe Navarro"
date: "July 25, 2018"
output: html_document
---

```{r Library}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)
library(dplyr)
library(dbplyr)
library(R2HTML)
library(CenterIS)

library(supclust)

library(jsonlite)
library(RCurl)

library(tidyr)
library(data.table)

library(rlist)

library(testthat)

```


## **SQL Connections**

```{r}

# Finaccounting connection ----
con.FinAccounting = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FinAccounting",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Finanalysis connection ----
con.FinAnalysis = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FINANALYSIS",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Storage connection ----
  con.Storage = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "Storage",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# MEntity connection ----      
  con.mentity = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "MEntity",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Graph MEntity and SAP number combination
  Graph.Entity.Info.Sql <- dplyr::tbl(con.FinAnalysis, "GRAPH_ENTITY_INFO")
    Graph.Entity.Info.Local <- collect(Graph.Entity.Info.Sql)
      colnames(Graph.Entity.Info.Local)[21] <- 'Profit_Center'
        
```


## **Import Table**

```{r}

# Finaccounting Tables ----
  IS.Trend.Cash = dplyr::tbl(con.FinAccounting, "IS_TREND_CASH")
  SAP.Hierarchy = dplyr::tbl(con.FinAccounting, "SAP_Cost_Center_Hierarchy") 

# Finanalysis Tables ----
  SAP_Info = dplyr::tbl(con.mentity, "MENTITY_SAP")
    SAP.DB = collect(SAP_Info)
      SAP.DB %>% summarise(n_distinct(MEntity))

# Occupancy Table ----  
  Occupancy.Table = dplyr::tbl(con.Storage, "WSS_UnitMixUHI_Monthly_Archive")  
    
# Collect SAP Hierarchy ----
  SAP.Hierarchy <- collect(SAP.Hierarchy)
  colnames(SAP.Hierarchy)[12] <- "Profit_Center"
    
```


## **Functions**
---

### *Aggregate Income Statement*

```{r}

Aggregate.IS <- function(x){

  require(dplyr)
  require(lazyeval)
  require(purrr)

  Income_Statement = IS.Trend.Cash %>% group_by(`MONTH`) %>%
    filter(`PROFIT CENTER` %in% x & MONTH >= '2015-01-01' & MONTH <= '2018-6-01' & SPLIT == 'All' & CURRENCY == 'Group' & `CONTROLLING AREA` == 'UHAL' & `NET OPERATING INCOME` != 0) %>%
    select(`MONTH`,
           `STORAGE INCOME`,
           SALES,
           `SALES - SYSTEM`,
           `COST OF SALES`,
           `COST OF SALES - SYSTEM`,
           `MISCELLANEOUS INCOME`,
           `U-BOX INCOME NET COMMISSION`,
           `U-MOVE NET COMMISSION`,
           `THIRD PARTY RENT/LEASE INCOME`,
           `PERSONNEL EXPENSE`,
           `REPAIRS & MAINTENACE EXPENSE`,
           `UTILITY EXPENSE`,
           `TELEPHONE EXPENSE`,
           `ADVERTISING EXPENSE`,
           SUPPLIES,
           `LEASE EXPENSE - LAND & BLDG`,
           `LIABILITY INSURANCE`,
           `PROPERTY TAX EXPENSE`,
           `BAD DEBT EXPENSE`,
           `OTHER OPERATING EXPENSE`) %>%
    summarize(Storage_Income = sum(`STORAGE INCOME`),
              Sales = sum(`SALES`),
              Sales_System = sum(`SALES - SYSTEM`),
              Cost_of_Sales = sum(`COST OF SALES`),
              Cost_of_Sales_System = sum(`COST OF SALES - SYSTEM`),
              Misc_Income = sum(`MISCELLANEOUS INCOME`),
              UBox_Net = sum(`U-BOX INCOME NET COMMISSION`),
              UMove_Net = sum(`U-MOVE NET COMMISSION`),
              Third_Party_Rent_Lease_Income = sum(`THIRD PARTY RENT/LEASE INCOME`),
              Personnel_Exp = sum(`PERSONNEL EXPENSE`),
              Repairs_and_Maintenance = sum(`REPAIRS & MAINTENACE EXPENSE`),
              Utility_Exp = sum(`UTILITY EXPENSE`),
              Telephone_Exp = sum(`TELEPHONE EXPENSE`),
              Advertising_Exp = sum(`ADVERTISING EXPENSE`),
              Supplies = sum(`SUPPLIES`),
              Lease_Exp = sum(`LEASE EXPENSE - LAND & BLDG`),
              Liab_Insurance = sum(`LIABILITY INSURANCE`),
              Property_Tax = sum(`PROPERTY TAX EXPENSE`),
              Bad_Debt_Exp = sum(`BAD DEBT EXPENSE`),
              Other_Op_Exp = sum(`OTHER OPERATING EXPENSE`))

  Income_Statement.Local = collect(Income_Statement)

  Income_Statement.Local[is.na(Income_Statement.Local)] = 0 #Replace NA values with 0

  ##Updating line##
  Income_Statement.Local = Income_Statement.Local %>%
    mutate(Adj_Sales = Sales - Sales_System,
           Adj_COS = Cost_of_Sales - Cost_of_Sales_System,
           Adj_NetSales = (Sales - Sales_System) + (Cost_of_Sales - Cost_of_Sales_System),
           Op_TotalIncome = Storage_Income + Adj_Sales + Adj_COS + Misc_Income + UBox_Net + UMove_Net + Third_Party_Rent_Lease_Income,
           Op_Expense = Personnel_Exp + Repairs_and_Maintenance + Utility_Exp + Telephone_Exp + Advertising_Exp + Supplies + Lease_Exp + Liab_Insurance +  Property_Tax + Bad_Debt_Exp + Other_Op_Exp,
           OP_NOI = Op_TotalIncome + Op_Expense)

  #Change "Month" to Date
  Income_Statement.Local$MONTH = as.Date(Income_Statement.Local$MONTH)

  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #%% Flip expense signs to positive %%
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  Income_Statement.Local$Cost_of_Sales = -(Income_Statement.Local$Cost_of_Sales)
  Income_Statement.Local$Adj_COS = -(Income_Statement.Local$Adj_COS)
  Income_Statement.Local$Cost_of_Sales_System = -(Income_Statement.Local$Cost_of_Sales_System)
  Income_Statement.Local$Personnel_Exp = -(Income_Statement.Local$Personnel_Exp)
  Income_Statement.Local$Repairs_and_Maintenance = -(Income_Statement.Local$Repairs_and_Maintenance)
  Income_Statement.Local$Utility_Exp = -(Income_Statement.Local$Utility_Exp)
  Income_Statement.Local$Telephone_Exp = -(Income_Statement.Local$Telephone_Exp)
  Income_Statement.Local$Advertising_Exp = -(Income_Statement.Local$Advertising_Exp)
  Income_Statement.Local$Supplies = -(Income_Statement.Local$Supplies)
  Income_Statement.Local$Lease_Exp = -(Income_Statement.Local$Lease_Exp)
  Income_Statement.Local$Liab_Insurance = -(Income_Statement.Local$Liab_Insurance)
  Income_Statement.Local$Property_Tax = -(Income_Statement.Local$Property_Tax)
  Income_Statement.Local$Bad_Debt_Exp = -(Income_Statement.Local$Bad_Debt_Exp)
  Income_Statement.Local$Other_Op_Exp = -(Income_Statement.Local$Other_Op_Exp)
  Income_Statement.Local$Op_Expense = -(Income_Statement.Local$Op_Expense)


  #Melt Dataframe
  melt.data = melt(Income_Statement.Local, id = "MONTH")

  #Fiscal Year / Month Qualifications
  melt.data$FY = ""
  melt.data$FM = " "
  melt.data$Quarter = ""


  #%%%%%%%%%%%%%%%%%%%%%
  #%% FY and Quarter Loop %%
  #%%%%%%%%%%%%%%%%%%%%%

  for (i in 1:length(melt.data$FY)){

    if(melt.data$MONTH[i] >= '2015/1/1' & melt.data$MONTH[i] <= '2015/3/1'){

      melt.data$FY[i] = 2015
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2015/4/1' & melt.data$MONTH[i] <= '2015/6/1') {

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2015/7/1' & melt.data$MONTH[i] <= '2015/9/1') {

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2015/10/1' & melt.data$MONTH[i] <= '2015/12/1'){

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2016/1/1' & melt.data$MONTH[i] <= '2016/3/1'){

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2016/4/1' & melt.data$MONTH[i] <= '2016/6/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2016/7/1' & melt.data$MONTH[i] <= '2016/9/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2016/10/1' & melt.data$MONTH[i] <= '2016/12/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2017/1/1' & melt.data$MONTH[i] <= '2017/3/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2017/4/1' & melt.data$MONTH[i] <= '2017/6/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2017/7/1' & melt.data$MONTH[i] <= '2017/9/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2017/10/1' & melt.data$MONTH[i] <= '2017/12/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2018/1/1' & melt.data$MONTH[i] <= '2018/3/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2018/4/1' & melt.data$MONTH[i] <= '2018/6/1'){

      melt.data$FY[i] = 2019
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2018/7/1' & melt.data$MONTH[i] <= '2018/9/1'){

      melt.data$FY[i] = 2019
      melt.data$Quarter[i] = 2

    }
  }

  #%%%%%%%%%%%%%
  #%% Month Loop %%
  #%%%%%%%%%%%%

  melt.data$Month = " "

  for (i in 1:length(melt.data$Month)){
    melt.data$Month[i] = format(melt.data$MONTH[i], "%b")
  }
  for (i in 1:length(melt.data$FM)){
    if(month(melt.data$MONTH[i]) >= 4 & month(melt.data$MONTH[i]) <= 12){
      melt.data$FM[i] = month(melt.data$MONTH[i]) - 3
    } else if (month(melt.data$MONTH[i]) == 1) {
      melt.data$FM[i] = 10
    } else if (month(melt.data$MONTH[i]) == 2) {
      melt.data$FM[i] = 11
    } else if (month(melt.data$MONTH[i]) == 3){
      melt.data$FM[i] = 12
    }
  }

  #%%%%%%%%%%%%%%%%
  #%% Rename Columns %%
  #%%%%%%%%%%%%%%%%%

  colnames(melt.data) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month")

  return(melt.data)

}

```


### **Income Statement Data Check**

```{r Data Check Function}

data_check_na <-
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = NA
  }
  return(list.vector)
}



data_check_flag <- 
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = paste("Error:", paste(x), sep = " ")
  }
  return(list.vector)
}


data_check_center <-
  function(x){
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  #vector of list
  list.vector = list()
  list.complete = list()
  
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
    
  if(nrow(b) > 0){
    list.vector[[i]] = 1
  } else {
    list.complete[[i]] = x
  }
  return(list.complete)
}



```


```{r}

# Nested list creation
  nested_list_creation <-
  function(x) {
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  list.vector = list()
    i = 1
  
    list.vector[[i]] = x

  return(list.vector)
}

```


### **Month of Operation Start**

```{r}

MonthofOperation.Start = function (x){

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  start_of_record = min(x$MONTH)
  return(start_of_record)
  
}

```


### **Omit NA from list**

```{r}

na.omit.list <- function(y) {
  return(y[!sapply(y, function(x) all(is.na(x)))])
}

```


### **Property Owner Function**

```{r}

Property_Owner = function (x){

  #Filter Criteria
  d = SAP.Hierarchy %>% filter(`Cost Center` == x)

  #%Create a local copy of the data frame
  
  b = collect(d)
  c = b$`Hierarchy Area`
  return(c)

  # Rare situations to be aware of
  # In some instances, the Cost center used to filter will actually return two

}

```


### **Vector Conversion Function**

```{r}

vector.conv <- function(x){
  x = as.vector(x$Profit_Center)
  x = as.character(x)
}

```


##**Compilation of New Acquisitions List**

```{r This section will need to be updated last}

# Import New Acquisitions List ----
  New.Acquisitions <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\New Acquisitions F19 Q1.csv")

  # Rename New.Acquisitions 3rd column to "Entity"  ----
    colnames(New.Acquisitions)[3] <- "Entity"
      New.Acquisitions$Entity <- as.character(New.Acquisitions$Entity)
      
  # Import Graph File Data ----
    Graph.File <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Q1 Graph File.csv", header = TRUE)
      
    Graph.File$Entity <- as.character(Graph.File$Entity)
    Graph.File$MEntity <- as.character(Graph.File$MEntity)
    
  # Import Profit Center from Graph File
    New.Acquisitions = left_join(New.Acquisitions, Graph.Entity.Info.Local[, c(1,3,21)], by = 'Entity')
    New.Acquisitions <- left_join(New.Acquisitions, Graph.File[ , c(1,10)], by = 'Entity') #Import Owner
  
    
    
      # Filter for abutting properties.
        for (i in 1:length(New.Acquisitions$Entity)){
          
          if (grepl("?butting", New.Acquisitions$Property.Description[i]) == TRUE){
            
            New.Acquisitions$Include[i] = 'No'
            
          } else if (grepl("?emote", New.Acquisitions$Property.Description[i]) == TRUE){
            
            New.Acquisitions$Include[i] = "No"
            
            
          } else if (grepl("SAC", New.Acquisitions$Owner[i])){
            
          
            New.Acquisitions$Include[i] = "No"
            
          } else {
            
            New.Acquisitions$Include[i] = "Yes"
        
          }
        }

    # Export to CSV
     # write.csv(New.Acquisitions, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\NewAcq_Export.csv")
  
```

---
##**Completed Acquisitions Spreadsheet**

```{r}

# Completed acquisitions spreadsheet import ----
  c_acquisitions <- 
  read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Completed_Acquisitions20180725.csv", header = TRUE)

  # completed completed acquisitions tbl conversion ----
    c_acquisitions <- 
      as.tbl(c_acquisitions)

      c_acquisitions_include <- 
        c_acquisitions %>% 
        filter(Include. == 'Yes')
      
        c_acquisitions_exclude <- 
          c_acquisitions %>% 
          filter(Include. == 'No')
      
```


###*Duplicate profit center check*

```{r}

# c.acquisitions extraction of profit center numbers ----
  c_acquisitions_pc <-
    c_acquisitions_include %>% 
    select(Profit_Center)

  # c.aquisitioins removal of NA values ----
    c_acquisitions_pc_complete <-  
      c_acquisitions_pc[!is.na(c_acquisitions_pc), ] 
   
    # Check for duplicate profit centers within completed acquisitions data frame ----
      duplicate_pc_check_1 <- 
        c_acquisitions_pc_complete %>%
          group_by(Profit_Center) %>%
          mutate(Count = 1) %>%
          summarise(Total = sum(Count)) %>%
          filter(Total > 1)
      
      # Kill switch if duplicate profit centers are detected; Check 1 ----
        if(length(duplicate_pc_check_1$Profit_Center) != 0) {
        
          stop() 
        
        }

```


---
##**Quarterly Group Compilation**
---


Process

1. Import acquisitions list 
2. Isolate unique Profit centers within each quarterly acquisition group
3. Run aggregate Profit Center on aggregate vector set of Unique Profit Centers 


```{r}

# Quarterly acquisition group creation (code improvement) ----

# Split Data Frame into Elements within a list ----
  q_list_container <- 
    split(c_acquisitions_include, f = c_acquisitions_include$Group)

  # Select Unique Profit Center Numbers ----
    profit_center_selection <- function(x){
      
    # Library
      require("dplyr")
      require("lazyeval")
      require("purrr")
        
        # Extract profit center ----
        grp_pc = x %>% 
                   select(Profit_Center)
        
        # Isolate Unique Profit Centers ----
        grp_pc_unique = unique(grp_pc$Profit_Center)
          grp_pc_unique = as.character(grp_pc_unique)
          
      }
    
# Quarter group profit centers by list ----
  quarter_list <- 
    map(q_list_container, profit_center_selection)

# Remove NA from quarter list (this is a safety on the initial )
  quarter_list <- 
    lapply(quarter_list, function(x){x[!is.na(x)]})
  
```


###**Check for income statement representation**

```{r}

# Nested profit center list ----
  n_pc_list <- 
    lapply(quarter_list, as.list)

    n_pc_list_2 <-
      modify_depth(n_pc_list, 2, nested_list_creation)
  
    # Missing income statement data ----
      missing_income_statement <- 
       modify_depth(n_pc_list, 2, data_check_center)
    
        missing_is_profit_centers <- 
          unlist(missing_income_statement) # Be careful, the grp number is correct, the index is not
        
          missing_is_profit_centers <- 
            as.data.frame(missing_is_profit_centers)
          
            colnames(missing_is_profit_centers) <- 
              "Profit_Center"
        
        # Missing center information ----
          missing_is_profit_centers <- 
              left_join(missing_is_profit_centers, SAP.Hierarchy[ , c(4, 12, 44)], by = "Profit_Center") 
            
                # The missing centers do not appear to have any MEntity info. 
                  data.table(missing_is_profit_centers)
                  
                    # 7000011179 ; grp 5
                    # 7000011246 ; grp 6 
                    # 7000011204 ; grp 6 
            
    # Complete income statement data ----
      complete_income_statement <- 
        modify_depth(n_pc_list, 2, data_check_na)
                  
        complete_is_profit_centers <- 
          unlist(complete_income_statement)
        
          complete_is_profit_centers <- 
            as.data.frame(complete_is_profit_centers)
          
            complete_is_profit_centers <- 
              as.data.frame(complete_is_profit_centers[!is.na(complete_is_profit_centers)])
            
              colnames(complete_is_profit_centers) <- 
                "Profit_Center" # The data frame will be used to check against a list of occupancy profit centers
          
              # List of Quarterly Acquisitions included in the income statement aggregation ----
                nested_profit_center_list <- 
                  na.omit.list(n_pc_list_2)
            
```


---
##**Aggregate Income Statement Compilation**
---

```{r Aggregate Income Statement Process}

# Income statement compilation ----
  aggregate_income_statement <- map(quarter_list, Aggregate.IS)

  # Creation of group identifier table ----
    grp_number <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14)
    grp_name <- c("FY15 Q4", 
                  "FY16 Q1", 
                  "FY16 Q2",
                  "FY16 Q3",
                  "FY16 Q4",
                  "FY17 Q1",
                  "FY17 Q2",
                  "FY17 Q3",
                  "FY17 Q4",
                  "FY18 Q1",
                  "FY18 Q2", 
                  "FY18 Q3", 
                  "FY18 Q4",
                  "FY19 Q1")
    
    grp_table <- 
      data.frame(grp_number,grp_name)
    
    # Enter grp name identifier ----
      for (i in seq_along(aggregate_income_statement)) { 
        aggregate_income_statement[[i]]$Group = as.character(grp_table$grp_name[i])
      }
    
# Unlist income statement data into a data frame for excel export ----
  income_statement_aggregate <-   
    map_df(aggregate_income_statement, `[`)
    
  # Import group number for Dashboard ----
    colnames(grp_table)[1] <- "Grp_Num"
    colnames(grp_table)[2] <- "Group"
      income_statement_aggregate <-
        left_join(income_statement_aggregate, grp_table, by = 'Group')
      
      # Data type adjustments for export ----
        income_statement_aggregate$FY <- as.numeric(income_statement_aggregate$FY)
        income_statement_aggregate$FM <- as.numeric(income_statement_aggregate$FM)
        income_statement_aggregate$Quarter <- as.numeric(income_statement_aggregate$Quarter)

    # Export Data
      xlsx::write.xlsx(income_statement_aggregate, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Report Data\\Report42018.xlsx",
                    sheetName = "Report42018")
    
```


---
##**Occupancy Metric Compilation**##
---

```{r Occupancy Function}

  occupancy.calc = function(x){
    d <- Occupancy.Table %>% 
                            filter(x) %>%
                            group_by(Date, 
                                     MEntity,
                                     unm_product, 
                                     unm_numunits,
                                     unm_occunits,
                                     unm_damunits,
                                     unm_floor,
                                     unm_elevation,
                                     unm_climate,
                                     unm_rentrate)
    collect(d)
  }

```


```{r}

occ.data.comp.function = function(x, list.container){
    
    # Filter and select only the profit centers from the individual data frames
    a <- x %>% select(Profit_Center)
    
    # Loop and save each observation in the data frame in a single list row
    for (i in a){
      list.container = i
      i + 1
    }
      
    # List Creation 
      list.container = as.list(list.container)
  
    # Return List 
      return(list.container)
}



```


# PROCESS UPDATE IN PROGRESS

Current Process

1. Create individual list containers
2. Check for Data
3. 
  
```{r Import MEntity Numbers}

# MEntity number join on profit center # ----
  sap2mentity <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    mentity = 
      SAP.Hierarchy %>%
        filter(`Profit_Center` %in% x[[1]]) %>%
        select(MEntity)
    
    # Isolates only 1 instance of the MEntity
    mentity2 = mentity[[1]][[1]] 
    
    y =  
      append(x, mentity2)
    
    # Edit name of list elements 
    names(y) <- c("Profit_Center", "MEntity")
    
    return(y)
    
     browser()
    
  }   

# List of Profit Centers to Include OCcupancy data for ----
  nested_profit_center_list

  # Import MEntity on profit center list ----
    nested_profit_center_list_2 <-
      modify_depth(nested_profit_center_list, 2, sap2mentity)
    
  # Modify names of outer list ----
  group_names <-
    c('FY15 Q4', 'FY16 Q1', 'FY16 Q2', 'FY16 Q3', 'FY16 Q4', 'FY17 Q1', 'FY17 Q2', 'FY17 Q3', 'FY17 Q4', 'FY18 Q1', 'FY18 Q2', 'FY18 Q3', 'FY18 Q4', 'FY19 Q1')

    names(nested_profit_center_list_2) <- group_names
  
```


```{r}

depth <- function(this, thisdepth = 0){
  
  if(!is.list(this)){
    return(thisdepth)
  } else {
    return(max(unlist(lapply(this, depth, thisdepth = thisdepth + 1))))
  }
}

# Test nested profit center list depth ----
  expect_equal(depth(nested_profit_center_list_2), 3) # Depth at 3 

t1 <- 
nested_profit_center_list_2[[1]]
lapply(t1, function(x){
  x[["MEntity"]]
})


# Working MEntity Join Function 
    y =  
      append(x, SAP.Hierarchy %>%
        filter(`Profit_Center` %in% x[[1]][[1]][[1]]) %>%
        select(MEntity))
    
    # Edit name of list elements 
    names(y) <- c("Profit_Center", "MEntity")
    
    return(y)
    
     browser()
    
  }   


# Temporary Solution 
    sap2mentity <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    mentity = 
      SAP.Hierarchy %>%
        filter(`Profit_Center` %in% x[[1]][[1]][[1]][1]) %>%
        select(MEntity)
    
    mentity2 = mentity[1]
    
    y =  
      append(x, mentity2[[1]])
    
    # Edit name of list elements 
    names(y) <- c("Profit_Center", "MEntity")
    
    return(y)
    
     browser()
    
  }   


```




```{r Filter list test}

# MEntity Filter function ----
nested_list_filter <- function(x, z){

 # z = character string of object to be filtered  
 y = x[[z]]
 return(y)
}


# Test Function
test <-
  modify_depth(nested_profit_center_list_2, 2, mentity_filter, z = "MEntity")  


```


```{r Remove Duplicate MEntity Numbers}
unique_mentity_filter <- function(x){
  
  y = x[[1]]
  
  return(y)
}



test_single <-
  test[["FY18 Q3"]][[14]]

test_single[[1]]

length(test_single)

```







```{r Potential Function to Append List}

# Append List with another element (regardless of number of elements) ----
   append_nested_list <- function(x, new_element){
    
     # Append if Data Frame (Create if Statement)
       if(class(new_element) == 'data.frame'){
         x2 = 
           append(x[[1]], list(new_element))
       } else {
         x2 = 
           append(x[[1]], new_element)
         
       }
   }
     

   # Referencing the DF added into list (2nd element at the moment) ----
      nested_profit_center_list2[[1]][[1]][[2]]
        
    # test Nested Sublist 
      nested_profit_center_list2 <- 
        modify_depth(nested_profit_center_list, 2, append_nested_list, new_element = x3)
      
      
    
# _________________#
# Test list subset #    
# _________________#
    
    # Working Filter of List 9/7/2018
    tfilter <- 
      as.character(SAP.Hierarchy %>%
        filter(Profit_Center %in% nested_profit_center_list[[1]][[1]][[1]]) %>%
        select(MEntity))
    
    tfilter2 <- 
      as.character("append2")

    # add the variable above to an existing list
      tlist <- nested_profit_center_list
      
      # Working Code to append list element ----
      tlist <-
        append(tlist[[1]][[1]], tfilter2) # Works to append existing lis structure with a third element (SINGLE LIST ELEMENT)
      
      #-----------------------------------------------------------------------------------------------------------------------
      
      
      # Renaming List element ----
        names(tlist)
        
      # This process is working. Now we need to apply this for every element of the nested list. 
        names(tlist) <- c("Profit_Center", "MEntity", "Test") # Working Code to Rename 
        
        
        
        
# Append dataframe to list ----
  x1 <- c(50, 100, 10)
  x2 <- c(70, 80, 100)    
  x3 <- c("one", "two", "three")
            
  x3 <- data.frame(x1, x2)
  
  tlist <- 
    append(tlist, list(x3))
  
  list(x3)
  
  # Appending List Dynamically
    # In order to append the list regardless of the existing list elements, we will need a method for appending on iteration. 
  
  
# Append List regardless of elements ----


```









Occ Data Compilation 
```{r}



```


```{r Needs update}

# Groups #
  grp1.MEntity = unique(map(grp1.pc.list2, SAP2Mentity)) # 8
  grp2.MEntity = unique(map(grp2.pc.list2, SAP2Mentity)) # 5
  grp3.MEntity = unique(map(grp3.pc.list2, SAP2Mentity)) # 7
  grp4.MEntity = unique(map(grp4.pc.list2, SAP2Mentity)) # 11
  grp5.MEntity = unique(map(grp5.pc.list2, SAP2Mentity)) # 11
  grp6.MEntity = unique(map(grp6.pc.list2, SAP2Mentity)) # 13
  grp7.MEntity = unique(map(grp7.pc.list2, SAP2Mentity)) # 13
  grp8.MEntity = unique(map(grp8.pc.list2, SAP2Mentity)) # 13
  grp9.MEntity = unique(map(grp9.pc.list2, SAP2Mentity)) # 11
  grp10.MEntity = unique(map(grp10.pc.list2, SAP2Mentity)) # 9
  grp11.MEntity = unique(map(grp11.pc.list2, SAP2Mentity)) # 12
  grp12.MEntity = unique(map(grp12.pc.list2, SAP2Mentity)) # 19
  grp13.MEntity = unique(map(grp13.pc.list2, SAP2Mentity)) # 25
  grp14.MEntity = unique(map(grp14.pc.list2, SAP2Mentity)) # 10
  
```


```{r Occupancy Data Aggregation}

# Step 3: Occupancy Tables #
  grp1.ME <- unlist(grp1.MEntity)
    grp1.ME <- as.character(grp1.ME)
    
  grp2.ME <- unlist(grp2.MEntity)
      grp2.ME <- as.character(grp2.ME)
    
  grp3.ME <- unlist(grp3.MEntity)
      grp3.ME <- as.character(grp3.ME)
    
  grp4.ME <- unlist(grp4.MEntity)
      grp4.ME = as.character(grp4.ME)
    
  grp5.ME <- unlist(grp5.MEntity)
      grp5.ME = as.character(grp5.ME)
    
  grp6.ME <- unlist(grp6.MEntity)
      grp6.ME = as.character(grp6.ME)
    
  grp7.ME <- unlist(grp7.MEntity)
      grp7.ME = as.character(grp7.ME)
    
  grp8.ME <- unlist(grp8.MEntity)
      grp8.ME = as.character(grp8.ME)
    
  grp9.ME <- unlist(grp9.MEntity)
      grp9.ME = as.character(grp9.ME)
    
  grp10.ME <- unlist(grp10.MEntity)
      grp10.ME = as.character(grp10.ME)

  grp11.ME <- unlist(grp11.MEntity)
      grp11.ME = as.character(grp11.ME)
    
  grp12.ME <- unlist(grp12.MEntity)
      grp12.ME = as.character(grp12.ME)
      
  grp13.ME <- unlist(grp13.MEntity)
      grp13.ME = as.character(grp13.ME)    

  grp14.ME <- unlist(grp14.MEntity)
      grp14.ME = as.character(grp14.ME)
      
      
  # Check MEntity Counts ----
    occ.mentity.df <- 
        as.data.frame(c(grp1.ME,
              grp2.ME,
              grp3.ME,
              grp4.ME, 
              grp5.ME,
              grp6.ME,
              grp7.ME,
              grp8.ME,
              grp9.ME,
              grp10.ME,
              grp11.ME,
              grp12.ME,
              grp13.ME,
              grp14.ME))
      
      colnames(occ.mentity.df)[1] = 'MEntity'
      
      occ.mentity.df <- 
      occ.mentity.df %>% 
        arrange(MEntity)
      
      # Dimension 
        dim(occ.mentity.df) # 156 Unique MEntity
        
        # There were originally 246 unique profit center numbers. This means we lost 90 centers when merging Profit Center with MEntity number. 
      
        
 # Profit Center to MEntity Comparison ----
   profitcenter_to_mentity <- 
        as.data.frame(profit.center.vector) # Rows = 248
        
 # Remove NA Profit Centers 
   profitcenter_to_mentity <- as.data.frame(profitcenter_to_mentity[!is.na(profitcenter_to_mentity)]) 
   colnames(profitcenter_to_mentity)[1] <- 'Profit_Center'
   
     # Left Join Graph Data ----
       profitcenter_to_mentity <-
          left_join(profitcenter_to_mentity, Graph.Entity.Info.Local[ , c(3:5, 11:15,21)], by = 'Profit_Center') # Rows = 791
            # 543 Difference in row count
  
     # Extract MEntity from the DF ----
       d.mentity.check <- 
       profitcenter_to_mentity %>% 
         distinct(MEntity) 
   
       d.mentity.check[!is.na(d.mentity.check)] # 156 Unique MEntity numbers 
       
   

```


```{r}

# Vector to filter Product Type #
  #product.type = c("CONTAINER", "DRIVE UP", "INTERIOR", "SPLIT LEVEL", "RV")

  
  # From there, we can calculate our summary fields (Total_SF & Occupied_SF (a sum of these fields respectively)
    grp1.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp1.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    grp2.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp2.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp3.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp3.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp4.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp4.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp5.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp5.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp6.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp6.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp7.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp7.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp8.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp8.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    grp9.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp9.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp10.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp10.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
  
#______________________________________________________________________________________________________________________________________________      
    # As of 3/21/2018 the next two groups are #
   grp11.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp11.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                  group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
   grp12.unitmix = Occupancy.Table %>% 
                  filter(`MEntity` %in% grp12.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)
    
    
    grp13.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp13.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)  
    
    
    grp14.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp14.ME & unm_product != 'UBOX' & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        Date, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(Date)      
    
    
  
```


```{r}

# Individual Groups #
  Group1.UM = collect(grp1.unitmix)
  Group2.UM = collect(grp2.unitmix)
  Group3.UM = collect(grp3.unitmix)
  Group4.UM = collect(grp4.unitmix)
  Group5.UM = collect(grp5.unitmix)
  Group6.UM = collect(grp6.unitmix)
  Group7.UM = collect(grp7.unitmix)
  Group8.UM = collect(grp8.unitmix)
  Group9.UM = collect(grp9.unitmix)
  Group10.UM = collect(grp10.unitmix)
  Group11.UM = collect(grp11.unitmix)
  Group12.UM = collect(grp12.unitmix)
  Group13.UM = collect(grp13.unitmix)
  Group14.UM = collect(grp14.unitmix)
  

  # Import Profit Center #
    Group1.UM = left_join(Group1.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group2.UM = left_join(Group2.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group3.UM = left_join(Group3.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group4.UM = left_join(Group4.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group5.UM = left_join(Group5.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group6.UM = left_join(Group6.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group7.UM = left_join(Group7.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group8.UM = left_join(Group8.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group9.UM = left_join(Group9.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group10.UM = left_join(Group10.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group11.UM = left_join(Group11.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group12.UM = left_join(Group12.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group13.UM = left_join(Group13.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group14.UM = left_join(Group14.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    
  
  # Re-name Column #
    colnames(Group1.UM)[2] = 'MONTH'
    colnames(Group2.UM)[2] = 'MONTH'
    colnames(Group3.UM)[2] = 'MONTH'
    colnames(Group4.UM)[2] = 'MONTH'
    colnames(Group5.UM)[2] = 'MONTH'
    colnames(Group6.UM)[2] = 'MONTH'
    colnames(Group7.UM)[2] = 'MONTH'
    colnames(Group8.UM)[2] = 'MONTH'
    colnames(Group9.UM)[2] = 'MONTH'
    colnames(Group10.UM)[2] = 'MONTH'
    colnames(Group11.UM)[2] = 'MONTH'
    colnames(Group12.UM)[2] = 'MONTH'
    colnames(Group13.UM)[2] = 'MONTH'
    colnames(Group14.UM)[2] = 'MONTH'
    
  # unm_timestamp #
    # The Date conversion is done here due to how the SQL table pulls through. It comes in as a charcter #
    Group1.UM$MONTH = as.Date(Group1.UM$MONTH)  
    Group2.UM$MONTH = as.Date(Group2.UM$MONTH)
    Group3.UM$MONTH = as.Date(Group3.UM$MONTH)
    Group4.UM$MONTH = as.Date(Group4.UM$MONTH)
    Group5.UM$MONTH = as.Date(Group5.UM$MONTH)
    Group6.UM$MONTH = as.Date(Group6.UM$MONTH)
    Group7.UM$MONTH = as.Date(Group7.UM$MONTH)
    Group8.UM$MONTH = as.Date(Group8.UM$MONTH)
    Group9.UM$MONTH = as.Date(Group9.UM$MONTH)
    Group10.UM$MONTH = as.Date(Group10.UM$MONTH)
    Group11.UM$MONTH = as.Date(Group11.UM$MONTH)
    Group12.UM$MONTH = as.Date(Group12.UM$MONTH)
    Group13.UM$MONTH = as.Date(Group13.UM$MONTH)
    Group14.UM$MONTH = as.Date(Group14.UM$MONTH)
    
  
  # Profit Center to Numeric #  
    Group1.UM$Profit_Center = as.numeric(Group1.UM$Profit_Center)
    Group2.UM$Profit_Center = as.numeric(Group2.UM$Profit_Center)
    Group3.UM$Profit_Center = as.numeric(Group3.UM$Profit_Center)
    Group4.UM$Profit_Center = as.numeric(Group4.UM$Profit_Center)
    Group5.UM$Profit_Center = as.numeric(Group5.UM$Profit_Center)
    Group6.UM$Profit_Center = as.numeric(Group6.UM$Profit_Center)
    Group7.UM$Profit_Center = as.numeric(Group7.UM$Profit_Center)
    Group8.UM$Profit_Center = as.numeric(Group8.UM$Profit_Center)
    Group9.UM$Profit_Center = as.numeric(Group9.UM$Profit_Center)
    Group10.UM$Profit_Center = as.numeric(Group10.UM$Profit_Center)
    Group11.UM$Profit_Center = as.numeric(Group11.UM$Profit_Center)
    Group12.UM$Profit_Center = as.numeric(Group12.UM$Profit_Center)
    Group13.UM$Profit_Center = as.numeric(Group13.UM$Profit_Center)
    Group14.UM$Profit_Center = as.numeric(Group14.UM$Profit_Center)

    
```


Fiscal Year and Group Addition
```{r}

    FiscalYear.Columns = function(x){
      
      x$FY = " "
      x$FM = " "
      x$Quarter = " "
      
        # Fiscal Year Loop # 
      
            for (i in 1:length(x$FY)){
          
              if(x$MONTH[i] >= '2015/1/1' & x$MONTH[i] <= '2015/3/31'){
                
                x$FY[i] = 2015
                x$Quarter[i] = 4
                
              } else if (x$MONTH[i] >= '2015/4/1' & x$MONTH[i] <= '2015/6/30') { 
                
                x$FY[i] = 2016
                x$Quarter[i] = 1
                
              } else if (x$MONTH[i] >= '2015/7/1' & x$MONTH[i] <= '2015/9/30') {
                
                x$FY[i] = 2016
                x$Quarter[i] = 2
                
              } else if (x$MONTH[i] >= '2015/10/1' & x$MONTH[i] <= '2015/12/31'){
               
                x$FY[i] = 2016
                x$Quarter[i] = 3 
                
              } else if (x$MONTH[i] >= '2016/1/1' & x$MONTH[i] <= '2016/3/31'){
                
                x$FY[i] = 2016
                x$Quarter[i] = 4 
                  
              } else if (x$MONTH[i] >= '2016/4/1' & x$MONTH[i] <= '2016/6/30'){
                
                x$FY[i] = 2017
                x$Quarter[i] = 1                 
                
              } else if (x$MONTH[i] >= '2016/7/1' & x$MONTH[i] <= '2016/9/30'){

                x$FY[i] = 2017
                x$Quarter[i] = 2                                 
                
              } else if (x$MONTH[i] >= '2016/10/1' & x$MONTH[i] <= '2016/12/31'){ 
                  
                x$FY[i] = 2017
                x$Quarter[i] = 3                
                
                } else if (x$MONTH[i] >= '2017/1/1' & x$MONTH[i] <= '2017/3/31'){
                  
                x$FY[i] = 2017
                x$Quarter[i] = 4   
                
                } else if (x$MONTH[i] >= '2017/4/1' & x$MONTH[i] <= '2017/6/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 1                    
                  
                } else if (x$MONTH[i] >= '2017/7/1' & x$MONTH[i] <= '2017/9/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 2                  
                  
                } else if (x$MONTH[i] >= '2017/10/1' & x$MONTH[i] <= '2017/12/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 3   
                  
                } else if (x$MONTH[i] >= '2018/1/1' & x$MONTH[i] <= '2018/3/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 4  
                  
                } else if (x$MONTH[i] >= '2018/4/1' & x$MONTH[i] <= '2018/6/30'){     
                  
                x$FY[i] = 2019
                x$Quarter[i] = 1                     
                
                } else if (x$MONTH[i] >= '2018/7/1' & x$MONTH[i] <= '2018/9/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 2                  
          
                } else if (x$MONTH[i] >= '2018/10/1' & x$MONTH[i] <= '2018/12/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 3                  
          
                } else if (x$MONTH[i] >= '2019/1/1' & x$MONTH[i] <= '2019/3/31'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 4                
              
                } else if (x$MONTH[i] >= '2019/4/1' & x$MONTH[i] <= '2019/6/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 1                
              
                } else if (x$MONTH[i] >= '2019/7/1' & x$MONTH[i] <= '2019/9/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2019/10/1' & x$MONTH[i] <= '2019/12/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2020/1/1' & x$MONTH[i] <= '2020/3/31'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2020/4/1' & x$MONTH[i] <= '2020/6/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2020/7/1' & x$MONTH[i] <= '2020/9/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2020/10/1' & x$MONTH[i] <= '2020/12/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2021/1/1' & x$MONTH[i] <= '2021/3/31'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 4
              
                } else if (x$MONTH[i] >= '2021/4/1' & x$MONTH[i] <= '2021/6/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 1
              
                } else if (x$MONTH[i] >= '2021/7/1' & x$MONTH[i] <= '2021/9/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 2
              
              
                } else if (x$MONTH[i] >= '2021/10/1' & x$MONTH[i] <= '2021/12/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2022/1/1' & x$MONTH[i] <= '2022/3/31'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2022/4/1' & x$MONTH[i] <= '2022/6/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2022/7/1' & x$MONTH[i] <= '2022/9/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 2
                
                } else if (x$MONTH[i] >= '2022/10/1' & x$MONTH[i] <= '2022/12/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2023/1/1' & x$MONTH[i] <= '2023/3/31'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2023/4/1' & x$MONTH[i] <= '2023/6/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2023/7/1' & x$MONTH[i] <= '2023/9/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2023/10/1' & x$MONTH[i] <= '2023/12/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2024/1/1' & x$MONTH[i] <= '2024/3/31'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2024/4/1' & x$MONTH[i] <= '2024/6/30'){
                  
                x$FY[i] = 2025
                x$Quarter[i] = 1
                
              
            }}
          
          # Month Loop #
            
            # Month Column #    
            x$Month = " "
            
              for (i in 1:length(x$Month)){
                x$Month[i] = format(x$MONTH[i], "%b")
              }
              for (i in 1:length(x$FM)){
                if(month(x$MONTH[i]) >= 4 & month(x$MONTH[i]) <= 12){
                  x$FM[i] = month(x$MONTH[i]) - 3
                } else if (month(x$MONTH[i]) == 1) {
                  x$FM[i] = 10
                } else if (month(x$MONTH[i]) == 2) {
                  x$FM[i] = 11
                } else if (month(x$MONTH[i]) == 3){
                  x$FM[i] = 12
                }
              }
            
        return(x)    
    }
      

```


Fiscal Year Column Addition for Occupancy Metrics
```{r}

# Individual Compilation #
  Grp1.UM2 = FiscalYear.Columns(Group1.UM)  
  Grp2.UM2 = FiscalYear.Columns(Group2.UM)  
  Grp3.UM2 = FiscalYear.Columns(Group3.UM)
  Grp4.UM2 = FiscalYear.Columns(Group4.UM)
  Grp5.UM2 = FiscalYear.Columns(Group5.UM)
  Grp6.UM2 = FiscalYear.Columns(Group6.UM)
  Grp7.UM2 = FiscalYear.Columns(Group7.UM)
  Grp8.UM2 = FiscalYear.Columns(Group8.UM)
  Grp9.UM2 = FiscalYear.Columns(Group9.UM)
  Grp10.UM2 = FiscalYear.Columns(Group10.UM)
  Grp11.UM2 = FiscalYear.Columns(Group11.UM)
  Grp12.UM2 = FiscalYear.Columns(Group12.UM)
  Grp13.UM2 = FiscalYear.Columns(Group13.UM)
  Grp14.UM2 = FiscalYear.Columns(Group14.UM)
  
  
# Data Frame Conversion for Bind
  Grp1.UM2 = as.data.frame(Grp1.UM2)
  Grp2.UM2 = as.data.frame(Grp2.UM2)
  Grp3.UM2 = as.data.frame(Grp3.UM2)
  Grp4.UM2 = as.data.frame(Grp4.UM2)
  Grp5.UM2 = as.data.frame(Grp5.UM2)
  Grp6.UM2 = as.data.frame(Grp6.UM2)
  Grp7.UM2 = as.data.frame(Grp7.UM2)
  Grp8.UM2 = as.data.frame(Grp8.UM2)
  Grp9.UM2 = as.data.frame(Grp9.UM2)
  Grp10.UM2 = as.data.frame(Grp10.UM2)
  Grp11.UM2 = as.data.frame(Grp11.UM2)
  Grp12.UM2 = as.data.frame(Grp12.UM2)
  Grp13.UM2 = as.data.frame(Grp13.UM2)
  Grp14.UM2 = as.data.frame(Grp14.UM2)
  
# Add Group Column #
  Grp1.UM2$Group = 'FY15 Q4'
  Grp2.UM2$Group = 'FY16 Q1'
  Grp3.UM2$Group = 'FY16 Q2'
  Grp4.UM2$Group = 'FY16 Q3'
  Grp5.UM2$Group = 'FY16 Q4'
  Grp6.UM2$Group = 'FY17 Q1'
  Grp7.UM2$Group = 'FY17 Q2'
  Grp8.UM2$Group = 'FY17 Q3'
  Grp9.UM2$Group = 'FY17 Q4'
  Grp10.UM2$Group = 'FY18 Q1'
  Grp11.UM2$Group = 'FY18 Q2'
  Grp12.UM2$Group = 'FY18 Q3'
  Grp13.UM2$Group = 'FY18 Q4'
  Grp14.UM2$Group = 'FY19 Q1'

  
# Data Frame Conversion for Bind
  Grp1.UM2 = as.data.frame(Grp1.UM2)
  Grp2.UM2 = as.data.frame(Grp2.UM2)
  Grp3.UM2 = as.data.frame(Grp3.UM2)
  Grp4.UM2 = as.data.frame(Grp4.UM2)
  Grp5.UM2 = as.data.frame(Grp5.UM2)
  Grp6.UM2 = as.data.frame(Grp6.UM2)
  Grp7.UM2 = as.data.frame(Grp7.UM2)
  Grp8.UM2 = as.data.frame(Grp8.UM2)
  Grp9.UM2 = as.data.frame(Grp9.UM2)
  Grp10.UM2 = as.data.frame(Grp10.UM2)  
  Grp11.UM2 = as.data.frame(Grp11.UM2)  
  Grp12.UM2 = as.data.frame(Grp12.UM2)  
  Grp13.UM2 = as.data.frame(Grp13.UM2)
  Grp14.UM2 = as.data.frame(Grp14.UM2)  
  
  
# Combine Full Data Frame #  
  UnitMix.Aggregate = bind_rows(Grp1.UM2,
                           Grp2.UM2,
                           Grp3.UM2,
                           Grp4.UM2,
                           Grp5.UM2,
                           Grp6.UM2,
                           Grp7.UM2,
                           Grp8.UM2,
                           Grp9.UM2,
                           Grp10.UM2,
                           Grp11.UM2,
                           Grp12.UM2,
                           Grp13.UM2,
                           Grp14.UM2)
  

# Re-name unm_product column #
  colnames(UnitMix.Aggregate)[3] = 'Product' 
  
  
  UnitMix.Aggregate <- UnitMix.Aggregate %>% arrange(Group, MONTH)
  
  UnitMix.Aggregate %>% 
    group_by(MONTH) %>%
    summarise(Occupancy = sum(Occupied_Rooms) / sum(Total_Rooms))
  
# Count Distinct Profit Centers
   #occ.d.mentity <- distinct(UnitMix.Aggregate$MEntity)
   
   
```



Export Occupancy Metrics

```{r eval=FALSE, include=FALSE}

 write.csv(UnitMix.Aggregate, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\UnitMix_All.csv', append = FALSE)

```



#* Occupancy Predictions *

In this section of the markdown, we will ready forecasted Occupancy data for integration with the dashboard

```{r}


# Extract MEntity number from Aggregate Unit Mix ----
distinct.mentity <-   
UnitMix.Aggregate %>%
  distinct(MEntity)

#write.csv(distinct.mentity, 'Z:\\\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_mentity.csv')
  

# Import Forecasted Occupany Data ----
  forecasted.occ.df <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Occ_Forecast_Data_8162018.csv")


# Filter for unecessary columns ----
  forecasted.occ.df <- forecasted.occ.df[ , c(2, 35:130)]

  # Reformat Data ----
    forecasted.melt <-
      melt(forecasted.occ.df, id.vars = "MEntity")

    forecasted.melt$variable <- as.character(forecasted.melt$variable)
    forecasted.melt$MEntity <- as.character(forecasted.melt$MEntity)
      
    # Replace string patterns ----
      forecasted.melt$variable <-
        gsub(pattern = 'X', replacement = " ", x = forecasted.melt$variable)
    
      forecasted.melt$variable <-
        gsub(pattern = '\\.', replacement = "/", x = forecasted.melt$variable)
      
      # Convert Room "value" column to numeric ----
        forecasted.melt$value <-
          as.numeric(forecasted.melt$value)
      
      # Convert variable column into Date ----
        forecasted.melt$variable <- 
          as.Date(forecasted.melt$variable, format = "%m/%d/%Y")
        
        # Rename Columns for Join ----
          colnames(forecasted.melt)[2] <- "MONTH"
          colnames(forecasted.melt)[3] <- "F.Rooms"
          
          # Extract NA Forecasts
            na.forecast <- 
              forecasted.melt[is.na(forecasted.melt$F.Rooms), ]
              
            # Exctract Unique NA Values
              #unique(na.forecast$MEntity)
          
          # Convert NA to 0 ----
            forecasted.melt$F.Rooms[is.na(forecasted.melt$F.Rooms)] <- 0 # dim = 26,880
            
            
# Check for missing Mentity within the Forecast Database
  #f.mentity <- 
   ## forecasted.melt %>% filter(MEntity %in% distinct.mentity$MEntity)
  
# 92 MEntity Located within the forecast spreadsheet.  There are 6 that remain missing. 
  #f.mentity <- unique(f.mentity$MEntity) # 92 so far.
  
  #write.csv(f.mentity, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\mentity_within_forecast.csv')
          
  
  
```


####*Combination of predictions and Occupany Metrics (Aggregate by MEntity Number)*

```{r eval=FALSE, include=FALSE}


  # Aggregate Data Frames ----
    final.unitmix <- 
      UnitMix.Aggregate %>%
      group_by(MEntity, MONTH) %>%
      summarise(Total_Rooms = sum(Total_Rooms),
                Occupied_Rooms = sum(Occupied_Rooms))

  # Forecasted Units ----
    final.unitmix <- 
      left_join(final.unitmix, forecasted.melt, by = c("MEntity", "MONTH"))

    
  # Addition of FY Columns and Info ----
    final.unitmix <- 
    FiscalYear.Columns(final.unitmix) # 1,402 Rows 


  # Creation of MEntity and Group Key ----
    mentity_n_group_key <- 
      UnitMix.Aggregate %>% 
      select(MEntity, Group) %>%
      group_by(MEntity, Group)
    
    mentity_n_group_key <- 
    unique(mentity_n_group_key[ ,c('MEntity','Group')])  # 99 Rows
    
  # Join Projections ----
   final.unitmix <-
     left_join(final.unitmix, mentity_n_group_key, by = 'MEntity') #1,402 rows. This is aggregating correctly. 
   
  # Replace NA with 0 ----
    final.unitmix$F.Rooms[is.na(final.unitmix$F.Rooms)] <- 0 
   
  # Export Projection Data ----
   write.csv(final.unitmix, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\Forecasted_Units.csv", append = TRUE)
   

   
# Forecasted Amounts ----
  mentity_n_group_key # Data Frame to use in Combination of Forecasted Amounts (From CSV)
  
  # Join on Data Frame ----
    forecasted.df <- 
      left_join(forecasted.melt, mentity_n_group_key, by = 'MEntity') # 269,184 
    
    # Filter For 5 year forecast ----
      Date <- today() + 1825
        
      forecasted.df <- 
        forecasted.df %>%
        filter(MONTH >= '2018-7-1' & MONTH <= Date)
        
      # Remove NA ---- 
        forecasted.df <- forecasted.df[complete.cases(forecasted.df), ]
      
      # Add Fiscal Year / Quarter
        forecasted.df <- FiscalYear.Columns(forecasted.df)
        
        
        # Join Current Total Rooms ----
        Total_Rooms <- 
          UnitMix.Aggregate %>%
            group_by(MEntity) %>% 
            filter(MONTH == '2018-7-1') %>%
            summarise(Total_Rooms = sum(Total_Rooms))
        
        
        # Left Join Total Rooms ----
          forecasted.df <-
          left_join(forecasted.df, Total_Rooms, by = 'MEntity')
        
        # Update column name
          colnames(forecasted.df)[3] <- 'Forecasted_Rooms'
          
          # Filter Month ----
            forecasted.df <-
            forecasted.df %>%
            filter(FY < 2024)
      
        
        # Export Forecasts 
          xlsx::write.xlsx(forecasted.df,
                           "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_rooms_forecast.xls",
                           sheetName = 'Forecasted_Rooms', col.names = TRUE)
      
```


#####*Extract NA Values *

```{r}

 # Missing Projections
  missingdata.f <- 
 unitmix.aggregate.final %>% 
  filter(is.na(F.Rooms)) %>% 
   select(MEntity)

 # distinct.missingdata.f <- 
    unique(missingdata.f)
  
  
  # Export Missing Forecasts ----
    write.csv(distinct.missingdata.f, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Missing_Forecast.csv")

  
```

  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  



