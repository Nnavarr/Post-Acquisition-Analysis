---
title: "Quarterly Acquisitions Report"
author: "Noe Navarro"
date: "July 25, 2018"
output: html_document
---

```{r Library}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)
library(dplyr)
library(dbplyr)
library(R2HTML)
library(CenterIS)

library(supclust)

library(jsonlite)
library(RCurl)


```


SQL Connections

```{r}

con.FinAccounting = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FinAccounting",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)


con.FinAnalysis = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FINANALYSIS",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

  
# Storage Tables ----
  con.Storage = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "Storage",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

      
# Graph MEntity and SAP number combination
  Graph.Entity.Info.Sql <- dplyr::tbl(con.FinAnalysis, "GRAPH_ENTITY_INFO")
    Graph.Entity.Info.Local <- collect(Graph.Entity.Info.Sql)
      colnames(Graph.Entity.Info.Local)[21] <- 'Profit_Center'
        
      
    
```

Table Import

```{r}


# Finaccounting Tables
IS.Trend.Cash = dplyr::tbl(con.FinAccounting, "IS_TREND_CASH")  #Main data for income statement compilation
SAP.Hierarchy = dplyr::tbl(con.FinAccounting, "SAP_Cost_Center_Hierarchy") #SAP Hierarchy Table

# Finanalysis Tables
SAP_Info = dplyr::tbl(con.FinAnalysis, "MENTITY_SAP")# MEntity to SAP number
  SAP.DB = collect(SAP_Info) # Save local copy of MEntity_SAP database
  
    SAP.DB %>% summarise(n_distinct(MEntity)
    )

# Occupancy Table ----  
Occupancy.Table = dplyr::tbl(con.Storage, "WSS_UnitMixUHI_Monthly_Archive")  
    
# Collect SAP Hierarchy
  SAP.Hierarchy <- collect(SAP.Hierarchy)



```


Functions

```{r}

Aggregate.IS <- function(x){

  require(dplyr)
  require(lazyeval)
  require(purrr)

  Income_Statement = IS.Trend.Cash %>% group_by(`MONTH`) %>%
    filter(`PROFIT CENTER` %in% x & MONTH >= '2015-01-01' & MONTH <= '2018-6-01' & SPLIT == 'All' & CURRENCY == 'Group' & `CONTROLLING AREA` == 'UHAL' & `NET OPERATING INCOME` != 0) %>%
    select(`MONTH`,
           `STORAGE INCOME`,
           SALES,
           `SALES - SYSTEM`,
           `COST OF SALES`,
           `COST OF SALES - SYSTEM`,
           `MISCELLANEOUS INCOME`,
           `U-BOX INCOME NET COMMISSION`,
           `U-MOVE NET COMMISSION`,
           `THIRD PARTY RENT/LEASE INCOME`,
           `PERSONNEL EXPENSE`,
           `REPAIRS & MAINTENACE EXPENSE`,
           `UTILITY EXPENSE`,
           `TELEPHONE EXPENSE`,
           `ADVERTISING EXPENSE`,
           SUPPLIES,
           `LEASE EXPENSE - LAND & BLDG`,
           `LIABILITY INSURANCE`,
           `PROPERTY TAX EXPENSE`,
           `BAD DEBT EXPENSE`,
           `OTHER OPERATING EXPENSE`) %>%
    summarize(Storage_Income = sum(`STORAGE INCOME`),
              Sales = sum(`SALES`),
              Sales_System = sum(`SALES - SYSTEM`),
              Cost_of_Sales = sum(`COST OF SALES`),
              Cost_of_Sales_System = sum(`COST OF SALES - SYSTEM`),
              Misc_Income = sum(`MISCELLANEOUS INCOME`),
              UBox_Net = sum(`U-BOX INCOME NET COMMISSION`),
              UMove_Net = sum(`U-MOVE NET COMMISSION`),
              Third_Party_Rent_Lease_Income = sum(`THIRD PARTY RENT/LEASE INCOME`),
              Personnel_Exp = sum(`PERSONNEL EXPENSE`),
              Repairs_and_Maintenance = sum(`REPAIRS & MAINTENACE EXPENSE`),
              Utility_Exp = sum(`UTILITY EXPENSE`),
              Telephone_Exp = sum(`TELEPHONE EXPENSE`),
              Advertising_Exp = sum(`ADVERTISING EXPENSE`),
              Supplies = sum(`SUPPLIES`),
              Lease_Exp = sum(`LEASE EXPENSE - LAND & BLDG`),
              Liab_Insurance = sum(`LIABILITY INSURANCE`),
              Property_Tax = sum(`PROPERTY TAX EXPENSE`),
              Bad_Debt_Exp = sum(`BAD DEBT EXPENSE`),
              Other_Op_Exp = sum(`OTHER OPERATING EXPENSE`))

  Income_Statement.Local = collect(Income_Statement)

  Income_Statement.Local[is.na(Income_Statement.Local)] = 0 #Replace NA values with 0

  ##Updating line##
  Income_Statement.Local = Income_Statement.Local %>%
    mutate(Adj_Sales = Sales - Sales_System,
           Adj_COS = Cost_of_Sales - Cost_of_Sales_System,
           Adj_NetSales = (Sales - Sales_System) + (Cost_of_Sales - Cost_of_Sales_System),
           Op_TotalIncome = Storage_Income + Adj_Sales + Adj_COS + Misc_Income + UBox_Net + UMove_Net + Third_Party_Rent_Lease_Income,
           Op_Expense = Personnel_Exp + Repairs_and_Maintenance + Utility_Exp + Telephone_Exp + Advertising_Exp + Supplies + Lease_Exp + Liab_Insurance +  Property_Tax + Bad_Debt_Exp + Other_Op_Exp,
           OP_NOI = Op_TotalIncome + Op_Expense)

  #Change "Month" to Date
  Income_Statement.Local$MONTH = as.Date(Income_Statement.Local$MONTH)

  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #%% Flip expense signs to positive %%
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  Income_Statement.Local$Cost_of_Sales = -(Income_Statement.Local$Cost_of_Sales)
  Income_Statement.Local$Adj_COS = -(Income_Statement.Local$Adj_COS)
  Income_Statement.Local$Cost_of_Sales_System = -(Income_Statement.Local$Cost_of_Sales_System)
  Income_Statement.Local$Personnel_Exp = -(Income_Statement.Local$Personnel_Exp)
  Income_Statement.Local$Repairs_and_Maintenance = -(Income_Statement.Local$Repairs_and_Maintenance)
  Income_Statement.Local$Utility_Exp = -(Income_Statement.Local$Utility_Exp)
  Income_Statement.Local$Telephone_Exp = -(Income_Statement.Local$Telephone_Exp)
  Income_Statement.Local$Advertising_Exp = -(Income_Statement.Local$Advertising_Exp)
  Income_Statement.Local$Supplies = -(Income_Statement.Local$Supplies)
  Income_Statement.Local$Lease_Exp = -(Income_Statement.Local$Lease_Exp)
  Income_Statement.Local$Liab_Insurance = -(Income_Statement.Local$Liab_Insurance)
  Income_Statement.Local$Property_Tax = -(Income_Statement.Local$Property_Tax)
  Income_Statement.Local$Bad_Debt_Exp = -(Income_Statement.Local$Bad_Debt_Exp)
  Income_Statement.Local$Other_Op_Exp = -(Income_Statement.Local$Other_Op_Exp)
  Income_Statement.Local$Op_Expense = -(Income_Statement.Local$Op_Expense)


  #Melt Dataframe
  melt.data = melt(Income_Statement.Local, id = "MONTH")

  #Fiscal Year / Month Qualifications
  melt.data$FY = ""
  melt.data$FM = " "
  melt.data$Quarter = ""


  #%%%%%%%%%%%%%%%%%%%%%
  #%% FY and Quarter Loop %%
  #%%%%%%%%%%%%%%%%%%%%%

  for (i in 1:length(melt.data$FY)){

    if(melt.data$MONTH[i] >= '2015/1/1' & melt.data$MONTH[i] <= '2015/3/1'){

      melt.data$FY[i] = 2015
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2015/4/1' & melt.data$MONTH[i] <= '2015/6/1') {

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2015/7/1' & melt.data$MONTH[i] <= '2015/9/1') {

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2015/10/1' & melt.data$MONTH[i] <= '2015/12/1'){

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2016/1/1' & melt.data$MONTH[i] <= '2016/3/1'){

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2016/4/1' & melt.data$MONTH[i] <= '2016/6/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2016/7/1' & melt.data$MONTH[i] <= '2016/9/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2016/10/1' & melt.data$MONTH[i] <= '2016/12/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2017/1/1' & melt.data$MONTH[i] <= '2017/3/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2017/4/1' & melt.data$MONTH[i] <= '2017/6/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2017/7/1' & melt.data$MONTH[i] <= '2017/9/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2017/10/1' & melt.data$MONTH[i] <= '2017/12/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2018/1/1' & melt.data$MONTH[i] <= '2018/3/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2018/4/1' & melt.data$MONTH[i] <= '2018/6/1'){

      melt.data$FY[i] = 2019
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2018/7/1' & melt.data$MONTH[i] <= '2018/9/1'){

      melt.data$FY[i] = 2019
      melt.data$Quarter[i] = 2

    }
  }

  #%%%%%%%%%%%%%
  #%% Month Loop %%
  #%%%%%%%%%%%%

  melt.data$Month = " "

  for (i in 1:length(melt.data$Month)){
    melt.data$Month[i] = format(melt.data$MONTH[i], "%b")
  }
  for (i in 1:length(melt.data$FM)){
    if(month(melt.data$MONTH[i]) >= 4 & month(melt.data$MONTH[i]) <= 12){
      melt.data$FM[i] = month(melt.data$MONTH[i]) - 3
    } else if (month(melt.data$MONTH[i]) == 1) {
      melt.data$FM[i] = 10
    } else if (month(melt.data$MONTH[i]) == 2) {
      melt.data$FM[i] = 11
    } else if (month(melt.data$MONTH[i]) == 3){
      melt.data$FM[i] = 12
    }
  }

  #%%%%%%%%%%%%%%%%
  #%% Rename Columns %%
  #%%%%%%%%%%%%%%%%%

  colnames(melt.data) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month")

  return(melt.data)

}


```


```{r Data Check Function}

DataCheck = function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = NA
  }
  return(list.vector)
}


```


```{r}

MonthofOperation.Start = function (x){

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  start_of_record = min(x$MONTH)
  return(start_of_record)
  
}

```


```{r}

na.omit.list <- function(y) {
  return(y[!sapply(y, function(x) all(is.na(x)))])
}

```


```{r}

Property_Owner = function (x){

  #Filter Criteria
  d = SAP.Hierarchy %>% filter(`Cost Center` == x)

  #%Create a local copy of the data frame
  
  b = collect(d)
  c = b$`Hierarchy Area`
  return(c)

  # Rare situations to be aware of
  # In some instances, the Cost center used to filter will actually return two

}

```


```{r}

vector.conv <- function(x){
  x = as.vector(x$Profit_Center)
  x = as.character(x)
}

```


Compilation of New Acquisitions List

```{r}

  # Import New List
    New.Acquisitions <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\New Acquisitions F19 Q1.csv")

    # Rename Column
      colnames(New.Acquisitions)[3] <- "Entity"
      New.Acquisitions$Entity <- as.character(New.Acquisitions$Entity)
      
      
      

  # Import Graph File Data
    Graph.File <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Q1 Graph File.csv", header = TRUE)
      
    Graph.File$Entity <- as.character(Graph.File$Entity)
    Graph.File$MEntity <- as.character(Graph.File$MEntity)
    
  # Import Profit Center from Graph File
    New.Acquisitions = left_join(New.Acquisitions, Graph.Entity.Info.Local[, c(1,3,21)], by = 'Entity')
    New.Acquisitions <- left_join(New.Acquisitions, Graph.File[ , c(1,10)], by = 'Entity') #Import Owner
  
    
    
      # Filter for abutting properties.
        for (i in 1:length(New.Acquisitions$Entity)){
          
          if (grepl("?butting", New.Acquisitions$Property.Description[i]) == TRUE){
            
            New.Acquisitions$Include[i] = 'No'
            
          } else if (grepl("?emote", New.Acquisitions$Property.Description[i]) == TRUE){
            
            New.Acquisitions$Include[i] = "No"
            
            
          } else if (grepl("SAC", New.Acquisitions$Owner[i])){
            
          
            New.Acquisitions$Include[i] = "No"
            
          } else {
            
            New.Acquisitions$Include[i] = "Yes"
        
          }
        }

  
    # Export to CSV
     # write.csv(New.Acquisitions, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\NewAcq_Export.csv")
    

```


Completed Acquisitions Spreadsheet

```{r}

# Spreadsheet Import
  C.Acquisitions = read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Completed_Acquisitions20180725.csv", header = TRUE)
C.Acquisitions

  # TBL conversion
     C.Acquisitions = as.tbl(C.Acquisitions)
     
      C.Acquisitions.Include = C.Acquisitions %>% filter(Include. == 'Yes')
      C.Acquisitions.Exclude = C.Acquisitions %>% filter(Include. == 'No')
      
```


Ensure no Duplicates are included

```{r}

 # Extract Profit Center Column
   C.Acquisitions.Include2 = C.Acquisitions.Include %>% 
                              select(Profit_Center)

   C.Acquisitions.Include2.Complete <-  C.Acquisitions.Include2[!is.na(C.Acquisitions.Include2), ] #  Remove NA Values
   
    # Check for Duplicates
      C.Acquisitions.Include2.Complete %>%
        group_by(Profit_Center) %>%
        mutate(Count = 1) %>%
        summarise(Total = sum(Count)) %>%
        filter(Total > 1)
        
    # Duplicates have been removed.

```





Quarterly Group Compilation

```{r}

# Group Creation
    grp1 = C.Acquisitions.Include %>% filter(Group == 1)
      grp2 = C.Acquisitions.Include %>% filter(Group == 2)
        grp3 = C.Acquisitions.Include %>% filter(Group == 3)
          grp4 = C.Acquisitions.Include %>% filter(Group == 4)
            grp5 = C.Acquisitions.Include %>% filter(Group == 5)
              grp6 = C.Acquisitions.Include %>% filter(Group == 6)
                grp7 = C.Acquisitions.Include %>% filter(Group == 7)
                  grp8 = C.Acquisitions.Include %>% filter(Group == 8)
                    grp9 = C.Acquisitions.Include %>% filter(Group == 9)
                      grp10 = C.Acquisitions.Include %>% filter(Group == 10)
                        grp11 = C.Acquisitions.Include %>% filter(Group == 11)
                          grp12 = C.Acquisitions.Include %>% filter(Group == 12)
                            grp13 = C.Acquisitions.Include %>% filter(Group == 13)
                              grp14 = C.Acquisitions.Include %>% filter(Group == 14)


# Profit Center Selection
  group1.pc = C.Acquisitions.Include %>% filter(Group == 1) %>% select(Profit_Center)
    group1.pc <- unique(group1.pc$Profit_Center)
      group1.pc <- as.character(group1.pc)
    
  
  group2.pc = C.Acquisitions.Include %>% filter(Group == 2) %>% select(Profit_Center)
    group2.pc <- unique(group2.pc$Profit_Center)
      group2.pc <- as.character(group2.pc)
  
  group3.pc = C.Acquisitions.Include %>% filter(Group == 3) %>% select(Profit_Center) 
    group3.pc <- unique(group3.pc$Profit_Center)
      group3.pc <- as.character(group3.pc)
  
  
  group4.pc = C.Acquisitions.Include %>% filter(Group == 4) %>% select(Profit_Center)  
    group4.pc <- unique(group4.pc$Profit_Center)
      group4.pc <- as.character(group4.pc)

  
  group5.pc = C.Acquisitions.Include %>% filter(Group == 5) %>% select(Profit_Center)
    group5.pc <- unique(group5.pc$Profit_Center)
      group5.pc <- as.character(group5.pc)
      
  
  group6.pc = C.Acquisitions.Include %>% filter(Group == 6) %>% select(Profit_Center)
    group6.pc <- unique(group6.pc$Profit_Center)
      group6.pc <- as.character(group6.pc)
  
  
  group7.pc = C.Acquisitions.Include %>% filter(Group == 7) %>% select(Profit_Center)
    group7.pc <- unique(group7.pc$Profit_Center)
      group7.pc <- as.character(group7.pc)
  
  
  
  group8.pc = C.Acquisitions.Include %>% filter(Group == 8) %>% select(Profit_Center)
    group8.pc <- unique(group8.pc$Profit_Center)
      group8.pc <- as.character(group8.pc)
  
  
  group9.pc = C.Acquisitions.Include %>% filter(Group == 9) %>% select(Profit_Center)
    group9.pc <- unique(group9.pc$Profit_Center)
      group9.pc <- as.character(group9.pc)
  
  
  group10.pc = C.Acquisitions.Include %>% filter(Group == 10) %>% select(Profit_Center)
    group10.pc <- unique(group10.pc$Profit_Center)
      group10.pc <- as.character(group10.pc)
  
  
  group11.pc = C.Acquisitions.Include %>% filter(Group == 11) %>% select(Profit_Center)
    group11.pc <- unique(group11.pc$Profit_Center)
      group11.pc <- as.character(group11.pc)
  
  
  group12.pc = C.Acquisitions.Include %>% filter(Group == 12) %>% select(Profit_Center)
    group12.pc <- unique(group12.pc$Profit_Center)
      group12.pc <- as.character(group12.pc)  
  
      
  group13.pc = C.Acquisitions.Include %>% filter(Group ==13) %>% select(Profit_Center)
    group13.pc <- unique(group13.pc$Profit_Center)
      group13.pc <- as.character(group13.pc)  
  
  
  group14.pc = C.Acquisitions.Include %>% filter(Group ==14) %>% select(Profit_Center)
    group14.pc <- unique(group14.pc$Profit_Center)
      group14.pc <- as.character(group14.pc) 
  
  
  
# List Creation
  Quarter.list = list(group1.pc, 
                        group2.pc, 
                        group3.pc, 
                        group4.pc, 
                        group5.pc, 
                        group6.pc, 
                        group7.pc, 
                        group8.pc, 
                        group9.pc, 
                        group10.pc, 
                        group11.pc, 
                        group12.pc,
                        group13.pc,
                        group14.pc)
  
  
 profit.center.vector <- unlist(Quarter.list)
  profit.center.vector <- as.data.frame(profit.center.vector)
   colnames(profit.center.vector) <- "Profit_Center"
    profit.center.vector[!duplicated(profit.center.vector$Profit_Center), ]
 
  
```




# Aggregate Income Statement Compilation

```{r}

# IS Trend Compilation
  aggregateIS.data.list = map(Quarter.list, Aggregate.IS)

# List Separation
  group1.data = aggregateIS.data.list[[1]]
  group2.data = aggregateIS.data.list[[2]]
  group3.data = aggregateIS.data.list[[3]]
  group4.data = aggregateIS.data.list[[4]]
  group5.data = aggregateIS.data.list[[5]]
  group6.data = aggregateIS.data.list[[6]]
  group7.data = aggregateIS.data.list[[7]]
  group8.data = aggregateIS.data.list[[8]]
  group9.data = aggregateIS.data.list[[9]]
  group10.data = aggregateIS.data.list[[10]]
  group11.data = aggregateIS.data.list[[11]]
  group12.data = aggregateIS.data.list[[12]]
  group13.data = aggregateIS.data.list[[13]]
  group14.data = aggregateIS.data.list[[14]]
  
# Group Identifier
  group1.data$Group = 'FY15 Q4'
  group2.data$Group = 'FY16 Q1'
  group3.data$Group = 'FY16 Q2'
  group4.data$Group = 'FY16 Q3'
  group5.data$Group = 'FY16 Q4'
  group6.data$Group = 'FY17 Q1'
  group7.data$Group = 'FY17 Q2'
  group8.data$Group = 'FY17 Q3'
  group9.data$Group = 'FY17 Q4'
  group10.data$Group = 'FY18 Q1'
  group11.data$Group = 'FY18 Q2'
  group12.data$Group = 'FY18 Q3'
  group13.data$Group = 'FY18 Q4'
  group14.data$Group = 'FY19 Q1'

# Combined Data
  Data.Combined = bind_rows(group1.data, 
                      group2.data, 
                      group3.data, 
                      group4.data,
                      group5.data,
                      group6.data,
                      group7.data, 
                      group8.data,
                      group9.data,
                      group10.data, 
                      group11.data, 
                      group12.data,
                      group13.data,
                      group14.data)
  
# Export Data
  write.csv(Data.Combined, 'C:\\Users\\1217543\\OneDrive\\R Projects\\Post Acquisition\\Post-Acquisition-Analysis\\Aggregate_IS_Data.csv')
  
  
# Test CSV Read
 # test <- getURL("https://raw.githubusercontent.com/Nnavarr/Post-Acquisition-Analysis/master/Aggregate_IS_Data.csv?token=AiT95b3R2JF_arMzwrMm1JieduB064cBks5bdfwOwA%3D%3D")
  
  #test.2 <- read.csv(text = test)
  
  
  
# Test on Quarter Snapshot Aggregation
 # quarter.test <- 
  #  Data.Combined %>%
   # dplyr::filter(Group == 'FY15 Q4' & Data.Combined$`Line Item` == 'Storage_Income') %>%
   # dplyr::group_by(`Line Item`, FY, Quarter, Group) %>%
   # dplyr::summarise(Value = sum(Value)) 


   # Matrix Test
    # quarter.matrix <- as.matrix(quarter.test$Value)
       
      # Quarter YoY
      #  df.row <- nrow(quarter.matrix)
        
       # yoy.q <- diff(quarter.matrix, lag = 4)
        
       # (yoy.q[nrow(yoy.q)] /  quarter.test[nrow(quarter.test), 5]) * 100
        
        
  
  
```



#--- Occupancy Metrics ---#

```{r Occupancy Function}

  Occupancy.Calc = function(x){
    d <- Occupancy.Table %>% 
                            filter(x) %>%
                            group_by(unm_timestamp, 
                                     MEntity,
                                     unm_product, 
                                     unm_numunits,
                                     unm_occunits,
                                     unm_damunits,
                                     unm_floor,
                                     unm_elevation,
                                     unm_climate,
                                     unm_rentrate)
    collect(d)
  }


```


```{r}

Occ.Data.Comp.Function = function(x, list.container){
    
    # Filter and select only the profit centers from the individual data frames
    a <- x %>% select(Profit_Center)
    
    # Loop and save each observation in the data frame in a single list row
    for (i in a){
      list.container = i
      i + 1
    }
      
    # List Creation 
      list.container = as.list(list.container)
  
    # Return List 
      return(list.container)
}


```


Occupancy Data List Containers (Needs Updating Every Quarter)

  The update process includes creating a new group category and associated lists. 
  
```{r}

# Container Creation
  grp1.pc.list = list()
  grp2.pc.list = list()
  grp3.pc.list = list()
  grp4.pc.list = list()
  grp5.pc.list = list()
  grp6.pc.list = list()
  grp7.pc.list = list()
  grp8.pc.list = list()
  grp9.pc.list = list()
  grp10.pc.list = list()
  grp11.pc.list = list()
  grp12.pc.list = list()
  grp13.pc.list = list()
  grp14.pc.list = list()
  
```


Occ Data Compilation 
```{r}

# List Compilation by Acquisition Group
  grp1.pc.list = Occ.Data.Comp.Function(grp1, grp1.pc.list) 
    grp2.pc.list = Occ.Data.Comp.Function(grp2, grp2.pc.list)   
      grp3.pc.list = Occ.Data.Comp.Function(grp3, grp3.pc.list) 
        grp4.pc.list = Occ.Data.Comp.Function(grp4, grp4.pc.list) 
          grp5.pc.list = Occ.Data.Comp.Function(grp5, grp5.pc.list) 
            grp6.pc.list = Occ.Data.Comp.Function(grp6, grp6.pc.list) 
              grp7.pc.list = Occ.Data.Comp.Function(grp7, grp7.pc.list) 
                grp8.pc.list = Occ.Data.Comp.Function(grp8, grp8.pc.list) 
                  grp9.pc.list = Occ.Data.Comp.Function(grp9, grp9.pc.list) 
                    grp10.pc.list = Occ.Data.Comp.Function(grp10, grp10.pc.list) 
                      grp11.pc.list = Occ.Data.Comp.Function(grp11, grp11.pc.list) 
                        grp12.pc.list = Occ.Data.Comp.Function(grp12, grp12.pc.list) 
                          grp13.pc.list = Occ.Data.Comp.Function(grp13, grp13.pc.list)
                            grp14.pc.list = Occ.Data.Comp.Function(grp14, grp14.pc.list)
                          
                                                
# Blank Data Check (Verification of Income Statement Data)
  grp1.pc.list1 = map(grp1.pc.list, DataCheck)
    grp1.pc.list2 = unique(na.omit.list(grp1.pc.list1))
    
  grp2.pc.list1 = map(grp2.pc.list, DataCheck)
    grp2.pc.list2 = unique(na.omit.list(grp2.pc.list1))
    
  grp3.pc.list1 = map(grp3.pc.list, DataCheck)
    grp3.pc.list2 = unique(na.omit.list(grp3.pc.list1))
    
  grp4.pc.list1 = map(grp4.pc.list, DataCheck)
    grp4.pc.list2 = unique(na.omit.list(grp4.pc.list1))
    
  grp5.pc.list1 = map(grp5.pc.list, DataCheck)
    grp5.pc.list2 = unique(na.omit.list(grp5.pc.list1))
    
  grp6.pc.list1 = map(grp6.pc.list, DataCheck)
    grp6.pc.list2 = unique(na.omit.list(grp6.pc.list1))
    
  grp7.pc.list1 = map(grp7.pc.list, DataCheck)
    grp7.pc.list2 = unique(na.omit.list(grp7.pc.list1))

  grp8.pc.list1 = map(grp8.pc.list, DataCheck)
    grp8.pc.list2 = unique(na.omit.list(grp8.pc.list1))

  grp9.pc.list1 = map(grp9.pc.list, DataCheck)
    grp9.pc.list2 = unique(na.omit.list(grp9.pc.list1))    
    
  grp10.pc.list1 = map(grp10.pc.list, DataCheck)
    grp10.pc.list2 = unique(na.omit.list(grp10.pc.list1)) 
    
  grp11.pc.list1 = map(grp11.pc.list, DataCheck)
    grp11.pc.list2 = unique(na.omit.list(grp11.pc.list1))
    
  grp12.pc.list1 = map(grp12.pc.list, DataCheck)
    grp12.pc.list2 = unique(na.omit.list(grp12.pc.list1))

  grp13.pc.list1 = map(grp13.pc.list, DataCheck)
    grp13.pc.list2 = unique(na.omit.list(grp13.pc.list1))                          

  grp14.pc.list1 = map(grp14.pc.list, DataCheck)
    grp14.pc.list2 = unique(na.omit.list(grp14.pc.list1))

```


```{r}

# MEntity compilation Function #
  SAP2Mentity = function(x){
    x[[2]] = Graph.Entity.Info.Local  %>% filter(`Profit_Center` == x[1]) %>% select(MEntity)
  }   

# Groups #
  grp1.MEntity = unique(map(grp1.pc.list2, SAP2Mentity))
  grp2.MEntity = unique(map(grp2.pc.list2, SAP2Mentity))
  grp3.MEntity = unique(map(grp3.pc.list2, SAP2Mentity))
  grp4.MEntity = unique(map(grp4.pc.list2, SAP2Mentity))
  grp5.MEntity = unique(map(grp5.pc.list2, SAP2Mentity))
  grp6.MEntity = unique(map(grp6.pc.list2, SAP2Mentity))
  grp7.MEntity = unique(map(grp7.pc.list2, SAP2Mentity))
  grp8.MEntity = unique(map(grp8.pc.list2, SAP2Mentity))
  grp9.MEntity = unique(map(grp9.pc.list2, SAP2Mentity))
  grp10.MEntity = unique(map(grp10.pc.list2, SAP2Mentity))
  grp11.MEntity = unique(map(grp11.pc.list2, SAP2Mentity))
  grp12.MEntity = unique(map(grp12.pc.list2, SAP2Mentity))
  grp13.MEntity = unique(map(grp13.pc.list2, SAP2Mentity))
  grp14.MEntity = unique(map(grp14.pc.list2, SAP2Mentity))

```


```{r Occupancy Data Aggregation}

# Step 3: Occupancy Tables #
  grp1.ME <- unlist(grp1.MEntity)
    grp1.ME <- as.character(grp1.ME)
    
  grp2.ME <- unlist(grp2.MEntity)
      grp2.ME <- as.character(grp2.ME)
    
  grp3.ME <- unlist(grp3.MEntity)
      grp3.ME <- as.character(grp3.ME)
    
  grp4.ME <- unlist(grp4.MEntity)
      grp4.ME = as.character(grp4.ME)
    
  grp5.ME <- unlist(grp5.MEntity)
      grp5.ME = as.character(grp5.ME)
    
  grp6.ME <- unlist(grp6.MEntity)
      grp6.ME = as.character(grp6.ME)
    
  grp7.ME <- unlist(grp7.MEntity)
      grp7.ME = as.character(grp7.ME)
    
  grp8.ME <- unlist(grp8.MEntity)
      grp8.ME = as.character(grp8.ME)
    
  grp9.ME <- unlist(grp9.MEntity)
      grp9.ME = as.character(grp9.ME)
    
  grp10.ME <- unlist(grp10.MEntity)
      grp10.ME = as.character(grp10.ME)

  grp11.ME <- unlist(grp11.MEntity)
      grp11.ME = as.character(grp11.ME)
    
  grp12.ME <- unlist(grp12.MEntity)
      grp12.ME = as.character(grp12.ME)
      
  grp13.ME <- unlist(grp13.MEntity)
      grp13.ME = as.character(grp13.ME)    

  grp14.ME <- unlist(grp14.MEntity)
      grp14.ME = as.character(grp14.ME)         

```


```{r}

# Vector to filter Product Type #
  product.type = c("CONTAINER", "DRIVE UP", "INTERIOR", "SPLIT LEVEL")

  
  # From there, we can calculate our summary fields (Total_SF & Occupied_SF (a sum of these fields respectively)
    grp1.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp1.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    grp2.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp2.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp3.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp3.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp4.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp4.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp5.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp5.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp6.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp6.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp7.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp7.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp8.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp8.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    grp9.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp9.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp10.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp10.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
  
#______________________________________________________________________________________________________________________________________________      
    # As of 3/21/2018 the next two groups are #
   grp11.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp11.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                  group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
   grp12.unitmix = Occupancy.Table %>% 
                  filter(`MEntity` %in% grp12.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)
    
    
    grp13.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp13.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)  
    
    
    grp14.unitmix = Occupancy.Table %>% 
                   filter(`MEntity` %in% grp14.ME & unm_product %in% product.type & Date <= '2018-06-20') %>% 
                   group_by(MEntity, 
                        unm_timestamp, 
                        unm_product) %>%
                   summarize(Total_Rooms = sum(unm_numunits),
                             Occupied_Rooms = sum(unm_occunits)) %>%
                   arrange(unm_timestamp)      
    
  
```


```{r}

# Individual Groups #
  Group1.UM = collect(grp1.unitmix)
  Group2.UM = collect(grp2.unitmix)
  Group3.UM = collect(grp3.unitmix)
  Group4.UM = collect(grp4.unitmix)
  Group5.UM = collect(grp5.unitmix)
  Group6.UM = collect(grp6.unitmix)
  Group7.UM = collect(grp7.unitmix)
  Group8.UM = collect(grp8.unitmix)
  Group9.UM = collect(grp9.unitmix)
  Group10.UM = collect(grp10.unitmix)
  Group11.UM = collect(grp11.unitmix)
  Group12.UM = collect(grp12.unitmix)
  Group13.UM = collect(grp13.unitmix)
  Group14.UM = collect(grp14.unitmix)
  

  # Import Profit Center #
    Group1.UM = left_join(Group1.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group2.UM = left_join(Group2.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group3.UM = left_join(Group3.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group4.UM = left_join(Group4.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group5.UM = left_join(Group5.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group6.UM = left_join(Group6.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group7.UM = left_join(Group7.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group8.UM = left_join(Group8.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group9.UM = left_join(Group9.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group10.UM = left_join(Group10.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group11.UM = left_join(Group11.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group12.UM = left_join(Group12.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group13.UM = left_join(Group13.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    Group14.UM = left_join(Group14.UM, Graph.Entity.Info.Local[ ,c(3,21)], by = 'MEntity')
    
  
  # Re-name Column #
    colnames(Group1.UM)[2] = 'MONTH'
    colnames(Group2.UM)[2] = 'MONTH'
    colnames(Group3.UM)[2] = 'MONTH'
    colnames(Group4.UM)[2] = 'MONTH'
    colnames(Group5.UM)[2] = 'MONTH'
    colnames(Group6.UM)[2] = 'MONTH'
    colnames(Group7.UM)[2] = 'MONTH'
    colnames(Group8.UM)[2] = 'MONTH'
    colnames(Group9.UM)[2] = 'MONTH'
    colnames(Group10.UM)[2] = 'MONTH'
    colnames(Group11.UM)[2] = 'MONTH'
    colnames(Group12.UM)[2] = 'MONTH'
    colnames(Group13.UM)[2] = 'MONTH'
    colnames(Group14.UM)[2] = 'MONTH'
    
  # unm_timestamp #
    # The Date conversion is done here due to how the SQL table pulls through. It comes in as a charcter #
    Group1.UM$MONTH = as.Date(Group1.UM$MONTH)  
    Group2.UM$MONTH = as.Date(Group2.UM$MONTH)
    Group3.UM$MONTH = as.Date(Group3.UM$MONTH)
    Group4.UM$MONTH = as.Date(Group4.UM$MONTH)
    Group5.UM$MONTH = as.Date(Group5.UM$MONTH)
    Group6.UM$MONTH = as.Date(Group6.UM$MONTH)
    Group7.UM$MONTH = as.Date(Group7.UM$MONTH)
    Group8.UM$MONTH = as.Date(Group8.UM$MONTH)
    Group9.UM$MONTH = as.Date(Group9.UM$MONTH)
    Group10.UM$MONTH = as.Date(Group10.UM$MONTH)
    Group11.UM$MONTH = as.Date(Group11.UM$MONTH)
    Group12.UM$MONTH = as.Date(Group12.UM$MONTH)
    Group13.UM$MONTH = as.Date(Group13.UM$MONTH)
    Group14.UM$MONTH = as.Date(Group14.UM$MONTH)
    
  
  # Profit Center to Numeric #  
    Group1.UM$Profit_Center = as.numeric(Group1.UM$Profit_Center)
    Group2.UM$Profit_Center = as.numeric(Group2.UM$Profit_Center)
    Group3.UM$Profit_Center = as.numeric(Group3.UM$Profit_Center)
    Group4.UM$Profit_Center = as.numeric(Group4.UM$Profit_Center)
    Group5.UM$Profit_Center = as.numeric(Group5.UM$Profit_Center)
    Group6.UM$Profit_Center = as.numeric(Group6.UM$Profit_Center)
    Group7.UM$Profit_Center = as.numeric(Group7.UM$Profit_Center)
    Group8.UM$Profit_Center = as.numeric(Group8.UM$Profit_Center)
    Group9.UM$Profit_Center = as.numeric(Group9.UM$Profit_Center)
    Group10.UM$Profit_Center = as.numeric(Group10.UM$Profit_Center)
    Group11.UM$Profit_Center = as.numeric(Group11.UM$Profit_Center)
    Group12.UM$Profit_Center = as.numeric(Group12.UM$Profit_Center)
    Group13.UM$Profit_Center = as.numeric(Group13.UM$Profit_Center)
    Group14.UM$Profit_Center = as.numeric(Group14.UM$Profit_Center)

    
```


Fiscal Year and Group Addition
```{r}

    FiscalYear.Columns = function(x){
      
      x$FY = " "
      x$FM = " "
      x$Quarter = " "
      
        # Fiscal Year Loop # 
      
            for (i in 1:length(x$FY)){
          
              if(x$MONTH[i] >= '2015/1/1' & x$MONTH[i] <= '2015/3/31'){
                
                x$FY[i] = 2015
                x$Quarter[i] = 4
                
              } else if (x$MONTH[i] >= '2015/4/1' & x$MONTH[i] <= '2015/6/30') { 
                
                x$FY[i] = 2016
                x$Quarter[i] = 1
                
              } else if (x$MONTH[i] >= '2015/7/1' & x$MONTH[i] <= '2015/9/30') {
                
                x$FY[i] = 2016
                x$Quarter[i] = 2
                
              } else if (x$MONTH[i] >= '2015/10/1' & x$MONTH[i] <= '2015/12/31'){
               
                x$FY[i] = 2016
                x$Quarter[i] = 3 
                
              } else if (x$MONTH[i] >= '2016/1/1' & x$MONTH[i] <= '2016/3/31'){
                
                x$FY[i] = 2016
                x$Quarter[i] = 4 
                  
              } else if (x$MONTH[i] >= '2016/4/1' & x$MONTH[i] <= '2016/6/30'){
                
                x$FY[i] = 2017
                x$Quarter[i] = 1                 
                
              } else if (x$MONTH[i] >= '2016/7/1' & x$MONTH[i] <= '2016/9/30'){

                x$FY[i] = 2017
                x$Quarter[i] = 2                                 
                
              } else if (x$MONTH[i] >= '2016/10/1' & x$MONTH[i] <= '2016/12/31'){ 
                  
                x$FY[i] = 2017
                x$Quarter[i] = 3                
                
                } else if (x$MONTH[i] >= '2017/1/1' & x$MONTH[i] <= '2017/3/31'){
                  
                x$FY[i] = 2017
                x$Quarter[i] = 4   
                
                } else if (x$MONTH[i] >= '2017/4/1' & x$MONTH[i] <= '2017/6/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 1                    
                  
                } else if (x$MONTH[i] >= '2017/7/1' & x$MONTH[i] <= '2017/9/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 2                  
                  
                } else if (x$MONTH[i] >= '2017/10/1' & x$MONTH[i] <= '2017/12/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 3   
                  
                } else if (x$MONTH[i] >= '2018/1/1' & x$MONTH[i] <= '2018/3/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 4  
                  
                } else if (x$MONTH[i] >= '2018/4/1' & x$MONTH[i] <= '2018/6/30'){     
                  
                x$FY[i] = 2019
                x$Quarter[i] = 1                     
                
                } else if (x$MONTH[i] >= '2018/7/1' & x$MONTH[i] <= '2018/9/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 2                  
          
                }
            }
          
          # Month Loop #
            
            # Month Column #    
            x$Month = " "
            
              for (i in 1:length(x$Month)){
                x$Month[i] = format(x$MONTH[i], "%b")
              }
              for (i in 1:length(x$FM)){
                if(month(x$MONTH[i]) >= 4 & month(x$MONTH[i]) <= 12){
                  x$FM[i] = month(x$MONTH[i]) - 3
                } else if (month(x$MONTH[i]) == 1) {
                  x$FM[i] = 10
                } else if (month(x$MONTH[i]) == 2) {
                  x$FM[i] = 11
                } else if (month(x$MONTH[i]) == 3){
                  x$FM[i] = 12
                }
              }
            
        return(x)    
    }
      

```


Fiscal Year Column Addition for Occupancy Metrics
```{r}

# Individual Compilation #
  Grp1.UM2 = FiscalYear.Columns(Group1.UM)  
  Grp2.UM2 = FiscalYear.Columns(Group2.UM)  
  Grp3.UM2 = FiscalYear.Columns(Group3.UM)
  Grp4.UM2 = FiscalYear.Columns(Group4.UM)
  Grp5.UM2 = FiscalYear.Columns(Group5.UM)
  Grp6.UM2 = FiscalYear.Columns(Group6.UM)
  Grp7.UM2 = FiscalYear.Columns(Group7.UM)
  Grp8.UM2 = FiscalYear.Columns(Group8.UM)
  Grp9.UM2 = FiscalYear.Columns(Group9.UM)
  Grp10.UM2 = FiscalYear.Columns(Group10.UM)
  Grp11.UM2 = FiscalYear.Columns(Group11.UM)
  Grp12.UM2 = FiscalYear.Columns(Group12.UM)
  Grp13.UM2 = FiscalYear.Columns(Group13.UM)
  Grp14.UM2 = FiscalYear.Columns(Group14.UM)
  
  
# Data Frame Conversion for Bind
  Grp1.UM2 = as.data.frame(Grp1.UM2)
  Grp2.UM2 = as.data.frame(Grp2.UM2)
  Grp3.UM2 = as.data.frame(Grp3.UM2)
  Grp4.UM2 = as.data.frame(Grp4.UM2)
  Grp5.UM2 = as.data.frame(Grp5.UM2)
  Grp6.UM2 = as.data.frame(Grp6.UM2)
  Grp7.UM2 = as.data.frame(Grp7.UM2)
  Grp8.UM2 = as.data.frame(Grp8.UM2)
  Grp9.UM2 = as.data.frame(Grp9.UM2)
  Grp10.UM2 = as.data.frame(Grp10.UM2)
  Grp11.UM2 = as.data.frame(Grp11.UM2)
  Grp12.UM2 = as.data.frame(Grp12.UM2)
  Grp13.UM2 = as.data.frame(Grp13.UM2)
  Grp14.UM2 = as.data.frame(Grp14.UM2)
  
# Add Group Column #
  Grp1.UM2$Group = 'FY15 Q4'
  Grp2.UM2$Group = 'FY16 Q1'
  Grp3.UM2$Group = 'FY16 Q2'
  Grp4.UM2$Group = 'FY16 Q3'
  Grp5.UM2$Group = 'FY16 Q4'
  Grp6.UM2$Group = 'FY17 Q1'
  Grp7.UM2$Group = 'FY17 Q2'
  Grp8.UM2$Group = 'FY17 Q3'
  Grp9.UM2$Group = 'FY17 Q4'
  Grp10.UM2$Group = 'FY18 Q1'
  Grp11.UM2$Group = 'FY18 Q2'
  Grp12.UM2$Group = 'FY18 Q3'
  Grp13.UM2$Group = 'FY18 Q4'
  Grp14.UM2$Group = 'FY19 Q1'

  
# Data Frame Conversion for Bind
  Grp1.UM2 = as.data.frame(Grp1.UM2)
  Grp2.UM2 = as.data.frame(Grp2.UM2)
  Grp3.UM2 = as.data.frame(Grp3.UM2)
  Grp4.UM2 = as.data.frame(Grp4.UM2)
  Grp5.UM2 = as.data.frame(Grp5.UM2)
  Grp6.UM2 = as.data.frame(Grp6.UM2)
  Grp7.UM2 = as.data.frame(Grp7.UM2)
  Grp8.UM2 = as.data.frame(Grp8.UM2)
  Grp9.UM2 = as.data.frame(Grp9.UM2)
  Grp10.UM2 = as.data.frame(Grp10.UM2)  
  Grp11.UM2 = as.data.frame(Grp11.UM2)  
  Grp12.UM2 = as.data.frame(Grp12.UM2)  
  Grp13.UM2 = as.data.frame(Grp13.UM2)
  Grp14.UM2 = as.data.frame(Grp14.UM2)  
  
  
# Combine Full Data Frame #  
  UnitMix.Aggregate = bind_rows(Grp1.UM2,
                           Grp2.UM2,
                           Grp3.UM2,
                           Grp4.UM2,
                           Grp5.UM2,
                           Grp6.UM2,
                           Grp7.UM2,
                           Grp8.UM2,
                           Grp9.UM2,
                           Grp10.UM2,
                           Grp11.UM2,
                           Grp12.UM2,
                           Grp13.UM2,
                           Grp14.UM2)
  

# Re-name unm_product column #
  colnames(UnitMix.Aggregate)[3] = 'Product' 
  
  
  UnitMix.Aggregate <- UnitMix.Aggregate %>% arrange(Group, MONTH)
  
  UnitMix.Aggregate %>% 
    group_by(MONTH) %>%
    summarise(Occupancy = sum(Occupied_Rooms) / sum(Total_Rooms))
  
```


Export Occupancy Metrics

```{r}

 write.csv(UnitMix.Aggregate, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\UnitMix.csv', append = FALSE)

```




  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  



