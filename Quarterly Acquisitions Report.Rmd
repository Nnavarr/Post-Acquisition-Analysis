---
title: "Quarterly Acquisitions Report"
author: "Noe Navarro"
date: "July 25, 2018"
output: html_document
---

```{r Library}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)

library(plyr)
library(dplyr)
library(dbplyr)

library(R2HTML)
library(CenterIS)

library(supclust)

library(jsonlite)
library(RCurl)

library(tidyr)
library(data.table)

library(rlist)

library(testthat)

```


## **SQL Connections**

```{r}

# Finaccounting connection ----
con.FinAccounting = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FinAccounting",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Finanalysis connection ----
con.FinAnalysis = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FINANALYSIS",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Storage connection ----
  con.Storage = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "Storage",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# MEntity connection ----      
  con.mentity = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "MEntity",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Graph MEntity and SAP number combination
  Graph.Entity.Info.Sql <- dplyr::tbl(con.FinAnalysis, "GRAPH_ENTITY_INFO")
    Graph.Entity.Info.Local <- collect(Graph.Entity.Info.Sql)
      colnames(Graph.Entity.Info.Local)[21] <- 'Profit_Center'
        
```


## **Import Table**

```{r}

# Finaccounting Tables ----
  IS.Trend.Cash = dplyr::tbl(con.FinAccounting, "IS_TREND_CASH")
  SAP.Hierarchy = dplyr::tbl(con.FinAccounting, "SAP_Cost_Center_Hierarchy") 
  sap_uhi_group <- dplyr::tbl(con.FinAccounting, "SAP_IS_UHAL_GROUP")

# MEntity Tables ----
  SAP_Info = dplyr::tbl(con.mentity, "MENTITY_SAP")
    SAP.DB = collect(SAP_Info)
      SAP.DB %>% summarise(n_distinct(MEntity))

# Occupancy Table ----  
  wss_data <- dplyr::tbl(con.Storage, "WSS_UnitMixUHI_Monthly_Archive")  
  
      
    
# Collect SAP Hierarchy ----
  SAP.Hierarchy <- collect(SAP.Hierarchy)
  colnames(SAP.Hierarchy)[12] <- "Profit_Center"
  
```


## **Accounts**
---

```{r}

# SAP Accounts ----
accounts <-
  read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\income_statement_accounts.csv")


colnames(accounts)[1] <- "SAP_number"


```


## **Functions**
---

### *Date Difference Function*

```{r}

monnb <- function(d) { lt <- as.POSIXlt(as.Date(d, origin = "1900-01-01")); lt$year*12 + lt$mon } 
mondf <- function(d1, d2) { monnb(d2) - monnb(d1) }

```



### *Line Item Function*

```{r}

# Step by Step TEst of Line Item Function ----
line_item_function <- function(x, df){
     
    # x = list of line items 
  
     require(dplyr)
     require(purrr)
     
     # Date Range for missing line items ----
     min_is_month <- min(df$MONTH)
     max_is_month <- as.Date('2018-09-01')
     
     # Line Item IS compilation ----
     line_item_is <- 
       df %>%
       filter(`Line Item` == x[1]) %>%
       group_by(MONTH, `Line Item`) %>%
       summarize(Amount = sum(Amount))
     
     # Calculate date difference ----
     date_diff <- 
       mondf(min_is_month, min(line_item_is$MONTH))
     
     
    # Check for date_diff NA ----
    if(is.na(date_diff) == TRUE){  
     
    full_date <- 
       seq.Date(from = min_is_month, to = max_is_month, by = "month")
     
     full_fill <- 
       as.data.frame(full_date)
     
     # Rename to Month ----
     colnames(full_fill) <- "MONTH"
     
     full_fill$`Line Item` <- as.character(paste(x[1]))
     full_fill$Amount = 0
     
     line_item_is <- as.tbl(full_fill)
     
     # Filter for max date
     line_item_is <-
        line_item_is %>%
        filter(MONTH < '2018-10-01')
     
     
    } else if(date_diff > 0){
     
     
  # Date Difference Logical Flow. 
  # if Date > 0; min Month is lower than Line Item Minimum. We will need to fill in the remaining dates ---- 

     date_seq <-
     seq.Date(from = min_is_month, to = min(line_item_is$MONTH) - 1, by = "month")
   
     fill_df <-
     as.data.frame(date_seq)
   
    # Rename column ----
     colnames(fill_df) <- "MONTH"
     
     fill_df$`Line Item` <- paste(x[1])
     fill_df$Amount = 0
   
    # Bind Dataframes ----
     line_item_is <-
       bind_rows(fill_df, line_item_is)
     
     # tbl conversion ----
     line_item_is <- as.tbl(line_item_is)
     
      # Filter for max date ----
      line_item_is <-
        line_item_is %>%
        filter(MONTH < '2018-10-01')
     
    } else if(date_diff == 0){
    
      line_item_is <- as.tbl(line_item_is)
      
      # Filter for max date ----
      line_item_is <-
        line_item_is %>%
        filter(MONTH < '2018-10-01')
      
    }
  
     
     return(line_item_is)
     
}


```



### *Aggregate Income Statement*

```{r}

income_statment_compilation <- function(x, accounts){
  
  # x = list of profit centers 
  # accounts = sap accounts to be used 
  
  require(dplyr)
  require(lazyeval)
  require(purrr)
  require(reshape2)
  
  # ------------------------------------------------
  # Step 1: Filter for Profit Center & Account List 
  # ------------------------------------------------
  
  # Filter SQL Database  & Collect ----
  db <-
  sap_uhi_group %>% 
    filter(`PROFIT CENTER` %in% x & 
             ACCOUNT %in% accounts &
             `Fiscal Year` >= 2015)
  
    db <- collect(db)
    
    db$`PROFIT CENTER` <- as.character(db$`PROFIT CENTER`)
    db$ACCOUNT <- as.character(db$ACCOUNT)
  
# Reformat database ----
colnames(db)[11] <- 4
colnames(db)[12] <- 5
colnames(db)[13] <- 6
colnames(db)[14] <- 7
colnames(db)[15] <- 8
colnames(db)[16] <- 9
colnames(db)[17] <- 10
colnames(db)[18] <- 11
colnames(db)[19] <- 12
colnames(db)[20] <- 1
colnames(db)[21] <- 2
colnames(db)[22] <- 3
  

  # Eliminate Unecessary columns ----
  db <-
    db[ , -c(1,3,4,5,9,10,23,24,26,27)]

    db <- 
      melt(db, id = c('PROFIT CENTER', "MEntity", "ACCOUNT", "DESCRIPTION", "Fiscal Year"))
    
# Rename columns ----
colnames(db)[3] <-  "SAP_number"   
colnames(db)[7] <- "Amount"
colnames(db)[6] <- "Cal_Month"

  db$Cal_Month <- as.character(db$Cal_Month)
  db$Cal_Month <- as.numeric(db$Cal_Month)
  db$SAP_number <- as.character(db$SAP_number)

# Creation of Calendar "MONTH" column ----
db$Cal_Year = " "

for (i in 1:length(db$`PROFIT CENTER`)){
  
  if(db$Cal_Month[i] >= 4 & db$Cal_Month[i] <= 12){
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] - 1
    
  } else {
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] 
    
  }
  
}

 # MONTH column update ----  
 db$MONTH <- 
   paste(db$Cal_Year, db$Cal_Month, 1, sep = "-")
  
   db$MONTH <- as.Date(db$MONTH, format = "%Y-%m-%d") 
   
   
   # Convert Chart of Accounts "SAP_Number" into character ----
   chart_of_accounts$SAP_number <- as.character(chart_of_accounts$SAP_number)
   
    
  # Compilation of income statement ----
  db <-
    left_join(db, chart_of_accounts[ ,c(1,4)], by = "SAP_number")
   
    colnames(db)[10] <- "Line Item"
    
    

#------------------------------------------
# Step 2: Individual Line Item Compilation
# -----------------------------------------
  
  # This step will ensure all Line Items and Months are represented within the income statement for NOI calculation. If they are not, dedault value = 0
  line_item <- 
    lapply(line_item_list, line_item_function, df = db)

  # Collapse List of Data Frames into 1 ----
  aggregate_df <-
    ldply(line_item, as.data.frame)
    
    
  # Reversal of Line Item Signs ----
    for(i in 1:length(aggregate_df$`Line Item`)){
    
    if(aggregate_df$`Line Item`[i] == 'STORAGE INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'SALES'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'MISCELLANEOUS INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'U-BOX'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
    
      
    } else if(aggregate_df$`Line Item`[i] == 'U-MOVE NET COMMISSION'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'INTERCOMPANY LEASE'){  
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1 
      
    }
    
  }
    

# -------------------------
# Step 3: Horizontal Format
# -------------------------
    
 # Convert to horizontal format ----
 aggregate_df <- 
     tidyr::spread(aggregate_df, `Line Item`, Amount)
 
   # Replace NA with 0 ----
   aggregate_df[is.na(aggregate_df)] <- 0          
  
   # Calculate NOI ----
  aggregate_df <-  
   aggregate_df %>%
      mutate(NOI =
               `STORAGE INCOME` +
               `SALES` -
               `COST OF SALES` +
               `MISCELLANEOUS INCOME` +
               `U-BOX` +
               `U-MOVE NET COMMISSION` +
               `INTERCOMPANY LEASE` -
               `PERSONNEL` -
               `REPAIRS AND MAINTENANCE/GENERAL` -
               `UTILITIES` -
               `TELEPHONE` -
               `ADVERTISING` -
               `SUPPLIES` -
               `RENT-EQUIPMENT/LAND AND BLDGS` -
               `LIABILITY INSURANCE` - 
               `PROPERTY TAX` -
               `BAD DEBT EXPENSE` -
               `OTHER OPERATING EXPENSE`
               )
    
  # Rename for ease of function ----
  db <- aggregate_df  
    
    # Trim for NOI != 0 (eliminate blank rows from income statement) ----
    db <-
      db %>% 
      filter(NOI != 0)
    
  # Melt back to vertical format ----
 db <-
   melt(db, id = c("MONTH"))
    
    
# Import Fiscal Year Columns ----
  db$FY = " "
  db$FM = " "
  db$Quarter = " "
   
  
  for (i in 1:length(db$FY)){

    if(db$MONTH[i] >= '2015/1/1' & db$MONTH[i] <= '2015/3/1'){

      db$FY[i] = 2015
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2015/4/1' & db$MONTH[i] <= '2015/6/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2015/7/1' & db$MONTH[i] <= '2015/9/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2015/10/1' & db$MONTH[i] <= '2015/12/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2016/1/1' & db$MONTH[i] <= '2016/3/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2016/4/1' & db$MONTH[i] <= '2016/6/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2016/7/1' & db$MONTH[i] <= '2016/9/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2016/10/1' & db$MONTH[i] <= '2016/12/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2017/1/1' & db$MONTH[i] <= '2017/3/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2017/4/1' & db$MONTH[i] <= '2017/6/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2017/7/1' & db$MONTH[i] <= '2017/9/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2017/10/1' & db$MONTH[i] <= '2017/12/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2018/1/1' & db$MONTH[i] <= '2018/3/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2018/4/1' & db$MONTH[i] <= '2018/6/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2018/7/1' & db$MONTH[i] <= '2018/9/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 2

    }
  }
  
  
   # Addition of Month Column ----
   db$Month = " "

  for (i in 1:length(db$Month)){
    db$Month[i] = format(db$MONTH[i], "%b")
  }
  for (i in 1:length(db$FM)){
    if(month(db$MONTH[i]) >= 4 & month(db$MONTH[i]) <= 12){
      db$FM[i] = month(db$MONTH[i]) - 3
    } else if (month(db$MONTH[i]) == 1) {
      db$FM[i] = 10
    } else if (month(db$MONTH[i]) == 2) {
      db$FM[i] = 11
    } else if (month(db$MONTH[i]) == 3){
      db$FM[i] = 12
    }
  }
  
  # Rename Columns ----
  colnames(db) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month") 
    
  return(db)

}


```


```{r}

income_statment_compilation_append <- function(x, accounts){
  
  # x = list of profit centers 
  # accounts = sap accounts to be used 
  
  require(dplyr)
  require(lazyeval)
  require(purrr)
  require(reshape2)
  
  # ------------------------------------------------
  # Step 1: Filter for Profit Center & Account List 
  # ------------------------------------------------
  
  # Filter SQL Database  & Collect ----
  db <-
  sap_uhi_group %>% 
    filter(`PROFIT CENTER` %in% x[["Profit_Center"]] & 
             ACCOUNT %in% accounts &
             `Fiscal Year` >= 2015)
  
    db <- collect(db)
    
    db$`PROFIT CENTER` <- as.character(db$`PROFIT CENTER`)
    db$ACCOUNT <- as.character(db$ACCOUNT)
  
# Reformat database ----
colnames(db)[11] <- 4
colnames(db)[12] <- 5
colnames(db)[13] <- 6
colnames(db)[14] <- 7
colnames(db)[15] <- 8
colnames(db)[16] <- 9
colnames(db)[17] <- 10
colnames(db)[18] <- 11
colnames(db)[19] <- 12
colnames(db)[20] <- 1
colnames(db)[21] <- 2
colnames(db)[22] <- 3
  

  # Eliminate Unecessary columns ----
  db <-
    db[ , -c(1,3,4,5,9,10,23,24,26,27)]

    db <- 
      melt(db, id = c('PROFIT CENTER', "MEntity", "ACCOUNT", "DESCRIPTION", "Fiscal Year"))
    
# Rename columns ----
colnames(db)[3] <-  "SAP_number"   
colnames(db)[7] <- "Amount"
colnames(db)[6] <- "Cal_Month"

  db$Cal_Month <- as.character(db$Cal_Month)
  db$Cal_Month <- as.numeric(db$Cal_Month)
  db$SAP_number <- as.character(db$SAP_number)

# Creation of Calendar "MONTH" column ----
db$Cal_Year = " "

for (i in 1:length(db$`PROFIT CENTER`)){
  
  if(db$Cal_Month[i] >= 4 & db$Cal_Month[i] <= 12){
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] - 1
    
  } else {
    
    db$Cal_Year[i] = db$`Fiscal Year`[i] 
    
  }
  
}

 # MONTH column update ----  
 db$MONTH <- 
   paste(db$Cal_Year, db$Cal_Month, 1, sep = "-")
  
   db$MONTH <- as.Date(db$MONTH, format = "%Y-%m-%d") 
   
   
   # Convert Chart of Accounts "SAP_Number" into character ----
   chart_of_accounts$SAP_number <- as.character(chart_of_accounts$SAP_number)
   
    
  # Compilation of income statement ----
  db <-
    left_join(db, chart_of_accounts[ ,c(1,4)], by = "SAP_number")
   
    colnames(db)[10] <- "Line Item"
    
    

#------------------------------------------
# Step 2: Individual Line Item Compilation
# -----------------------------------------
  
  # This step will ensure all Line Items and Months are represented within the income statement for NOI calculation. If they are not, dedault value = 0
  line_item <- 
    lapply(line_item_list, line_item_function, df = db)

  # Collapse List of Data Frames into 1 ----
  aggregate_df <-
    ldply(line_item, as.data.frame)
    
    
  # Reversal of Line Item Signs ----
    for(i in 1:length(aggregate_df$`Line Item`)){
    
    if(aggregate_df$`Line Item`[i] == 'STORAGE INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'SALES'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'MISCELLANEOUS INCOME'){
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'U-BOX'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
    
      
    } else if(aggregate_df$`Line Item`[i] == 'U-MOVE NET COMMISSION'){
    
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1
      
      
    } else if(aggregate_df$`Line Item`[i] == 'INTERCOMPANY LEASE'){  
      
      aggregate_df$Amount[i] <- aggregate_df$Amount[i] * -1 
      
    }
    
  }
    

# -------------------------
# Step 3: Horizontal Format
# -------------------------
    
 # Convert to horizontal format ----
 aggregate_df <- 
     tidyr::spread(aggregate_df, `Line Item`, Amount)
 
   # Replace NA with 0 ----
   aggregate_df[is.na(aggregate_df)] <- 0          
  
   # Calculate NOI ----
  aggregate_df <-  
   aggregate_df %>%
      mutate(NOI =
               `STORAGE INCOME` +
               `SALES` -
               `COST OF SALES` +
               `MISCELLANEOUS INCOME` +
               `U-BOX` +
               `U-MOVE NET COMMISSION` +
               `INTERCOMPANY LEASE` -
               `PERSONNEL` -
               `REPAIRS AND MAINTENANCE/GENERAL` -
               `UTILITIES` -
               `TELEPHONE` -
               `ADVERTISING` -
               `SUPPLIES` -
               `RENT-EQUIPMENT/LAND AND BLDGS` -
               `LIABILITY INSURANCE` - 
               `PROPERTY TAX` -
               `BAD DEBT EXPENSE` -
               `OTHER OPERATING EXPENSE`
               )
    
  # Rename for ease of function ----
  db <- aggregate_df  
    
    # Trim for NOI != 0 (eliminate blank rows from income statement) ----
    db <-
      db %>% 
      filter(NOI != 0)
    
  # Melt back to vertical format ----
 db <-
   melt(db, id = c("MONTH"))
    
    
# Import Fiscal Year Columns ----
  db$FY = " "
  db$FM = " "
  db$Quarter = " "
   
  
  for (i in 1:length(db$FY)){

    if(db$MONTH[i] >= '2015/1/1' & db$MONTH[i] <= '2015/3/1'){

      db$FY[i] = 2015
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2015/4/1' & db$MONTH[i] <= '2015/6/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2015/7/1' & db$MONTH[i] <= '2015/9/1') {

      db$FY[i] = 2016
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2015/10/1' & db$MONTH[i] <= '2015/12/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2016/1/1' & db$MONTH[i] <= '2016/3/1'){

      db$FY[i] = 2016
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2016/4/1' & db$MONTH[i] <= '2016/6/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2016/7/1' & db$MONTH[i] <= '2016/9/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2016/10/1' & db$MONTH[i] <= '2016/12/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2017/1/1' & db$MONTH[i] <= '2017/3/1'){

      db$FY[i] = 2017
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2017/4/1' & db$MONTH[i] <= '2017/6/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2017/7/1' & db$MONTH[i] <= '2017/9/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 2

    } else if (db$MONTH[i] >= '2017/10/1' & db$MONTH[i] <= '2017/12/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 3

    } else if (db$MONTH[i] >= '2018/1/1' & db$MONTH[i] <= '2018/3/1'){

      db$FY[i] = 2018
      db$Quarter[i] = 4

    } else if (db$MONTH[i] >= '2018/4/1' & db$MONTH[i] <= '2018/6/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 1

    } else if (db$MONTH[i] >= '2018/7/1' & db$MONTH[i] <= '2018/9/1'){

      db$FY[i] = 2019
      db$Quarter[i] = 2

    }
  }
  
  
   # Addition of Month Column ----
   db$Month = " "

  for (i in 1:length(db$Month)){
    db$Month[i] = format(db$MONTH[i], "%b")
  }
  for (i in 1:length(db$FM)){
    if(month(db$MONTH[i]) >= 4 & month(db$MONTH[i]) <= 12){
      db$FM[i] = month(db$MONTH[i]) - 3
    } else if (month(db$MONTH[i]) == 1) {
      db$FM[i] = 10
    } else if (month(db$MONTH[i]) == 2) {
      db$FM[i] = 11
    } else if (month(db$MONTH[i]) == 3){
      db$FM[i] = 12
    }
  }
  
  # Rename Columns ----
  colnames(db) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month") 
  
  # Append List ----
    y <-
      append(x, list(db))
  
  names(y)[[4]] = "Income_Statement"
  
  return(y)

}


```






### *Minimum IS Trend Data Date*

```{r}

month_opertation_start <- function(x) {
  
  require(dplyr)
  require(lazyeval)
  require(purrr)
  
  IS_trend <- income_statment_compilation(x, accounts = sap_accounts$SAP_number)

  min_month <- 
    IS_trend %>%
    filter(`Line Item` == 'NOI' & Value != 0)
  
    min_month <- 
      min(min_month$Date)
  
      return(min_month)

}

```





### **Income Statement Data Check**

```{r Data Check Function}

data_check_na <-
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = NA
  }
  return(list.vector)
}



data_check_flag <- 
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = paste("Error:", paste(x), sep = " ")
  }
  return(list.vector)
}


data_check_center <-
  function(x){
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  #vector of list
  list.vector = list()
  list.complete = list()
  
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
    
  if(nrow(b) > 0){
    list.vector[[i]] = 1
  } else {
    list.complete[[i]] = x
  }
  return(list.complete)
}


```


```{r Nested List Creation}

# Nested list creation
  nested_list_creation <-
  function(x) {
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  list.vector = list()
  
    i = 1
    
    list.vector[[i]] = x
    
  return(list.vector)
    
}

```


### **FY / FM Column Addition (Occupancy Metrics)**

```{r FY n FM Column Creation}

  fiscal_year_columns <- function(x){
      
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
  if(nrow(x) == 0) {
    
    x = NA
  
  } else {
    
      x$FY = " "
      x$FM = " "
      x$Quarter = " "
      
        # Fiscal Year Loop # 
            for (i in 1:length(x$FY)){
          
              if(x$MONTH[i] >= '2015/1/1' & x$MONTH[i] <= '2015/3/31'){
                
                x$FY[i] = 2015
                x$Quarter[i] = 4
                
              } else if (x$MONTH[i] >= '2015/4/1' & x$MONTH[i] <= '2015/6/30') { 
                
                x$FY[i] = 2016
                x$Quarter[i] = 1
                
              } else if (x$MONTH[i] >= '2015/7/1' & x$MONTH[i] <= '2015/9/30') {
                
                x$FY[i] = 2016
                x$Quarter[i] = 2
                
              } else if (x$MONTH[i] >= '2015/10/1' & x$MONTH[i] <= '2015/12/31'){
               
                x$FY[i] = 2016
                x$Quarter[i] = 3 
                
              } else if (x$MONTH[i] >= '2016/1/1' & x$MONTH[i] <= '2016/3/31'){
                
                x$FY[i] = 2016
                x$Quarter[i] = 4 
                  
              } else if (x$MONTH[i] >= '2016/4/1' & x$MONTH[i] <= '2016/6/30'){
                
                x$FY[i] = 2017
                x$Quarter[i] = 1                 
                
              } else if (x$MONTH[i] >= '2016/7/1' & x$MONTH[i] <= '2016/9/30'){

                x$FY[i] = 2017
                x$Quarter[i] = 2                                 
                
              } else if (x$MONTH[i] >= '2016/10/1' & x$MONTH[i] <= '2016/12/31'){ 
                  
                x$FY[i] = 2017
                x$Quarter[i] = 3                
                
                } else if (x$MONTH[i] >= '2017/1/1' & x$MONTH[i] <= '2017/3/31'){
                  
                x$FY[i] = 2017
                x$Quarter[i] = 4   
                
                } else if (x$MONTH[i] >= '2017/4/1' & x$MONTH[i] <= '2017/6/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 1                    
                  
                } else if (x$MONTH[i] >= '2017/7/1' & x$MONTH[i] <= '2017/9/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 2                  
                  
                } else if (x$MONTH[i] >= '2017/10/1' & x$MONTH[i] <= '2017/12/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 3   
                  
                } else if (x$MONTH[i] >= '2018/1/1' & x$MONTH[i] <= '2018/3/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 4  
                  
                } else if (x$MONTH[i] >= '2018/4/1' & x$MONTH[i] <= '2018/6/30'){     
                  
                x$FY[i] = 2019
                x$Quarter[i] = 1                     
                
                } else if (x$MONTH[i] >= '2018/7/1' & x$MONTH[i] <= '2018/9/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 2                  
          
                } else if (x$MONTH[i] >= '2018/10/1' & x$MONTH[i] <= '2018/12/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 3                  
          
                } else if (x$MONTH[i] >= '2019/1/1' & x$MONTH[i] <= '2019/3/31'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 4                
              
                } else if (x$MONTH[i] >= '2019/4/1' & x$MONTH[i] <= '2019/6/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 1                
              
                } else if (x$MONTH[i] >= '2019/7/1' & x$MONTH[i] <= '2019/9/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2019/10/1' & x$MONTH[i] <= '2019/12/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2020/1/1' & x$MONTH[i] <= '2020/3/31'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2020/4/1' & x$MONTH[i] <= '2020/6/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2020/7/1' & x$MONTH[i] <= '2020/9/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2020/10/1' & x$MONTH[i] <= '2020/12/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2021/1/1' & x$MONTH[i] <= '2021/3/31'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 4
              
                } else if (x$MONTH[i] >= '2021/4/1' & x$MONTH[i] <= '2021/6/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 1
              
                } else if (x$MONTH[i] >= '2021/7/1' & x$MONTH[i] <= '2021/9/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 2
              
              
                } else if (x$MONTH[i] >= '2021/10/1' & x$MONTH[i] <= '2021/12/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2022/1/1' & x$MONTH[i] <= '2022/3/31'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2022/4/1' & x$MONTH[i] <= '2022/6/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2022/7/1' & x$MONTH[i] <= '2022/9/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 2
                
                } else if (x$MONTH[i] >= '2022/10/1' & x$MONTH[i] <= '2022/12/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2023/1/1' & x$MONTH[i] <= '2023/3/31'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2023/4/1' & x$MONTH[i] <= '2023/6/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2023/7/1' & x$MONTH[i] <= '2023/9/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2023/10/1' & x$MONTH[i] <= '2023/12/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2024/1/1' & x$MONTH[i] <= '2024/3/31'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2024/4/1' & x$MONTH[i] <= '2024/6/30'){
                  
                x$FY[i] = 2025
                x$Quarter[i] = 1
                
              
            }}
          
          # Month Loop #
            
            # Month Column #    
            x$Month = " "
            
              for (i in 1:length(x$Month)){
                x$Month[i] = format(x$MONTH[i], "%b")
              }
              for (i in 1:length(x$FM)){
                if(month(x$MONTH[i]) >= 4 & month(x$MONTH[i]) <= 12){
                  x$FM[i] = month(x$MONTH[i]) - 3
                } else if (month(x$MONTH[i]) == 1) {
                  x$FM[i] = 10
                } else if (month(x$MONTH[i]) == 2) {
                  x$FM[i] = 11
                } else if (month(x$MONTH[i]) == 3){
                  x$FM[i] = 12
                }
              }
      }
            
        return(x)    
    }

```





### **Omit NA from list**

```{r}

na.omit.list <- function(y) {
  return(y[!sapply(y, function(x) all(is.na(x)))])
}

```


### **Property Owner Function**

```{r}

Property_Owner = function (x){

  #Filter Criteria
  d = SAP.Hierarchy %>% filter(`Cost Center` == x)

  #%Create a local copy of the data frame
  
  b = collect(d)
  c = b$`Hierarchy Area`
  return(c)

  # Rare situations to be aware of
  # In some instances, the Cost center used to filter will actually return two

}

```


### **Vector Conversion Function**

```{r}

vector.conv <- function(x){
  x = as.vector(x$Profit_Center)
  x = as.character(x)
}

```



---
##**Completed Acquisitions Spreadsheet**

```{r}

# Completed acquisitions spreadsheet import ----
  c_acquisitions <- 
  read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Completed_Acquisitions20180725.csv", header = TRUE)

  # completed completed acquisitions tbl conversion ----
    c_acquisitions <- 
      as.tbl(c_acquisitions)

      c_acquisitions_include <- 
        c_acquisitions %>% 
        filter(Include. == 'Yes')
      
        c_acquisitions_exclude <- 
          c_acquisitions %>% 
          filter(Include. == 'No')
      
        
```


```{r Updated Entity List 10/25/2018}

acq_list_final

```



###*Duplicate profit center check*

```{r}

# Extraction of profit center numbers ----
  acq_pc <-
    acq_list_final %>% 
    select(Profit_Center)

  # Removal of NA values ----
    acq_pc <-  
      acq_pc[!is.na(acq_pc), ] 
   
    # Check for duplicate profit centers within completed acquisitions data frame ----
      acq_pc_check <- 
        acq_pc %>%
          group_by(Profit_Center) %>%
          mutate(Count = 1) %>%
          summarise(Total = sum(Count)) %>%
          filter(Total > 1)
      
      # Kill switch if duplicate profit centers are detected; Check 1 ----
        if(length(acq_pc_check$Profit_Center) != 0) {
        
          stop() 
        
        }


```




---
##**Quarterly Group Compilation**
---


Process

1. Import acquisitions list 
2. Isolate unique Profit centers within each quarterly acquisition group
3. Run aggregate Profit Center on aggregate vector set of Unique Profit Centers 


```{r}

# Quarterly acquisition group creation (code improvement) ----

# Split Data Frame into Elements within a list ----
  q_list_container <- 
    split(acq_list_final, f = acq_list_final$Group)

  # Select Unique Profit Center Numbers ----
    profit_center_selection <- function(x){
      
    # Library
      require("dplyr")
      require("lazyeval")
      require("purrr")
        
        # Extract profit center ----
        grp_pc = x %>% 
                   select(Profit_Center)
        
        # Isolate Unique Profit Centers ----
        grp_pc_unique = unique(grp_pc$Profit_Center)
          grp_pc_unique = as.character(grp_pc_unique)
          
      }
    
# Quarter group profit centers by list ----
  quarter_list <- 
    map(q_list_container, profit_center_selection)

# Remove NA from quarter list (this is a safety on the initial )
  quarter_list <- 
    lapply(quarter_list, function(x){x[!is.na(x)]})
  
  
```


###**Check for income statement representation**

```{r}

# Nested profit center list ----
  n_pc_list <- 
    lapply(quarter_list, as.list)

    n_pc_list_2 <-
      modify_depth(n_pc_list, 2, nested_list_creation)
  
    # Missing income statement data ----
      missing_income_statement <- 
       modify_depth(n_pc_list, 2, data_check_center)
    
        missing_is_profit_centers <- 
          unlist(missing_income_statement) # Be careful, the grp number is correct, the index is not
        
          missing_is_profit_centers <- 
            as.data.frame(missing_is_profit_centers)
          
            colnames(missing_is_profit_centers) <- 
              "Profit_Center"
        
        # Missing center information ----
          missing_is_profit_centers <- 
              left_join(missing_is_profit_centers, SAP.Hierarchy[ , c(4, 12, 44)], by = "Profit_Center") 
            
                # The missing centers do not appear to have any MEntity info. 
                  data.table(missing_is_profit_centers)
                  
                    # 7000011179 ; grp 5
                    # 7000011246 ; grp 6 
                    # 7000011204 ; grp 6 
            
    # Complete income statement data ----
      complete_income_statement <- 
        modify_depth(n_pc_list, 2, data_check_na)
                  
        complete_is_profit_centers <- 
          unlist(complete_income_statement)
        
          complete_is_profit_centers <- 
            as.data.frame(complete_is_profit_centers)
          
            complete_is_profit_centers <- 
              as.data.frame(complete_is_profit_centers[!is.na(complete_is_profit_centers)])
            
              colnames(complete_is_profit_centers) <- 
                "Profit_Center" # The data frame will be used to check against a list of occupancy profit centers
          
              # List of Quarterly Acquisitions included in the income statement aggregation ----
                quarterly_acquisitions_list <- 
                  na.omit.list(n_pc_list_2)
            
```


---
##**Aggregate Income Statement Compilation**
---

```{r Aggregate Income Statement Process}

# Income statement compilation ----
  aggregate_income_statement <- map(quarter_list, income_statment_compilation, accounts = sap_accounts$SAP_number)

  # Creation of group identifier table ----
    grp_number <- c(1:15)
    grp_name <- c("FY15 Q4", 
                  "FY16 Q1", 
                  "FY16 Q2",
                  "FY16 Q3",
                  "FY16 Q4",
                  "FY17 Q1",
                  "FY17 Q2",
                  "FY17 Q3",
                  "FY17 Q4",
                  "FY18 Q1",
                  "FY18 Q2", 
                  "FY18 Q3", 
                  "FY18 Q4",
                  "FY19 Q1",
                  "FY19 Q2")
    
    grp_table <- 
      data.frame(grp_number,grp_name)
    
    # Enter grp name identifier ----
      for (i in seq_along(aggregate_income_statement)) { 
        aggregate_income_statement[[i]]$Group = as.character(grp_table$grp_name[i])
      }
    
# Unlist income statement data into a data frame for excel export ----
  income_statement_aggregate <-   
    map_df(aggregate_income_statement, `[`)
    
  # Import group number for Dashboard ----
    colnames(grp_table)[1] <- "Grp_Num"
    colnames(grp_table)[2] <- "Group"
      income_statement_aggregate <-
        left_join(income_statement_aggregate, grp_table, by = 'Group')
      
      # Data type adjustments for export ----
        income_statement_aggregate$FY <- as.numeric(income_statement_aggregate$FY)
        income_statement_aggregate$FM <- as.numeric(income_statement_aggregate$FM)
        income_statement_aggregate$Quarter <- as.numeric(income_statement_aggregate$Quarter)

    # Export Data
      xlsx::write.xlsx(income_statement_aggregate, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\Dashboard Connections\\Income_Statement.xlsx",
                   sheetName = "Income_Statement")
    
      
```


---
##**Occupancy Metric Compilation**##
---

### **Import MEntity Numbers**
  
```{r Import MEntity Numbers}

# MEntity number join on profit center # ----
  sap2mentity <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    mentity = 
      SAP.Hierarchy %>%
        filter(`Profit_Center` %in% x[[1]]) %>%
        select(MEntity)
    
    # Isolates only 1 instance of the MEntity
    mentity2 = mentity[[1]][[1]] 
    
    y =  
      append(x, mentity2)
    
    # Edit name of list elements 
    names(y) <- c("Profit_Center", "MEntity")
    
    return(y)
    
     browser()
    
  }   

  # Import MEntity on profit center list ----
    q_acquisitions_list <-
      modify_depth(quarterly_acquisitions_list, 2, sap2mentity)
    
  # Modify names of outer list ----
  group_names <-
    c('FY15 Q4', 
      'FY16 Q1', 
      'FY16 Q2', 
      'FY16 Q3', 
      'FY16 Q4', 
      'FY17 Q1', 
      'FY17 Q2', 
      'FY17 Q3', 
      'FY17 Q4', 
      'FY18 Q1', 
      'FY18 Q2', 
      'FY18 Q3', 
      'FY18 Q4', 
      'FY19 Q1',
      'F19 Q2')

    names(q_acquisitions_list) <- group_names
  
```


### **Filter Profit Centers without MEntity Numbers**

```{r Filter list test}

# MEntity Filter function ----
nested_list_filter <- function(x, z){

 # z = character string of object to be filtered  
 y = x[[z]]
 return(y)
}

# Test Function (working 9-11-2018)
  # test <-
  # modify_depth(nested_profit_center_list_2, 2, mentity_filter, z = "MEntity")  


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #
# Additional Functions of potential use #
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #

# Remove NA from nested list function ----
  # na_omit_nested_list <- function(x){
    # x[!is.na(x)]
  # }

# Filter NA MEntity from nested list ----
  na_MEntity_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(MEntity))
    
  }
 
  # Extract List Elements where MEntity == NA ---- 
  na_mentity_list <- 
    modify_depth(q_acquisitions_list, 1, na_MEntity_filter)
  
    # Isolate Profit Center Numbers ----
    na_mentity_profit_centers <- 
      unlist(modify_depth(na_mentity_list, 2, nested_list_filter, z = "Profit_Center"))

      # Profit Centers without MEntity numbers. After verification, it turns out these profit centers do not have any income statement data as well. 
        # Further research is needed into these set of centers
          print(data.table(na_mentity_profit_centers))
          

```


### **Occupancy Data Compilation**

```{r}

# Occupancy Function ----
occ_compilation <- function(x){
  
      require("dplyr")
      require("lazyeval")
      require("purrr")
  
# Occ Data 
  occ_df =
    wss_data %>%
      filter(`MEntity` %in% x[["MEntity"]] & unm_product != 'UBOX' & Date <= '2018-09-01') %>% 
      group_by(MEntity,
               Date, 
               unm_product) %>%
      summarize(Total_Rooms = sum(unm_numunits),
                Occupied_Rooms = sum(unm_occunits)) %>%
      arrange(Date)
  
  # Collect Data
  occ_df_local = 
    collect(occ_df)
  
    # Rename Data Column to "MONTH"
      colnames(occ_df_local)[2] <- "MONTH"
    
      # Convert Month Column to Date 
        occ_df_local$MONTH <- as.Date(occ_df_local$MONTH)
        
        # Create Fiscal Year Columns for Data 
          occ_df_local <- 
            fiscal_year_columns(occ_df_local)
        
  # Append List 
    y =
      append(x, list(occ_df_local))
  
  names(y)[[3]] = "Occupancy"
  
  return(y)
  
  browser()
  
}


# Append Occ Data to list ----
  q_acquisitions_list <-
      modify_depth(q_acquisitions_list, 2, occ_compilation)


# Append Income Statement To q_acquisitions_list ----
 # q_acquisitions_list <-
   # modify_depth(q_acquisitions_list, 2, income_statment_compilation_append, accounts = sap_accounts$SAP_number)


  #q_acquisitions_list_19 <-
    #modify_depth(q_acquisitions_list["F19 Q2"], 2, income_statment_compilation_append, accounts = sap_accounts$SAP_number)

```



### ** NA Occupancy MEtrics: Info on NA Occupancy MEntity numbers **

```{r}

# NA Occupancy Metrics ----
  na_Occupancy_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(Occupancy))
    
  }

# Extract Observations with NA Occupancy Metrics ----
  na_occupancy_list <-
    modify_depth(q_acquisitions_list, 1, na_Occupancy_filter)

  # Filter MEntity Numbers for NA Occupancy metrics ----
    profit_centers_na_occ <-
      unlist(modify_depth(na_occupancy_list, 2, nested_list_filter, z = "Profit_Center"))
    
    # Print Vector of profit_centers with NA occupancy ----
      profit_centers_na_occ <-
        as.character(profit_centers_na_occ)

      # Retrieve information regarding profit centers with NA occupancy metrics ----
        na_occupancy_profit_center_info <- 
        SAP.Hierarchy %>%
          filter(Profit_Center %in% profit_centers_na_occ)

        # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #
        # NA Occupancy MEtric MEntity / Profit Centers ---- #
        # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #

        # na_occupancy_profit_center_info          

```



### ** Collapse Occupancy Lists Into Single Data Frames ** 
```{r}
# Initial Collapse of Occupancy Lists ----
occ_only_list <- 
  modify_depth(q_acquisitions_list, 2, nested_list_filter, z = "Occupancy") 

  # Flatten the filtered Occupancy list ----
  flat_occ_list <-
    purrr::flatten(occ_only_list)

  # Omit NA Values ----
  flat_occ_exl_na <- 
    na.omit.list(flat_occ_list)

  # Combine Occupancy Data frame ----
  occ_df <-   
    map_df(flat_occ_exl_na, `[`)

  # Rename Unm_product to "Product" ----
    colnames(occ_df)[3] <- "Product"

    # Group Name and Number Addition ----
    acq_list_final
   
        # Join Group column to occupancy metrics ----
        occ_df <-
          left_join(occ_df, acq_list_final[ , c(1, 8,6)], by = "MEntity")
      
          # Rename group number column ----
          colnames(occ_df)[10] <- 'Grp_Num'
      
          occ_df <- 
            left_join(occ_df, grp_table, by = 'Grp_Num')
            
            # Re-arrange data frame columns to match excel dashboard positions ----
              occ_df <-
                occ_df[ , c(1:9, 12, 11)]
          
          
          
```



### ** Export Occupancy Metrics **

```{r eval=FALSE, include=FALSE}

xlsx::write.xlsx(occ_df, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\Dashboard Connections\\UnitMix.xlsx', 
                  append = FALSE,
                  sheetName = "UnitMix",
                  col.names = TRUE)

```



---
## ** Occupancy Predictions **
---

```{r Forecasted Occ DB connection}

# Forecasted tables use the Finanalysis Database ----
forecasted_occ_db <-dplyr::tbl(con.FinAnalysis, "Storage_Forecast")


```


## *Forecasted Occ Function*

```{r}

forecasted_occ_function <- function(x){
  
  require("dplyr")
  require("lazyeval")
  require("purrr")


# Filter DB ----    
db <-
  forecasted_occ_db %>%
  filter(MEntity %in% x[["MEntity"]]) %>%
  group_by(MEntity,
           FC_Date) %>%
  arrange(FC_Date)
  
  
# Collect Local Version ----
db_local <-
  collect(db)

  # Rename Data Column to "MONTH"
      colnames(db_local)[5] <- "MONTH"
    
      # Convert Month Column to Date 
        db_local$MONTH <- as.Date(db_local$MONTH)
        
        # Create Fiscal Year Columns for Data 
          db_local <- 
            fiscal_year_columns(db_local)

# Append List 
    y =
      append(x, list(db_local))
  
  names(y)[[4]] = "FC_Occ"
  
  return(y)

  
}


# Append Forecasted Occupancy to existing function ----
q_acquisitions_list <-
      modify_depth(q_acquisitions_list, 2, forecasted_occ_function)


# Collapse Forecasted Occupancy into single data frame -----
forecast_only_list <- 
  modify_depth(q_acquisitions_list, 2, nested_list_filter, z = "FC_Occ") 

  # Flatten the filtered Occupancy list ----
  flat_forecast_list <-
    purrr::flatten(forecast_only_list)

  # Omit NA Values ----
  flat_fc_occ_exl_na <- 
    na.omit.list(flat_forecast_list)

  # Combine Occupancy Data frame ----
  fc_occ_df <-   
    map_df(flat_fc_occ_exl_na, `[`)


        # Join Group column to occupancy metrics ----
        fc_occ_df <-
          left_join(fc_occ_df, acq_list_final[ , c(1, 8,6)], by = "MEntity")

          # Rename group number column ----
          colnames(fc_occ_df)[13] <- 'Grp_Num'

          # Left Join -----
          fc_occ_df <- 
            left_join(fc_occ_df, grp_table, by = 'Grp_Num')
            
            # Re-arrange data frame columns to match excel dashboard positions ----
              fc_occ_df <-
                fc_occ_df[ , c(3, 5, 6, 15, 9, 10, 11, 12)]


            # Process to merge total rooms into forecasted data frame ----

               # Join Occ DF for Total Rooms Column -----  7,260 rows 
               occ_df_2 <- 
                 occ_df %>%
                 group_by(MEntity, MONTH) %>%
                 summarize(Total_Rooms = sum(Total_Rooms))
               
               # Return Max Date for Unique MEntity Combination -----
               occ_df_2 <-
                 occ_df_2 %>% 
                   group_by(MEntity) %>%
                   slice(which.max(MONTH))

               # Join ----
               fc_occ_df_2 <-
                 left_join(fc_occ_df, occ_df_2[ , c(1,3)], by = c("MEntity"))
               
                
               # Rename Forecasted Occupancy Column ----
               colnames(fc_occ_df_2)[3] <- "Forecasted_Rooms"
            

```


## *Export forecasted occupancy metrics to excel format* ##
```{r}

xlsx::write.xlsx(fc_occ_df_2,
                           "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_rooms_forecast.xls",
                           sheetName = 'Forecasted_Rooms', col.names = TRUE)



```




# *Extract Observations Missing Forecasts* #
```{r}


# --------------------------------------------------------------------------------------------------------------------------------------------

# Filter for MEntity numbers that contain Occ data but no forecasted Occ data ----

# NA Forecasted Occ Filter ----
  na_fc_occ <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(nrow(FC_Occ) == 0)
  }


# Not NA Occupansy Filter ----
not_NA_occ <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(nrow(Occupancy) > 0 )
  }



# Extract Observations with NA Occupancy Metrics ----
  na_fc_occ_list <-
    modify_depth(q_acquisitions_list, 1, na_fc_occ)

  # Filter for MEntity Numbers that have Occupancy Data but Not Forecasted Occupancy -----
  na_fc_n_occ_list <- 
    modify_depth(na_fc_occ_list, 1, not_NA_occ)


    # Filter MEntity Numbers for NA Occupancy metrics ----
    mentity_missing_fc_occ <-
      unlist(modify_depth(na_fc_n_occ_list, 2, nested_list_filter, z = "MEntity"))


    profitcenter_missing_fc_occ <- 
      unlist(modify_depth(na_fc_n_occ_list, 2, nested_list_filter, z = "Profit_Center"))


    # Print Vector of profit_centers with NA occupancy ----
      mentity_missing_fc_occ <-
        as.character(mentity_missing_fc_occ)

      profitcenter_missing_fc <- 
        as.character(profitcenter_missing_fc_occ)
    
        
        # Information regarding centers missing forecasted data ----
        profitcenter_missing_fc_info <- 
        SAP.Hierarchy %>%
          filter(Profit_Center %in% profitcenter_missing_fc)
      
        # Export to Excel for research ----
        #write.csv(profitcenter_missing_fc_info,"Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\Missing Forecasted Occ\\profitcenter_missing_forecast.csv")
      
      
        #write.csv(mentity_missing_fc_occ, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\Missing Forecasted Occ\\mentity_missing_forecast.csv")
      
      
```




## Old Forecasted Occupancy Compolation ##

In this section of the markdown, we will ready forecasted Occupancy data for integration with the dashboard

```{r eval=FALSE, include=FALSE}


# Extract MEntity number from Aggregate Unit Mix ----
distinct.mentity <-   
UnitMix.Aggregate %>%
  distinct(MEntity)

#write.csv(distinct.mentity, 'Z:\\\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_mentity.csv')
  

# Import Forecasted Occupany Data ----
  forecasted.occ.df <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Occ_Forecast_Data_8162018.csv")


# Filter for unecessary columns ----
  forecasted.occ.df <- forecasted.occ.df[ , c(2, 35:130)]

  # Reformat Data ----
    forecasted.melt <-
      melt(forecasted.occ.df, id.vars = "MEntity")

    forecasted.melt$variable <- as.character(forecasted.melt$variable)
    forecasted.melt$MEntity <- as.character(forecasted.melt$MEntity)
      
    # Replace string patterns ----
      forecasted.melt$variable <-
        gsub(pattern = 'X', replacement = " ", x = forecasted.melt$variable)
    
      forecasted.melt$variable <-
        gsub(pattern = '\\.', replacement = "/", x = forecasted.melt$variable)
      
      # Convert Room "value" column to numeric ----
        forecasted.melt$value <-
          as.numeric(forecasted.melt$value)
      
      # Convert variable column into Date ----
        forecasted.melt$variable <- 
          as.Date(forecasted.melt$variable, format = "%m/%d/%Y")
        
        # Rename Columns for Join ----
          colnames(forecasted.melt)[2] <- "MONTH"
          colnames(forecasted.melt)[3] <- "F.Rooms"
          
          # Extract NA Forecasts
            na.forecast <- 
              forecasted.melt[is.na(forecasted.melt$F.Rooms), ]
              
            # Exctract Unique NA Values
              #unique(na.forecast$MEntity)
          
          # Convert NA to 0 ----
            forecasted.melt$F.Rooms[is.na(forecasted.melt$F.Rooms)] <- 0 # dim = 26,880
            
            
# Check for missing Mentity within the Forecast Database
  #f.mentity <- 
   ## forecasted.melt %>% filter(MEntity %in% distinct.mentity$MEntity)
  
# 92 MEntity Located within the forecast spreadsheet.  There are 6 that remain missing. 
  #f.mentity <- unique(f.mentity$MEntity) # 92 so far.
  
  #write.csv(f.mentity, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\mentity_within_forecast.csv')
          
  
  
```


####*Combination of predictions and Occupany Metrics (Aggregate by MEntity Number)*

```{r eval=FALSE, include=FALSE}


  # Aggregate Data Frames ----
    final.unitmix <- 
      UnitMix.Aggregate %>%
      group_by(MEntity, MONTH) %>%
      summarise(Total_Rooms = sum(Total_Rooms),
                Occupied_Rooms = sum(Occupied_Rooms))

  # Forecasted Units ----
    final.unitmix <- 
      left_join(final.unitmix, forecasted.melt, by = c("MEntity", "MONTH"))

    
  # Addition of FY Columns and Info ----
    final.unitmix <- 
    FiscalYear.Columns(final.unitmix) # 1,402 Rows 


  # Creation of MEntity and Group Key ----
    mentity_n_group_key <- 
      UnitMix.Aggregate %>% 
      select(MEntity, Group) %>%
      group_by(MEntity, Group)
    
    mentity_n_group_key <- 
    unique(mentity_n_group_key[ ,c('MEntity','Group')])  # 99 Rows
    
  # Join Projections ----
   final.unitmix <-
     left_join(final.unitmix, mentity_n_group_key, by = 'MEntity') #1,402 rows. This is aggregating correctly. 
   
  # Replace NA with 0 ----
    final.unitmix$F.Rooms[is.na(final.unitmix$F.Rooms)] <- 0 
   
  # Export Projection Data ----
   write.csv(final.unitmix, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\Forecasted_Units.csv", append = TRUE)
   

   
# Forecasted Amounts ----
  mentity_n_group_key # Data Frame to use in Combination of Forecasted Amounts (From CSV)
  
  # Join on Data Frame ----
    forecasted.df <- 
      left_join(forecasted.melt, mentity_n_group_key, by = 'MEntity') # 269,184 
    
    # Filter For 5 year forecast ----
      Date <- today() + 1825
        
      forecasted.df <- 
        forecasted.df %>%
        filter(MONTH >= '2018-7-1' & MONTH <= Date)
        
      # Remove NA ---- 
        forecasted.df <- forecasted.df[complete.cases(forecasted.df), ]
      
      # Add Fiscal Year / Quarter
        forecasted.df <- FiscalYear.Columns(forecasted.df)
        
        
        # Join Current Total Rooms ----
        Total_Rooms <- 
          UnitMix.Aggregate %>%
            group_by(MEntity) %>% 
            filter(MONTH == '2018-7-1') %>%
            summarise(Total_Rooms = sum(Total_Rooms))
        
        
        # Left Join Total Rooms ----
          forecasted.df <-
          left_join(forecasted.df, Total_Rooms, by = 'MEntity')
        
        # Update column name
          colnames(forecasted.df)[3] <- 'Forecasted_Rooms'
          
          # Filter Month ----
            forecasted.df <-
            forecasted.df %>%
            filter(FY < 2024)
      
        
        # Export Forecasts 
          xlsx::write.xlsx(forecasted.df,
                           "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_rooms_forecast.xls",
                           sheetName = 'Forecasted_Rooms', col.names = TRUE)
      
```


#####*Extract NA Values *

```{r eval=FALSE, include=FALSE}

 # Missing Projections
  missingdata.f <- 
 unitmix.aggregate.final %>% 
  filter(is.na(F.Rooms)) %>% 
   select(MEntity)

 # distinct.missingdata.f <- 
    unique(missingdata.f)
  

  # Export Missing Forecasts ----
    write.csv(distinct.missingdata.f, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Missing_Forecast.csv")

  
```

  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  



