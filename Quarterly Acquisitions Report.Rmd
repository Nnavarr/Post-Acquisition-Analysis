---
title: "Quarterly Acquisitions Report"
author: "Noe Navarro"
date: "July 25, 2018"
output: html_document
---

```{r Library}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)

library(plyr)
library(dplyr)
library(dbplyr)

library(R2HTML)
library(CenterIS)

library(supclust)

library(jsonlite)
library(RCurl)

library(tidyr)
library(data.table)

library(rlist)

library(testthat)

```


## **SQL Connections**

```{r}

# Finaccounting connection ----
con.FinAccounting = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FinAccounting",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Finanalysis connection ----
con.FinAnalysis = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "FINANALYSIS",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Storage connection ----
  con.Storage = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "Storage",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# MEntity connection ----      
  con.mentity = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "MEntity",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)

# Graph MEntity and SAP number combination
  Graph.Entity.Info.Sql <- dplyr::tbl(con.FinAnalysis, "GRAPH_ENTITY_INFO")
    Graph.Entity.Info.Local <- collect(Graph.Entity.Info.Sql)
      colnames(Graph.Entity.Info.Local)[21] <- 'Profit_Center'
        
```


## **Import Table**

```{r}

# Finaccounting Tables ----
  IS.Trend.Cash = dplyr::tbl(con.FinAccounting, "IS_TREND_CASH")
  SAP.Hierarchy = dplyr::tbl(con.FinAccounting, "SAP_Cost_Center_Hierarchy") 

# Finanalysis Tables ----
  SAP_Info = dplyr::tbl(con.mentity, "MENTITY_SAP")
    SAP.DB = collect(SAP_Info)
      SAP.DB %>% summarise(n_distinct(MEntity))

# Occupancy Table ----  
  wss_data = dplyr::tbl(con.Storage, "WSS_UnitMixUHI_Monthly_Archive")  
    
# Collect SAP Hierarchy ----
  SAP.Hierarchy <- collect(SAP.Hierarchy)
  colnames(SAP.Hierarchy)[12] <- "Profit_Center"
  
```


## **Functions**
---

### *Aggregate Income Statement*

```{r}

Aggregate.IS <- function(x){

  require(dplyr)
  require(lazyeval)
  require(purrr)

  Income_Statement = IS.Trend.Cash %>% group_by(`MONTH`) %>%
    filter(`PROFIT CENTER` %in% x & MONTH >= '2015-01-01' & MONTH <= '2018-6-01' & SPLIT == 'All' & CURRENCY == 'Group' & `CONTROLLING AREA` == 'UHAL' & `NET OPERATING INCOME` != 0) %>%
    select(`MONTH`,
           `STORAGE INCOME`,
           SALES,
           `SALES - SYSTEM`,
           `COST OF SALES`,
           `COST OF SALES - SYSTEM`,
           `MISCELLANEOUS INCOME`,
           `U-BOX INCOME NET COMMISSION`,
           `U-MOVE NET COMMISSION`,
           `THIRD PARTY RENT/LEASE INCOME`,
           `PERSONNEL EXPENSE`,
           `REPAIRS & MAINTENACE EXPENSE`,
           `UTILITY EXPENSE`,
           `TELEPHONE EXPENSE`,
           `ADVERTISING EXPENSE`,
           SUPPLIES,
           `LEASE EXPENSE - LAND & BLDG`,
           `LIABILITY INSURANCE`,
           `PROPERTY TAX EXPENSE`,
           `BAD DEBT EXPENSE`,
           `OTHER OPERATING EXPENSE`) %>%
    summarize(Storage_Income = sum(`STORAGE INCOME`),
              Sales = sum(`SALES`),
              Sales_System = sum(`SALES - SYSTEM`),
              Cost_of_Sales = sum(`COST OF SALES`),
              Cost_of_Sales_System = sum(`COST OF SALES - SYSTEM`),
              Misc_Income = sum(`MISCELLANEOUS INCOME`),
              UBox_Net = sum(`U-BOX INCOME NET COMMISSION`),
              UMove_Net = sum(`U-MOVE NET COMMISSION`),
              Third_Party_Rent_Lease_Income = sum(`THIRD PARTY RENT/LEASE INCOME`),
              Personnel_Exp = sum(`PERSONNEL EXPENSE`),
              Repairs_and_Maintenance = sum(`REPAIRS & MAINTENACE EXPENSE`),
              Utility_Exp = sum(`UTILITY EXPENSE`),
              Telephone_Exp = sum(`TELEPHONE EXPENSE`),
              Advertising_Exp = sum(`ADVERTISING EXPENSE`),
              Supplies = sum(`SUPPLIES`),
              Lease_Exp = sum(`LEASE EXPENSE - LAND & BLDG`),
              Liab_Insurance = sum(`LIABILITY INSURANCE`),
              Property_Tax = sum(`PROPERTY TAX EXPENSE`),
              Bad_Debt_Exp = sum(`BAD DEBT EXPENSE`),
              Other_Op_Exp = sum(`OTHER OPERATING EXPENSE`))

  Income_Statement.Local = collect(Income_Statement)

  Income_Statement.Local[is.na(Income_Statement.Local)] = 0 #Replace NA values with 0

  ##Updating line##
  Income_Statement.Local = Income_Statement.Local %>%
    mutate(Adj_Sales = Sales - Sales_System,
           Adj_COS = Cost_of_Sales - Cost_of_Sales_System,
           Adj_NetSales = (Sales - Sales_System) + (Cost_of_Sales - Cost_of_Sales_System),
           Op_TotalIncome = Storage_Income + Adj_Sales + Adj_COS + Misc_Income + UBox_Net + UMove_Net + Third_Party_Rent_Lease_Income,
           Op_Expense = Personnel_Exp + Repairs_and_Maintenance + Utility_Exp + Telephone_Exp + Advertising_Exp + Supplies + Lease_Exp + Liab_Insurance +  Property_Tax + Bad_Debt_Exp + Other_Op_Exp,
           OP_NOI = Op_TotalIncome + Op_Expense)

  #Change "Month" to Date
  Income_Statement.Local$MONTH = as.Date(Income_Statement.Local$MONTH)

  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #%% Flip expense signs to positive %%
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  Income_Statement.Local$Cost_of_Sales = -(Income_Statement.Local$Cost_of_Sales)
  Income_Statement.Local$Adj_COS = -(Income_Statement.Local$Adj_COS)
  Income_Statement.Local$Cost_of_Sales_System = -(Income_Statement.Local$Cost_of_Sales_System)
  Income_Statement.Local$Personnel_Exp = -(Income_Statement.Local$Personnel_Exp)
  Income_Statement.Local$Repairs_and_Maintenance = -(Income_Statement.Local$Repairs_and_Maintenance)
  Income_Statement.Local$Utility_Exp = -(Income_Statement.Local$Utility_Exp)
  Income_Statement.Local$Telephone_Exp = -(Income_Statement.Local$Telephone_Exp)
  Income_Statement.Local$Advertising_Exp = -(Income_Statement.Local$Advertising_Exp)
  Income_Statement.Local$Supplies = -(Income_Statement.Local$Supplies)
  Income_Statement.Local$Lease_Exp = -(Income_Statement.Local$Lease_Exp)
  Income_Statement.Local$Liab_Insurance = -(Income_Statement.Local$Liab_Insurance)
  Income_Statement.Local$Property_Tax = -(Income_Statement.Local$Property_Tax)
  Income_Statement.Local$Bad_Debt_Exp = -(Income_Statement.Local$Bad_Debt_Exp)
  Income_Statement.Local$Other_Op_Exp = -(Income_Statement.Local$Other_Op_Exp)
  Income_Statement.Local$Op_Expense = -(Income_Statement.Local$Op_Expense)


  #Melt Dataframe
  melt.data = melt(Income_Statement.Local, id = "MONTH")

  #Fiscal Year / Month Qualifications
  melt.data$FY = ""
  melt.data$FM = " "
  melt.data$Quarter = ""


  #%%%%%%%%%%%%%%%%%%%%%
  #%% FY and Quarter Loop %%
  #%%%%%%%%%%%%%%%%%%%%%

  for (i in 1:length(melt.data$FY)){

    if(melt.data$MONTH[i] >= '2015/1/1' & melt.data$MONTH[i] <= '2015/3/1'){

      melt.data$FY[i] = 2015
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2015/4/1' & melt.data$MONTH[i] <= '2015/6/1') {

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2015/7/1' & melt.data$MONTH[i] <= '2015/9/1') {

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2015/10/1' & melt.data$MONTH[i] <= '2015/12/1'){

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2016/1/1' & melt.data$MONTH[i] <= '2016/3/1'){

      melt.data$FY[i] = 2016
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2016/4/1' & melt.data$MONTH[i] <= '2016/6/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2016/7/1' & melt.data$MONTH[i] <= '2016/9/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2016/10/1' & melt.data$MONTH[i] <= '2016/12/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2017/1/1' & melt.data$MONTH[i] <= '2017/3/1'){

      melt.data$FY[i] = 2017
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2017/4/1' & melt.data$MONTH[i] <= '2017/6/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2017/7/1' & melt.data$MONTH[i] <= '2017/9/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 2

    } else if (melt.data$MONTH[i] >= '2017/10/1' & melt.data$MONTH[i] <= '2017/12/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 3

    } else if (melt.data$MONTH[i] >= '2018/1/1' & melt.data$MONTH[i] <= '2018/3/1'){

      melt.data$FY[i] = 2018
      melt.data$Quarter[i] = 4

    } else if (melt.data$MONTH[i] >= '2018/4/1' & melt.data$MONTH[i] <= '2018/6/1'){

      melt.data$FY[i] = 2019
      melt.data$Quarter[i] = 1

    } else if (melt.data$MONTH[i] >= '2018/7/1' & melt.data$MONTH[i] <= '2018/9/1'){

      melt.data$FY[i] = 2019
      melt.data$Quarter[i] = 2

    }
  }

  #%%%%%%%%%%%%%
  #%% Month Loop %%
  #%%%%%%%%%%%%

  melt.data$Month = " "

  for (i in 1:length(melt.data$Month)){
    melt.data$Month[i] = format(melt.data$MONTH[i], "%b")
  }
  for (i in 1:length(melt.data$FM)){
    if(month(melt.data$MONTH[i]) >= 4 & month(melt.data$MONTH[i]) <= 12){
      melt.data$FM[i] = month(melt.data$MONTH[i]) - 3
    } else if (month(melt.data$MONTH[i]) == 1) {
      melt.data$FM[i] = 10
    } else if (month(melt.data$MONTH[i]) == 2) {
      melt.data$FM[i] = 11
    } else if (month(melt.data$MONTH[i]) == 3){
      melt.data$FM[i] = 12
    }
  }

  #%%%%%%%%%%%%%%%%
  #%% Rename Columns %%
  #%%%%%%%%%%%%%%%%%

  colnames(melt.data) = c('Date', "Line Item", "Value", "FY", "FM", "Quarter", "Month")

  return(melt.data)

}

```


### **Income Statement Data Check**

```{r Data Check Function}

data_check_na <-
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = NA
  }
  return(list.vector)
}



data_check_flag <- 
  function(x) {

  #%% Check for Data Function %%
  #The function will check for data and return NA if none exists.

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  #vector of list
  list.vector = list()
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
  if(nrow(b) > 0){
    list.vector[[i]] = x
  } else {
    list.vector[[i]] = paste("Error:", paste(x), sep = " ")
  }
  return(list.vector)
}


data_check_center <-
  function(x){
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  #vector of list
  list.vector = list()
  list.complete = list()
  
  i = 1

  #Filter Criteria
  d = IS.Trend.Cash %>% filter(CURRENCY == 'Group' & SPLIT == 'ALL' & `PROFIT CENTER` == x & `NET OPERATING INCOME` != 0) %>% arrange(MONTH)

  #Create a local copy of the data frame
  b = collect(d)
    
  if(nrow(b) > 0){
    list.vector[[i]] = 1
  } else {
    list.complete[[i]] = x
  }
  return(list.complete)
}



```


```{r}

# Nested list creation
  nested_list_creation <-
  function(x) {
    
  require("dplyr")
  require("lazyeval")
  require("purrr")
    
  list.vector = list()
  
    i = 1
    
    list.vector[[i]] = x
    
  return(list.vector)
    
}

```

### **FY / FM Column Addition**

```{r}

  fiscal_year_columns <- function(x){
      
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
  if(nrow(x) == 0) {
    
    x = NA
  
  } else {
    
      x$FY = " "
      x$FM = " "
      x$Quarter = " "
      
        # Fiscal Year Loop # 
            for (i in 1:length(x$FY)){
          
              if(x$MONTH[i] >= '2015/1/1' & x$MONTH[i] <= '2015/3/31'){
                
                x$FY[i] = 2015
                x$Quarter[i] = 4
                
              } else if (x$MONTH[i] >= '2015/4/1' & x$MONTH[i] <= '2015/6/30') { 
                
                x$FY[i] = 2016
                x$Quarter[i] = 1
                
              } else if (x$MONTH[i] >= '2015/7/1' & x$MONTH[i] <= '2015/9/30') {
                
                x$FY[i] = 2016
                x$Quarter[i] = 2
                
              } else if (x$MONTH[i] >= '2015/10/1' & x$MONTH[i] <= '2015/12/31'){
               
                x$FY[i] = 2016
                x$Quarter[i] = 3 
                
              } else if (x$MONTH[i] >= '2016/1/1' & x$MONTH[i] <= '2016/3/31'){
                
                x$FY[i] = 2016
                x$Quarter[i] = 4 
                  
              } else if (x$MONTH[i] >= '2016/4/1' & x$MONTH[i] <= '2016/6/30'){
                
                x$FY[i] = 2017
                x$Quarter[i] = 1                 
                
              } else if (x$MONTH[i] >= '2016/7/1' & x$MONTH[i] <= '2016/9/30'){

                x$FY[i] = 2017
                x$Quarter[i] = 2                                 
                
              } else if (x$MONTH[i] >= '2016/10/1' & x$MONTH[i] <= '2016/12/31'){ 
                  
                x$FY[i] = 2017
                x$Quarter[i] = 3                
                
                } else if (x$MONTH[i] >= '2017/1/1' & x$MONTH[i] <= '2017/3/31'){
                  
                x$FY[i] = 2017
                x$Quarter[i] = 4   
                
                } else if (x$MONTH[i] >= '2017/4/1' & x$MONTH[i] <= '2017/6/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 1                    
                  
                } else if (x$MONTH[i] >= '2017/7/1' & x$MONTH[i] <= '2017/9/30'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 2                  
                  
                } else if (x$MONTH[i] >= '2017/10/1' & x$MONTH[i] <= '2017/12/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 3   
                  
                } else if (x$MONTH[i] >= '2018/1/1' & x$MONTH[i] <= '2018/3/31'){
                  
                x$FY[i] = 2018
                x$Quarter[i] = 4  
                  
                } else if (x$MONTH[i] >= '2018/4/1' & x$MONTH[i] <= '2018/6/30'){     
                  
                x$FY[i] = 2019
                x$Quarter[i] = 1                     
                
                } else if (x$MONTH[i] >= '2018/7/1' & x$MONTH[i] <= '2018/9/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 2                  
          
                } else if (x$MONTH[i] >= '2018/10/1' & x$MONTH[i] <= '2018/12/30'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 3                  
          
                } else if (x$MONTH[i] >= '2019/1/1' & x$MONTH[i] <= '2019/3/31'){
                  
                x$FY[i] = 2019
                x$Quarter[i] = 4                
              
                } else if (x$MONTH[i] >= '2019/4/1' & x$MONTH[i] <= '2019/6/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 1                
              
                } else if (x$MONTH[i] >= '2019/7/1' & x$MONTH[i] <= '2019/9/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2019/10/1' & x$MONTH[i] <= '2019/12/30'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2020/1/1' & x$MONTH[i] <= '2020/3/31'){
                  
                x$FY[i] = 2020
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2020/4/1' & x$MONTH[i] <= '2020/6/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2020/7/1' & x$MONTH[i] <= '2020/9/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2020/10/1' & x$MONTH[i] <= '2020/12/30'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2021/1/1' & x$MONTH[i] <= '2021/3/31'){
                  
                x$FY[i] = 2021
                x$Quarter[i] = 4
              
                } else if (x$MONTH[i] >= '2021/4/1' & x$MONTH[i] <= '2021/6/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 1
              
                } else if (x$MONTH[i] >= '2021/7/1' & x$MONTH[i] <= '2021/9/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 2
              
              
                } else if (x$MONTH[i] >= '2021/10/1' & x$MONTH[i] <= '2021/12/30'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 3
              
                } else if (x$MONTH[i] >= '2022/1/1' & x$MONTH[i] <= '2022/3/31'){
                  
                x$FY[i] = 2022
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2022/4/1' & x$MONTH[i] <= '2022/6/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2022/7/1' & x$MONTH[i] <= '2022/9/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 2
                
                } else if (x$MONTH[i] >= '2022/10/1' & x$MONTH[i] <= '2022/12/30'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2023/1/1' & x$MONTH[i] <= '2023/3/31'){
                  
                x$FY[i] = 2023
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2023/4/1' & x$MONTH[i] <= '2023/6/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 1
                
                } else if (x$MONTH[i] >= '2023/7/1' & x$MONTH[i] <= '2023/9/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 2
              
                } else if (x$MONTH[i] >= '2023/10/1' & x$MONTH[i] <= '2023/12/30'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 3
                
                } else if (x$MONTH[i] >= '2024/1/1' & x$MONTH[i] <= '2024/3/31'){
                  
                x$FY[i] = 2024
                x$Quarter[i] = 4
                
                } else if (x$MONTH[i] >= '2024/4/1' & x$MONTH[i] <= '2024/6/30'){
                  
                x$FY[i] = 2025
                x$Quarter[i] = 1
                
              
            }}
          
          # Month Loop #
            
            # Month Column #    
            x$Month = " "
            
              for (i in 1:length(x$Month)){
                x$Month[i] = format(x$MONTH[i], "%b")
              }
              for (i in 1:length(x$FM)){
                if(month(x$MONTH[i]) >= 4 & month(x$MONTH[i]) <= 12){
                  x$FM[i] = month(x$MONTH[i]) - 3
                } else if (month(x$MONTH[i]) == 1) {
                  x$FM[i] = 10
                } else if (month(x$MONTH[i]) == 2) {
                  x$FM[i] = 11
                } else if (month(x$MONTH[i]) == 3){
                  x$FM[i] = 12
                }
              }
      }
            
        return(x)    
    }

```


### **Month of Operation Start**

```{r}

MonthofOperation.Start = function (x){

  #Library
  require("dplyr")
  require("lazyeval")
  require("purrr") #makes iteration problems easier to solve

  start_of_record = min(x$MONTH)
  return(start_of_record)
  
}

```


### **Omit NA from list**

```{r}

na.omit.list <- function(y) {
  return(y[!sapply(y, function(x) all(is.na(x)))])
}

```


### **Property Owner Function**

```{r}

Property_Owner = function (x){

  #Filter Criteria
  d = SAP.Hierarchy %>% filter(`Cost Center` == x)

  #%Create a local copy of the data frame
  
  b = collect(d)
  c = b$`Hierarchy Area`
  return(c)

  # Rare situations to be aware of
  # In some instances, the Cost center used to filter will actually return two

}

```


### **Vector Conversion Function**

```{r}

vector.conv <- function(x){
  x = as.vector(x$Profit_Center)
  x = as.character(x)
}

```


---
## **New Entity Import**
---

In this section, we will import a list of new acquisitions to be cleaned for integration with our quarterly dashboard. The goal is to combine center information including profit center, MEntity, etc.  

The New Acquisition list is being provided by Michael Kobs

```{r}

# Import New Acquisitions Spreadsheet ----
F19_properties <- 
  readxl::read_xlsx("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\Properties Jason - August FY19.xlsx",
                   sheet = "Properties FY19",
                   range = "A5:J80",
                   col_names = TRUE)

  # Convert Date column to date format ----
  F19_properties$Date <-
    as.Date(F19_properties$Date, format = "%m/%d/%Y")

```


```{r}

# Existing Acq to SAP Hierarchy column conversion ----
#current_acq_df_columns <-
  #c("Property.Name", )

#new_center_data_columns <-
 # c("Description")

```


Existing Acq DF to SAP Hierarchy column conversion

Property.name = Description



##**Compilation of New Acquisitions List**

```{r This section will need to be updated last}

# Import New Acquisitions List ----
  New.Acquisitions <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\New Acquisitions F19 Q1.csv")

  # Rename New.Acquisitions 3rd column to "Entity"  ----
    colnames(New.Acquisitions)[3] <- "Entity"
      New.Acquisitions$Entity <- as.character(New.Acquisitions$Entity)
      
  # Import Graph File Data ----
    Graph.File <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Q1 Graph File.csv", header = TRUE)
      
    Graph.File$Entity <- as.character(Graph.File$Entity)
    Graph.File$MEntity <- as.character(Graph.File$MEntity)
    
  # Import Profit Center from Graph File
    New.Acquisitions = left_join(New.Acquisitions, Graph.Entity.Info.Local[, c(1,3,21)], by = 'Entity')
    New.Acquisitions <- left_join(New.Acquisitions, Graph.File[ , c(1,10)], by = 'Entity') #Import Owner
  
    
    
      # Filter for abutting properties.
        for (i in 1:length(New.Acquisitions$Entity)){
          
          if (grepl("?butting", New.Acquisitions$Property.Description[i]) == TRUE){
            
            New.Acquisitions$Include[i] = 'No'
            
          } else if (grepl("?emote", New.Acquisitions$Property.Description[i]) == TRUE){
            
            New.Acquisitions$Include[i] = "No"
            
            
          } else if (grepl("SAC", New.Acquisitions$Owner[i])){
            
          
            New.Acquisitions$Include[i] = "No"
            
          } else {
            
            New.Acquisitions$Include[i] = "Yes"
        
          }
        }

    # Export to CSV
     # write.csv(New.Acquisitions, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\NewAcq_Export.csv")
  
```

---
##**Completed Acquisitions Spreadsheet**

```{r}

# Completed acquisitions spreadsheet import ----
  c_acquisitions <- 
  read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Completed_Acquisitions20180725.csv", header = TRUE)

  # completed completed acquisitions tbl conversion ----
    c_acquisitions <- 
      as.tbl(c_acquisitions)

      c_acquisitions_include <- 
        c_acquisitions %>% 
        filter(Include. == 'Yes')
      
        c_acquisitions_exclude <- 
          c_acquisitions %>% 
          filter(Include. == 'No')
      
        
```


###*Duplicate profit center check*

```{r}

# c.acquisitions extraction of profit center numbers ----
  c_acquisitions_pc <-
    c_acquisitions_include %>% 
    select(Profit_Center)

  # c.aquisitioins removal of NA values ----
    c_acquisitions_pc_complete <-  
      c_acquisitions_pc[!is.na(c_acquisitions_pc), ] 
   
    # Check for duplicate profit centers within completed acquisitions data frame ----
      duplicate_pc_check_1 <- 
        c_acquisitions_pc_complete %>%
          group_by(Profit_Center) %>%
          mutate(Count = 1) %>%
          summarise(Total = sum(Count)) %>%
          filter(Total > 1)
      
      # Kill switch if duplicate profit centers are detected; Check 1 ----
        if(length(duplicate_pc_check_1$Profit_Center) != 0) {
        
          stop() 
        
        }

```


---
##**Quarterly Group Compilation**
---


Process

1. Import acquisitions list 
2. Isolate unique Profit centers within each quarterly acquisition group
3. Run aggregate Profit Center on aggregate vector set of Unique Profit Centers 


```{r}

# Quarterly acquisition group creation (code improvement) ----

# Split Data Frame into Elements within a list ----
  q_list_container <- 
    split(c_acquisitions_include, f = c_acquisitions_include$Group)

  # Select Unique Profit Center Numbers ----
    profit_center_selection <- function(x){
      
    # Library
      require("dplyr")
      require("lazyeval")
      require("purrr")
        
        # Extract profit center ----
        grp_pc = x %>% 
                   select(Profit_Center)
        
        # Isolate Unique Profit Centers ----
        grp_pc_unique = unique(grp_pc$Profit_Center)
          grp_pc_unique = as.character(grp_pc_unique)
          
      }
    
# Quarter group profit centers by list ----
  quarter_list <- 
    map(q_list_container, profit_center_selection)

# Remove NA from quarter list (this is a safety on the initial )
  quarter_list <- 
    lapply(quarter_list, function(x){x[!is.na(x)]})
  
  
```


###**Check for income statement representation**

```{r}

# Nested profit center list ----
  n_pc_list <- 
    lapply(quarter_list, as.list)

    n_pc_list_2 <-
      modify_depth(n_pc_list, 2, nested_list_creation)
  
    # Missing income statement data ----
      missing_income_statement <- 
       modify_depth(n_pc_list, 2, data_check_center)
    
        missing_is_profit_centers <- 
          unlist(missing_income_statement) # Be careful, the grp number is correct, the index is not
        
          missing_is_profit_centers <- 
            as.data.frame(missing_is_profit_centers)
          
            colnames(missing_is_profit_centers) <- 
              "Profit_Center"
        
        # Missing center information ----
          missing_is_profit_centers <- 
              left_join(missing_is_profit_centers, SAP.Hierarchy[ , c(4, 12, 44)], by = "Profit_Center") 
            
                # The missing centers do not appear to have any MEntity info. 
                  data.table(missing_is_profit_centers)
                  
                    # 7000011179 ; grp 5
                    # 7000011246 ; grp 6 
                    # 7000011204 ; grp 6 
            
    # Complete income statement data ----
      complete_income_statement <- 
        modify_depth(n_pc_list, 2, data_check_na)
                  
        complete_is_profit_centers <- 
          unlist(complete_income_statement)
        
          complete_is_profit_centers <- 
            as.data.frame(complete_is_profit_centers)
          
            complete_is_profit_centers <- 
              as.data.frame(complete_is_profit_centers[!is.na(complete_is_profit_centers)])
            
              colnames(complete_is_profit_centers) <- 
                "Profit_Center" # The data frame will be used to check against a list of occupancy profit centers
          
              # List of Quarterly Acquisitions included in the income statement aggregation ----
                quarterly_acquisitions_list <- 
                  na.omit.list(n_pc_list_2)
            
```


---
##**Aggregate Income Statement Compilation**
---

```{r Aggregate Income Statement Process}

# Income statement compilation ----
  aggregate_income_statement <- map(quarter_list, Aggregate.IS)

  # Creation of group identifier table ----
    grp_number <- c(1:14)
    grp_name <- c("FY15 Q4", 
                  "FY16 Q1", 
                  "FY16 Q2",
                  "FY16 Q3",
                  "FY16 Q4",
                  "FY17 Q1",
                  "FY17 Q2",
                  "FY17 Q3",
                  "FY17 Q4",
                  "FY18 Q1",
                  "FY18 Q2", 
                  "FY18 Q3", 
                  "FY18 Q4",
                  "FY19 Q1")
    
    grp_table <- 
      data.frame(grp_number,grp_name)
    
    # Enter grp name identifier ----
      for (i in seq_along(aggregate_income_statement)) { 
        aggregate_income_statement[[i]]$Group = as.character(grp_table$grp_name[i])
      }
    
# Unlist income statement data into a data frame for excel export ----
  income_statement_aggregate <-   
    map_df(aggregate_income_statement, `[`)
    
  # Import group number for Dashboard ----
    colnames(grp_table)[1] <- "Grp_Num"
    colnames(grp_table)[2] <- "Group"
      income_statement_aggregate <-
        left_join(income_statement_aggregate, grp_table, by = 'Group')
      
      # Data type adjustments for export ----
        income_statement_aggregate$FY <- as.numeric(income_statement_aggregate$FY)
        income_statement_aggregate$FM <- as.numeric(income_statement_aggregate$FM)
        income_statement_aggregate$Quarter <- as.numeric(income_statement_aggregate$Quarter)

    # Export Data
      xlsx::write.xlsx(income_statement_aggregate, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Report Data\\Report42018.xlsx",
                    sheetName = "Report42018")
    
```


---
##**Occupancy Metric Compilation**##
---

### **Import MEntity Numbers**
  
```{r Import MEntity Numbers}

# MEntity number join on profit center # ----
  sap2mentity <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    mentity = 
      SAP.Hierarchy %>%
        filter(`Profit_Center` %in% x[[1]]) %>%
        select(MEntity)
    
    # Isolates only 1 instance of the MEntity
    mentity2 = mentity[[1]][[1]] 
    
    y =  
      append(x, mentity2)
    
    # Edit name of list elements 
    names(y) <- c("Profit_Center", "MEntity")
    
    return(y)
    
     browser()
    
  }   

  # Import MEntity on profit center list ----
    q_acquisitions_list <-
      modify_depth(quarterly_acquisitions_list, 2, sap2mentity)
    
  # Modify names of outer list ----
  group_names <-
    c('FY15 Q4', 'FY16 Q1', 'FY16 Q2', 'FY16 Q3', 'FY16 Q4', 'FY17 Q1', 'FY17 Q2', 'FY17 Q3', 'FY17 Q4', 'FY18 Q1', 'FY18 Q2', 'FY18 Q3', 'FY18 Q4', 'FY19 Q1')

    names(q_acquisitions_list) <- group_names
  
```


### **Filter Profit Centers without MEntity Numbers**

```{r Filter list test}

# MEntity Filter function ----
nested_list_filter <- function(x, z){

 # z = character string of object to be filtered  
 y = x[[z]]
 return(y)
}

# Test Function (working 9-11-2018)
  # test <-
  # modify_depth(nested_profit_center_list_2, 2, mentity_filter, z = "MEntity")  


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #
# Additional Functions of potential use #
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #

# Remove NA from nested list function ----
  # na_omit_nested_list <- function(x){
    # x[!is.na(x)]
  # }

# Filter NA MEntity from nested list ----
  na_MEntity_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(MEntity))
    
  }
 
  # Extract List Elements where MEntity == NA ---- 
  na_mentity_list <- 
    modify_depth(q_acquisitions_list, 1, na_MEntity_filter)
  
    # Isolate Profit Center Numbers ----
    na_mentity_profit_centers <- 
      unlist(modify_depth(na_mentity_list, 2, nested_list_filter, z = "Profit_Center"))

      # Profit Centers without MEntity numbers. After verification, it turns out these profit centers do not have any income statement data as well. 
        # Further research is needed into these set of centers
          print(data.table(na_mentity_profit_centers))
          

```


### **Occupancy Data Compilation**

```{r}

# Occupancy Function ----
occ_compilation <- function(x){
  
      require("dplyr")
      require("lazyeval")
      require("purrr")
  
# Occ Data 
  occ_df =
    occupancy_data %>%
      filter(`MEntity` %in% x[["MEntity"]] & unm_product != 'UBOX' & Date <= '2018-06-01') %>% 
      group_by(MEntity,
               Date, 
               unm_product) %>%
      summarize(Total_Rooms = sum(unm_numunits),
                Occupied_Rooms = sum(unm_occunits)) %>%
      arrange(Date)
  
  # Collect Data
  occ_df_local = 
    collect(occ_df)
  
    # Rename Data Column to "MONTH"
      colnames(occ_df_local)[2] <- "MONTH"
    
      # Convert Month Column to Date 
        occ_df_local$MONTH <- as.Date(occ_df_local$MONTH)
        
        # Create Fiscal Year Columns for Data 
          occ_df_local <- 
            fiscal_year_columns(occ_df_local)
        
  # Append List 
    y =
      append(x, list(occ_df_local))
  
  names(y)[[3]] = "Occupancy"
  
  return(y)
  
  browser()
  
}


# Append Occ Data to list ----
  q_acquisitions_list <-
      modify_depth(q_acquisitions_list, 2, occ_compilation)

```



### ** NA Occupancy MEtrics **

```{r}

# NA Occupancy Metrics ----
  na_Occupancy_filter <- function(x){
    
      require("dplyr")
      require("lazyeval")
      require("purrr")
    
    x %>%
      list.filter(is.na(Occupancy))
    
  }

# Extract Observations with NA Occupancy Metrics ----
  na_occupancy_list <-
    modify_depth(q_acquisitions_list, 1, na_Occupancy_filter)

  # Filter MEntity Numbers for NA Occupancy metrics ----
    profit_centers_na_occ <-
      unlist(modify_depth(na_occupancy_list, 2, nested_list_filter, z = "Profit_Center"))
    
    # Print Vector of profit_centers with NA occupancy ----
      profit_centers_na_occ <-
        as.character(profit_centers_na_occ)

      # Retrieve information regarding profit centers with NA occupancy metrics ----
        na_occupancy_profit_center_info <- 
        SAP.Hierarchy %>%
          filter(Profit_Center %in% profit_centers_na_occ)

        # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #
        # NA Occupancy MEtric MEntity / Profit Centers ---- #
        # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% #

        # na_occupancy_profit_center_info          

```


### ** Collapse Occupancy Lists Into Single Data Frames ** 
```{r}
# Initial Collapse of Occupancy Lists ----
occ_only_list <- 
  modify_depth(q_acquisitions_list, 2, nested_list_filter, z = "Occupancy") 

  # Flatten the filtered Occupancy list ----
  flat_occ_list <-
    purrr::flatten(occ_only_list)

  # Omit NA Values ----
  flat_occ_exl_na <- 
    na.omit.list(flat_occ_list)

  # Combine Occupancy Data frame ----
  occ_df <-   
    map_df(flat_occ_exl_na, `[`)

  # Rename Unm_product to "Product" ----
    colnames(occ_df)[3] <- "Product"

    # Group Name and Number Addition ----
    c_acquisitions_include$Profit_Center <- 
      as.character(c_acquisitions_include$Profit_Center)
    
      grp_dictionary <-
        left_join(c_acquisitions_include, unique(SAP.Hierarchy[ , c(12, 44)]), by = "Profit_Center")
      
        # Join Group column to occupancy metrics ----
        occ_df <-
          left_join(occ_df, grp_dictionary[ , c(24, 1)], by = "MEntity")
      
          # Rename group number column ----
          colnames(occ_df)[10] <- 'Grp_Num'
      
          occ_df <- 
            left_join(occ_df, grp_table, by = 'Grp_Num')
            
            # Re-arrange data frame columns to match excel dashboard positions ----
              occ_df <-
                occ_df[ , c(1:9, 11, 10)]
          
```


### ** Export Occupancy Metrics **

```{r eval=FALSE, include=FALSE}

 xlsx::write.xlsx(occ_df, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\UnitMix.xlsx', 
                  append = FALSE,
                  sheetName = "UnitMix",
                  col.names = TRUE)

```







---
## ** Occupancy Predictions **
---


In this section of the markdown, we will ready forecasted Occupancy data for integration with the dashboard

```{r}


# Extract MEntity number from Aggregate Unit Mix ----
distinct.mentity <-   
UnitMix.Aggregate %>%
  distinct(MEntity)

#write.csv(distinct.mentity, 'Z:\\\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_mentity.csv')
  

# Import Forecasted Occupany Data ----
  forecasted.occ.df <- read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Occ_Forecast_Data_8162018.csv")


# Filter for unecessary columns ----
  forecasted.occ.df <- forecasted.occ.df[ , c(2, 35:130)]

  # Reformat Data ----
    forecasted.melt <-
      melt(forecasted.occ.df, id.vars = "MEntity")

    forecasted.melt$variable <- as.character(forecasted.melt$variable)
    forecasted.melt$MEntity <- as.character(forecasted.melt$MEntity)
      
    # Replace string patterns ----
      forecasted.melt$variable <-
        gsub(pattern = 'X', replacement = " ", x = forecasted.melt$variable)
    
      forecasted.melt$variable <-
        gsub(pattern = '\\.', replacement = "/", x = forecasted.melt$variable)
      
      # Convert Room "value" column to numeric ----
        forecasted.melt$value <-
          as.numeric(forecasted.melt$value)
      
      # Convert variable column into Date ----
        forecasted.melt$variable <- 
          as.Date(forecasted.melt$variable, format = "%m/%d/%Y")
        
        # Rename Columns for Join ----
          colnames(forecasted.melt)[2] <- "MONTH"
          colnames(forecasted.melt)[3] <- "F.Rooms"
          
          # Extract NA Forecasts
            na.forecast <- 
              forecasted.melt[is.na(forecasted.melt$F.Rooms), ]
              
            # Exctract Unique NA Values
              #unique(na.forecast$MEntity)
          
          # Convert NA to 0 ----
            forecasted.melt$F.Rooms[is.na(forecasted.melt$F.Rooms)] <- 0 # dim = 26,880
            
            
# Check for missing Mentity within the Forecast Database
  #f.mentity <- 
   ## forecasted.melt %>% filter(MEntity %in% distinct.mentity$MEntity)
  
# 92 MEntity Located within the forecast spreadsheet.  There are 6 that remain missing. 
  #f.mentity <- unique(f.mentity$MEntity) # 92 so far.
  
  #write.csv(f.mentity, 'Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\mentity_within_forecast.csv')
          
  
  
```


####*Combination of predictions and Occupany Metrics (Aggregate by MEntity Number)*

```{r eval=FALSE, include=FALSE}


  # Aggregate Data Frames ----
    final.unitmix <- 
      UnitMix.Aggregate %>%
      group_by(MEntity, MONTH) %>%
      summarise(Total_Rooms = sum(Total_Rooms),
                Occupied_Rooms = sum(Occupied_Rooms))

  # Forecasted Units ----
    final.unitmix <- 
      left_join(final.unitmix, forecasted.melt, by = c("MEntity", "MONTH"))

    
  # Addition of FY Columns and Info ----
    final.unitmix <- 
    FiscalYear.Columns(final.unitmix) # 1,402 Rows 


  # Creation of MEntity and Group Key ----
    mentity_n_group_key <- 
      UnitMix.Aggregate %>% 
      select(MEntity, Group) %>%
      group_by(MEntity, Group)
    
    mentity_n_group_key <- 
    unique(mentity_n_group_key[ ,c('MEntity','Group')])  # 99 Rows
    
  # Join Projections ----
   final.unitmix <-
     left_join(final.unitmix, mentity_n_group_key, by = 'MEntity') #1,402 rows. This is aggregating correctly. 
   
  # Replace NA with 0 ----
    final.unitmix$F.Rooms[is.na(final.unitmix$F.Rooms)] <- 0 
   
  # Export Projection Data ----
   write.csv(final.unitmix, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\Forecasted_Units.csv", append = TRUE)
   

   
# Forecasted Amounts ----
  mentity_n_group_key # Data Frame to use in Combination of Forecasted Amounts (From CSV)
  
  # Join on Data Frame ----
    forecasted.df <- 
      left_join(forecasted.melt, mentity_n_group_key, by = 'MEntity') # 269,184 
    
    # Filter For 5 year forecast ----
      Date <- today() + 1825
        
      forecasted.df <- 
        forecasted.df %>%
        filter(MONTH >= '2018-7-1' & MONTH <= Date)
        
      # Remove NA ---- 
        forecasted.df <- forecasted.df[complete.cases(forecasted.df), ]
      
      # Add Fiscal Year / Quarter
        forecasted.df <- FiscalYear.Columns(forecasted.df)
        
        
        # Join Current Total Rooms ----
        Total_Rooms <- 
          UnitMix.Aggregate %>%
            group_by(MEntity) %>% 
            filter(MONTH == '2018-7-1') %>%
            summarise(Total_Rooms = sum(Total_Rooms))
        
        
        # Left Join Total Rooms ----
          forecasted.df <-
          left_join(forecasted.df, Total_Rooms, by = 'MEntity')
        
        # Update column name
          colnames(forecasted.df)[3] <- 'Forecasted_Rooms'
          
          # Filter Month ----
            forecasted.df <-
            forecasted.df %>%
            filter(FY < 2024)
      
        
        # Export Forecasts 
          xlsx::write.xlsx(forecasted.df,
                           "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Report Data\\occ_rooms_forecast.xls",
                           sheetName = 'Forecasted_Rooms', col.names = TRUE)
      
```


#####*Extract NA Values *

```{r}

 # Missing Projections
  missingdata.f <- 
 unitmix.aggregate.final %>% 
  filter(is.na(F.Rooms)) %>% 
   select(MEntity)

 # distinct.missingdata.f <- 
    unique(missingdata.f)
  
  
  # Export Missing Forecasts ----
    write.csv(distinct.missingdata.f, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Occupancy Forecast\\Missing_Forecast.csv")

  
```

  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  



