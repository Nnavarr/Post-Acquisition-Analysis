---
title: "Post Acquisition Analysis"
author: "Noe Navarro"
date: "July 31, 2018"
output: html_document
---

In this markdown, we will explore a method for showing the difference in Forecasted Acquisition values and Historical performance. The process is as follows: 

1) Determine Acquisition Costs ($ by group)
2) Combine the Income Statement produced in the previous write down
3) Import Forecasted Models 


```{r Library}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)
library(dplyr)
library(dbplyr)
library(R2HTML)
library(CenterIS)

library(supclust)   


library(PerformanceAnalytics)

library(tidyquant)

```



1) Import Acquisition Groups

```{r}

# Import Acquisitions Spreadsheet -----
  C.Acquisitions.Include2.Complete # Database of Profit Centers to include. Used to filter Acquisition Data. 245 Unique PC

 # Filter by Acquisitions to be included ----
  Acquisition.Data <- 
   C.Acquisitions %>%
     filter(Profit_Center %in% C.Acquisitions.Include2.Complete$Profit_Center) # 267 total Rows (Duplicates intorduced)

 # Purchase Price Conversion to Numeric ----
   Acquisition.Data$Purchase.Price <- as.character(Acquisition.Data$Purchase.Price) # Done first to ensure correct conversion.
   Acquisition.Data$Purchase.Price <- as.numeric(Acquisition.Data$Purchase.Price) 

 # Group by Profit Center ----
  Acq.by.PC <-  
   Acquisition.Data %>%
    group_by(Profit_Center, Group) %>%
    summarise(Cost = sum(Purchase.Price))
   
    Acq.by.PC$Profit_Center <- as.character(Acq.by.PC$Profit_Center) # Character Conversion
   

 # Distinct Acquisitions ----
   unique.acq.by.grp <- 
     Acq.by.PC[!duplicated(Acq.by.PC$Profit_Center), ]
    
    # There is one center 7000011224 from grp 6 that does not contain an acquisition cost.
    
 # Total Acq Cost by Grp ----
  summary.acq.cost <- 
   unique.acq.by.grp %>%
      group_by(Group) %>%
      summarise(Cost = sum(Cost, na.rm = TRUE))
    
 # Change column names ----
    colnames(summary.acq.cost) <- c("Group_Number", "Cost")
    
    # > the changing of the columns makes it easier to join with the NOI data below.
    
 # Create Group Number to Group name conversion table ----
    Group <-
      c("FY15 Q4",
        "FY16 Q1",
        "FY16 Q2",
        "FY16 Q3",
        "FY16 Q4",
        "FY17 Q1",
        "FY17 Q2",
        "FY17 Q3",
        "FY17 Q4",
        "FY18 Q1",
        "FY18 Q2",
        "FY18 Q3",
        "FY18 Q4",
        "FY19 Q1")
    
    Group_Number <-
      c(1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14)
    
    Group_Number <- as.integer(Group_Number)
    
    # Data Frame Conversion ----
      Group <- data.frame(Group, Group_Number)
    
     # Join with Existing DF ----
       summary.acq.cost <- 
        left_join(summary.acq.cost, Group, by = "Group_Number") 
    
      
   
```


Minimum IS Date 

```{r}






```






2) Income Statement Combination

   Income statement data is already compiled in the previous markdown by group. The variable containers all begin with the names;
    example: group1.data ; simply replace the group number, in this case "1".
    
   In the markdown below, we will focus our attention on NOI. A filtering for this line item will be applied to the groups mentioned above.

```{r}

# Filter Group Income Statement Data for NOI ----
  group1.data.noi <- 
   group1.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))

  group2.data.noi <- 
   group2.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))

  group3.data.noi <- 
   group3.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))

  group4.data.noi <- 
   group4.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group5.data.noi <- 
   group5.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group6.data.noi <- 
   group6.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group7.data.noi <- 
   group7.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group8.data.noi <- 
   group8.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group9.data.noi <- 
   group9.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group10.data.noi <- 
   group10.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group11.data.noi <- 
   group11.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group12.data.noi <- 
   group12.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group13.data.noi <- 
   group13.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
  group14.data.noi <- 
   group14.data %>% 
    filter(`Line Item` == 'OP_NOI') %>%
     mutate(Cum_NOI = cumsum(Value))
  
```


Combine Data Frames 

```{r}

# Combination of Data Frames ----
  colnames(group1.data.noi)[3] <- "FY15 Q4"
  colnames(group2.data.noi)[3] <- "FY16 Q1"
  colnames(group3.data.noi)[3] <- "FY16 Q2"
  colnames(group4.data.noi)[3] <- "FY16 Q3"
  colnames(group5.data.noi)[3] <- "FY16 Q4"
  colnames(group6.data.noi)[3] <- "FY17 Q1"
  colnames(group7.data.noi)[3] <- "FY17 Q2"
  colnames(group8.data.noi)[3] <- "FY17 Q3"
  colnames(group9.data.noi)[3] <- "FY17 Q4"
  colnames(group10.data.noi)[3] <- "FY18 Q1"
  colnames(group11.data.noi)[3] <- "FY18 Q2"
  colnames(group12.data.noi)[3] <- "FY18 Q3"
  colnames(group13.data.noi)[3] <- "FY18 Q4"
  colnames(group14.data.noi)[3] <- "FY19 Q1"
  
# Creation of single Data Frame ----
  noi.dataframe <- 
    left_join(group1.data.noi,
              group2.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group3.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group4.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group5.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group6.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group7.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group8.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group9.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group10.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group11.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group12.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group13.data.noi[ , c(1,3)], by = "Date") %>%
    left_join(group14.data.noi[ , c(1,3)], by = "Date")
  
# Eliminate Extra Columns on noi data frame ----
  noi.dataframe <- 
    noi.dataframe[ ,-c(8,9)]
    
# Melt NOI data frame ----
  noi.dataframe <-
    melt(noi.dataframe,
         id = c("Date", "Line Item", "FY", "FM", "Quarter", "Month"))
  
# Rename Columns in NOI data frame ----
  colnames(noi.dataframe)[7] <- "Group"
  colnames(noi.dataframe)[8] <- "NOI"
    
```


Graph Quarter Group NOI Data Frame

```{r}

# Plot GGvis NOI ----
  noi.dataframe %>%
  group_by(Group) %>%
  ggvis(~Date, ~NOI) %>%
  layer_lines(stroke = ~Group)


```


Calculate Cash on Cash Return (Annual NOI / Purchase Cost)

```{r}

# Annual NOI Calculation by Group ----
  noi.annual.df <-
  noi.dataframe %>%
  group_by(FY, Group) %>%
  summarise(Annual_NOI = sum(NOI, na.rm = TRUE))


# Total Purchase Cost by Group ---- 
  noi.annual.df <-
  left_join(noi.annual.df, summary.acq.cost, by = "Group")

# Create Annual Return Column
noi.annual.df <- 
  noi.annual.df %>%
    mutate(Annual_Return = (Annual_NOI / Cost))


# Conver FY to Numeric 
  noi.annual.df$FY <- as.numeric(noi.annual.df$FY)
  
# Filter for Return != 0 ----
  noi.annual.df <- 
  noi.annual.df %>%
    filter(Annual_Return != 0)
  

  

```


Plot Data

```{r}

# > Aggregate Data < #

# Fiscal Year Grouping
  noi.annual.combined <- 
  noi.annual.df %>%
  group_by(FY) %>%
  summarise(NOI = sum(Annual_NOI, na.rm = TRUE))

  cost.annual.combined <-
  noi.annual.df %>%
  group_by(FY) %>%
  summarise(Acq_Cost = sum(Cost, na.rm = TRUE))
  
# creation of return data frame ----
  return.df <- 
    left_join(noi.annual.combined, cost.annual.combined, by = "FY")
  
  # Creation of Return Column ----
    return.df <-
    return.df %>%
    mutate(Return = NOI / Acq_Cost)


# ggplot of return and acquisition data
  g.aggregate <-
  return.df %>%
  group_by(FY) %>%
  ggplot(aes(x = FY, y = Return)) +
  geom_bar(stat = "identity") +
    scale_y_continuous(labels = scales::percent) +
    labs(y = "Return (%)") +
    theme_economist()
    
  
 g.aggregate 
 
 
 
 # Return Export to Excel
   write.csv(summary.acq.cost, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Waterfall\\Annual_Cost.csv" )


```


Individual Return by Group

```{r}

# Data Frame to use: noi.annual.df
  g.individual <-
  noi.annual.df %>%
  ggplot(aes(x = FY, y = Annual_Return, fill = Group)) + 
  geom_bar(stat = 'identity', color = "black") +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(name = " ") + 
  labs(title = "AREC New Acquisitions NOI Return", 
       subtitle = "NOI Relative to Total Acquisition Cost",
       y = "Return (%)",
       caption = "Each bar represents a Fiscal Year (FY) Bucket") +
  theme_economist() + 
  theme(legend.text = element_text(size = 8))

  
  g.individual + facet_grid(. ~Group_Number)
  
```


Cumulative NOI By Group

```{r}

# Remove NA from NOI Dataframe ----
  noi.dataframe.complete <- noi.dataframe[!is.na(noi.dataframe$NOI), ]

# > Data Frame to use: noi.dataframe ----
noi.dataframe.complete <- 
  noi.dataframe.complete %>%
  group_by(Group) %>%
  mutate(Cumulative_NOI = cumsum(NOI))
  
# plot cumulative NOI ----
  g.cumnoi <- 
  noi.dataframe.complete %>%
  ggplot(aes(x = Date, y = Cumulative_NOI, color = Group)) +
  geom_line() +
  theme_economist()

```


$1 Growth in New Acquisition Portfolio

```{r}

# Annual Return Calculation ----
noi.annual.df <- 
noi.annual.df %>%
  group_by(Group) %>%
  mutate(Return_Plus_1 = Annual_Return + 1,
         Dollar_Growth = cumprod(Return_Plus_1))


```


```{r}

#> Here, we are using the simple return, not compounding.

# GGplot of $1 Growth
g.dollargrowth <- 
  noi.annual.df %>%
  ggplot(aes(x = FY, y = Dollar_Growth, color = Group, shape = Group)) + 
  geom_line() + 
  theme_economist()

#g.dollargrowth + facet_grid(. ~ Group_Number)

g.dollargrowth

```


Breakout by Fiscal Year


```{r}

g.dollargrowth.f15 <- 
  noi.annual.df %>%
  filter(Group_Number == 1) %>%
  ggplot(aes(x = FY, y = Dollar_Growth, color = Group, shape = Group)) + 
  geom_line() + 
  labs(title = "FY15 Acquisitions Value of $1 Invested",
       y = "Value",
       caption = "Grouped into Fiscal Year (FY) Buckets") +
  theme_economist() +
   scale_y_continuous(labels = scales::dollar) + 
   scale_x_continuous(name = 'Fiscal Year', breaks = seq(2015, 2019, 1))


g.dollargrowth.f15


```


```{r}

g.dollargrowth.f16 <- 
  noi.annual.df %>%
  filter(Group_Number == 2 | Group_Number == 3 | Group_Number == 4 | Group_Number ==5) %>%
  filter(FY >= 2016) %>%
  ggplot(aes(x = FY, y = Dollar_Growth, color = Group, shape = Group)) + 
  geom_line() + 
  theme_economist() + 
    labs(title = "FY16 Acquisitions Value of $1 Invested",
       y = "Value",
       caption = "Grouped into Fiscal Year (FY) Buckets") +
  scale_y_continuous(labels = scales::dollar) + 
    scale_x_continuous(name = 'Fiscal Year', breaks = seq(2016, 2019, 1))

g.dollargrowth.f16


```


```{r}

g.dollargrowth.f17 <- 
  noi.annual.df %>%
  filter(Group_Number == 6 | Group_Number == 7 | Group_Number == 8 | Group_Number == 9) %>%
  filter(FY >= 2017) %>%
  ggplot(aes(x = FY, y = Dollar_Growth, color = Group, shape = Group)) + 
  geom_line() + 
  theme_economist() + 
    labs(title = "FY17 Acquisitions Value of $1 Invested",
       y = "Value",
       caption = "Grouped into Fiscal Year (FY) Buckets") +
   scale_y_continuous(labels = scales::dollar) +
   scale_x_continuous(name = 'Fiscal Year', breaks = seq(2017, 2019, 1))

g.dollargrowth.f17

```



```{r}

g.dollargrowth.f18 <- 
  noi.annual.df %>%
  filter(Group_Number == 10 | Group_Number == 11 | Group_Number == 12 | Group_Number == 13) %>%
  filter(FY >= 2018) %>%
  ggplot(aes(x = FY, y = Dollar_Growth, color = Group, shape = Group)) + 
  geom_line() + 
  theme_economist() + 
    labs(title = "FY18 Acquisitions Value of $1 Invested",
       y = "Value",
       caption = "Grouped into Fiscal Year (FY) Buckets") +
   scale_y_continuous(labels = scales::dollar) +
  scale_x_continuous(name = 'Fiscal Year', breaks = seq(2018, 2019, 1))

g.dollargrowth.f18


```



```{r}


g.dollargrowth.f19 <- 
  noi.annual.df %>%
  filter(Group_Number == 14) %>%
  ggplot(aes(x = FY, y = Dollar_Growth, color = Group, shape = Group)) + 
  geom_line() + 
  theme_economist() + 
    labs(title = "FY19 Acquisitions Value of $1 Invested",
       y = "Value",
       caption = "Grouped into Fiscal Year (FY) Buckets") +
   scale_y_continuous(labels = scales::dollar)

g.dollargrowth.f19


```














IRR Calculation of REA Investments

```{r}

noi.annual.df

write.csv(noi.annual.df, "Z:\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Waterfall\\Waterfall.csv" )

```










