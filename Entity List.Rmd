---
title: "Quarterly Acq Entity List"
author: "Noe Navarro"
date: "October 11, 2018"
output: html_document
---



```{r}

library(rstudioapi)

library(ggplot2)
library(ggvis)
library(ggthemes)

library(purrr)
library(lazyeval)
library(RODBC) # Creates a connection to SQL Database
library(odbc)
library(sqldf) # Allows for the use of SQL language
library(reshape2) #Data Transformation
library(DT)
library(dygraphs)
library(xts)
library(lubridate)
library(reshape2)

library(plyr)
library(dplyr)
library(dbplyr)

library(R2HTML)
library(CenterIS)

library(supclust)

library(jsonlite)
library(RCurl)

library(tidyr)
library(data.table)
library(rlist)
library(testthat)


```



#*Introduction*

This markdown will process the new acquisitions list to be used in our Quarterly Acquisitions Report Process. It will also export a list / details of the centers used within the Quarterly Acquisitions Compilation. 



###**SQL Databases**
```{r}

# MEntity connection ----      
  con.mentity = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "MEntity",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)


# Entity Information ----
  SAP_db <- dplyr::tbl(con.mentity, "MENTITY_SAP")
    SAP_db <- collect(SAP_db)
      SAP_db %>% summarise(n_distinct(MEntity))
      
      
  # DLR01 ----
  dlr01 <- dplyr::tbl(con.mentity, "ENTITY_DLR01")
    dlr01 <- collect(dlr01)

    # Rename Dlr01 Entity column ----
    colnames(dlr01)[4] <- "Entity"
    
    
    
# Real Additions DB ----
  con.rev_real_additions = DBI::dbConnect(odbc::odbc(), 
      Driver = "SQL Server",
      Server = "OPSREPORT02.UHAUL.AMERCO.ORG",
      Database = "RealEstateValuation",
      UID = rstudioapi::askForPassword("Database user"),
      PWD = rstudioapi::askForPassword("Database password"),
      Port = 1433)
    
  real_additions <- 
    dplyr::tbl(con.rev_real_additions, "REV_REAL_ADDITIONS")
  
    real_additions <- collect(real_additions)
    
```



###**New Acquisitions Spreadsheet**

This section will import and format the new acquisitions list from Michael Kobs. 

```{r}

new_properties <- 
  readxl::read_xlsx("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q2\\Properties Jason - August FY19.xlsx",
                   sheet = "Properties FY19",
                   range = "A5:J80",
                   col_names = TRUE)

  # Convert Date column to date format ----
  new_properties$Date <-
    as.Date(new_properties$Date, format = "%m/%d/%Y")

    # Rename Date column ----
    colnames(new_properties)[3] <- "Close of Escrow"
    colnames(new_properties)[4] <- "Purchase"
  
    
```


```{r Create Entity Column }

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}


# Format list ----
new_properties$Entity <- 
  sapply(new_properties$Address, substrRight, n = 8)

  # Replace ( ) with blanks ----
  new_properties$Entity <-
    gsub("\\(", "", new_properties$Entity)

    new_properties$Entity <- 
      gsub("\\)", "", new_properties$Entity)

```


```{r Import Center Information}

# Merge Entity ----
new_properties_2 <-
  left_join(new_properties, dlr01, by = "Entity" )

# grep("MEntity", colnames(dlr01))
dim(new_properties)
dim(new_properties_2)

  # Summarize new_properties_2 ----
  summarize_new_acq <- 
  new_properties_2 %>%
    select(Address, `Close of Escrow`, Owner, Purchase, Entity, MEntity)

```


```{r}

# write.csv(new_properties_2, "Z:\\group\\MIA\\Yusel\\MEntity_Join.csv")

# Determine Unique MEntity Numbers ----
new_properties_2 %>%
  summarise(MEntity_Count = n_distinct(MEntity))


```


##** Unique MEntity Numbers**

With some situations, a new acquisiton may not contain a unique MEntity identifier. The following code attempts to create a single process for Entity list compilation. 

Input: New Acquisiton list from Michael Kobs
Output: List of new Acquistions with Center Descriptions to be fed into Quarterly acquisitions dashboard.
  
  The current acquisitions dashboard process only uses profit center numbers to begin compilation. Any layout chosen will work fine as long as it contains   profit center numbers. 
  
---
Columns of Interest 
---

3 - Close of Escrow

```{r Acquisitions List Layout}

# Columns of Interest ----
center_list <-
  new_properties_2 %>%
  select(Entity, MEntity, ENTITY_NAME, ENTITY_TYPE, `Close of Escrow`, Purchase, Owner, DATE_OPENED, DATE_CLOSED, STATUS, MAIL_STREET1, MAIL_CITY, MAIL_STATE, MAIL_ZIP)


  # Import Profit Center from SAP Hierarchy Table ----
  center_list <-
    left_join(center_list, SAP_db[ , 2:3], by = "MEntity")


  # Import Center Description (Existing, Conversion, etc.)
  center_list <-
    left_join(center_list, real_additions[ , c(2,3,4,5, 7:10)], by = c("MEntity", "Entity"))

```



##**Filtering of Acquisitions List** 

The following code chunk will filter out any incorrect merging. This is a manual check to ensure our list is accurate 

```{r}

# Filter MEntity == NA ----
center_list <-
  center_list %>%
    filter(!is.na(center_list$MEntity))

  # Group by MEntity ----
  center_list %>% 
    group_by(MEntity) %>%
    summarise(Count = n()) %>%
    arrange(desc(Count))

  # 


```

##** Duplicate MEntity Numbers **

1) M0000024619 ; Run Remote / Abutting
   1st Entity: 754034 (run remote from 754078). All Op Exp from 754034 are being charged to the remote location (754078). 
   
   Databases show 754078 as being run remote too. 
   
   It appears both should be excluded from the analysis.

2) M0000031767 ; Entity returns acquisition in 2013. Check against IS Start date.
3) M0000109346 ; Eliminate second entry.
4) M0000136236 ; Acquired in phases - Eliminate a duplicate
5) M0000136747 ; Contains an entry with different Purchase Price. Eliminate the duplicate
6) M0000138316 ; Contains an entry with different Purchase Price. Eliminate the duplicate


```{r}

# Eliminate 1 ----
center_list <- 
  center_list %>%
  filter(MEntity != 'M0000024619')

# Eliminate duplicates ----
unique_mentity <- 
  center_list[!duplicated(center_list$MEntity), ]

unique_mentity$Include <- " "

# Inclusion Column ----

        for (i in 1:length(unique_mentity$MEntity)){
          
          if (grepl("?butting", unique_mentity$Property_Type[i]) == TRUE){
            
            unique_mentity$Include[i] = 'No'
            
          } else if (grepl("?emote", unique_mentity$Property_Type[i]) == TRUE){
            
            unique_mentity$Include[i] = "No"
            
            
          } else if (grepl("SAC", unique_mentity$Owner[i])){
            
          
            unique_mentity$Include[i] = "No"
            
          } else {
            
            unique_mentity$Include[i] = "Yes"
        
          }
          
        }


```


```{r Filter properties that will return}


unique_mentity %>%
  filter(Include == 'Yes')

```




---
##** Completed Acquisitions Spreadsheet Import & Check **
---

```{r}

c_acquisitions <- 
  read.csv("\\\\adfs01.uhi.amerco\\departments\\mia\\group\\MIA\\Noe\\Projects\\Same Store & Cap Ex\\Report\\Quarterly Acquisitions\\F19 Q1\\Completed_Acquisitions20180725.csv", header = TRUE)

c_acquisitions$Permanent.Entity.. <- as.character(c_acquisitions$Permanent.Entity..)


# completed completed acquisitions tbl conversion ----
c_acquisitions <- 
  as.tbl(c_acquisitions)

c_acquisitions_include <- 
  c_acquisitions %>% 
  filter(Include. == 'Yes')
      
c_acquisitions_exclude <- 
  c_acquisitions %>% 
  filter(Include. == 'No')


# ----------------------------------------------------------------------------------------------------------------------------

  # Check whether NA Profit center values were updated ----
  #na_profitcenter_include <- 
   # c_acquisitions_include %>%
    #filter(is.na(Profit_Center))

  # Merge profit centers ----
  #colnames(na_profitcenter_include)[8] <- "Entity"
  #na_profitcenter_include$Entity <- as.character(na_profitcenter_include$Entity)
  
  #na_profitcenter_include <- 
    #left_join(na_profitcenter_include, dlr01[ ,c(4, 103)], by = "Entity")
  
    #na_profitcenter_include <- 
      l#eft_join(na_profitcenter_include, SAP_db[ , c(2:3)], by = "MEntity")
    
    # In this step, we have previously exported all those entities that did not contain Profit Centers 
    
  
```



```{r}

# Filter Entity that is now closed ----
c_acquisitions_include <-
  c_acquisitions_include %>%
    filter(Permanent.Entity.. != "887001")

```


###** Trend IS Start Check**

The following section will check the Income Statement Start date of each profit center for comparison against the close of escrow date. 

```{r}






```














